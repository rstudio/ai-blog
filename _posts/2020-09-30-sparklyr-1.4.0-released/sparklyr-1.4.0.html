<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
  <title>sparklyr 1.4: Weighted Sampling, Tidyr Verbs, Robust Scaler, RAPIDS, and more</title>
  
  <meta property="description" itemprop="description" content="Sparklyr 1.4 is now available! This release comes with delightful new features such as weighted sampling and tidyr verbs support for Spark dataframes, robust scaler for standardizing data based on median and interquartile range, spark_connect interface for RAPIDS GPU acceleration plugin, as well as a number of dplyr-related improvements."/>
  
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2020-09-30"/>
  <meta property="article:created" itemprop="dateCreated" content="2020-09-30"/>
  <meta name="article:author" content="Yitao Li"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="sparklyr 1.4: Weighted Sampling, Tidyr Verbs, Robust Scaler, RAPIDS, and more"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Sparklyr 1.4 is now available! This release comes with delightful new features such as weighted sampling and tidyr verbs support for Spark dataframes, robust scaler for standardizing data based on median and interquartile range, spark_connect interface for RAPIDS GPU acceleration plugin, as well as a number of dplyr-related improvements."/>
  <meta property="og:locale" content="en_US"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="sparklyr 1.4: Weighted Sampling, Tidyr Verbs, Robust Scaler, RAPIDS, and more"/>
  <meta property="twitter:description" content="Sparklyr 1.4 is now available! This release comes with delightful new features such as weighted sampling and tidyr verbs support for Spark dataframes, robust scaler for standardizing data based on median and interquartile range, spark_connect interface for RAPIDS GPU acceleration plugin, as well as a number of dplyr-related improvements."/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","slug","date","categories","output","preview"]}},"value":[{"type":"character","attributes":{},"value":["sparklyr 1.4: Weighted Sampling, Tidyr Verbs, Robust Scaler, RAPIDS, and more"]},{"type":"character","attributes":{},"value":["Sparklyr 1.4 is now available! This release comes with delightful new features such as weighted sampling and tidyr verbs support for Spark dataframes, robust scaler for standardizing data based on median and interquartile range, spark_connect interface for RAPIDS GPU acceleration plugin, as well as a number of dplyr-related improvements.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Yitao Li"]},{"type":"character","attributes":{},"value":["https://github.com/yitao-li"]},{"type":"character","attributes":{},"value":["RStudio"]},{"type":"character","attributes":{},"value":["https://www.rstudio.com"]}]}]},{"type":"character","attributes":{},"value":["sparklyr-1.4"]},{"type":"character","attributes":{},"value":["09-30-2020"]},{"type":"character","attributes":{},"value":["R","Packages/Releases","Distributed Computing"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["images/sparklyr-1.4.png"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["images/scaled.png","images/skewed.png","images/sparklyr-1.4.png","sparklyr-1.4.0_files/bowser-1.9.3/bowser.min.js","sparklyr-1.4.0_files/distill-2.2.21/template.v2.js","sparklyr-1.4.0_files/jquery-1.11.3/jquery.min.js","sparklyr-1.4.0_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for table of contents */
  
  .d-toc {
    color: rgba(0,0,0,0.8);
    font-size: 0.8em;
    line-height: 1em;
  }
  
  .d-toc-header {
    font-size: 0.6rem;
    font-weight: 400;
    color: rgba(0, 0, 0, 0.5);
    text-transform: uppercase;
    margin-top: 0;
    margin-bottom: 1.3em;
  }
  
  .d-toc a {
    border-bottom: none;
  }
  
  .d-toc ul {
    padding-left: 0;
  }
  
  .d-toc li>ul {
    padding-top: 0.8em;
    padding-left: 16px;
    margin-bottom: 0.6em;
  }
  
  .d-toc ul,
  .d-toc li {
    list-style-type: none;
  }
  
  .d-toc li {
    margin-bottom: 0.9em;
  }
  
  .d-toc-separator {
    margin-top: 20px;
    margin-bottom: 2em;
  }
  
  .d-article-with-toc {
    border-top: none;
    padding-top: 0;
  }
  
  
  
  /* Tweak code blocks (note that this CSS is repeated above in an injection
     into the d-code shadow dom) */
  
  d-code {
    overflow-x: auto !important;
  }
  
  pre.d-code code.d-code {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  pre.text-output {
  
    font-size: 12px;
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  @media(min-width: 768px) {
  
  d-code {
    overflow-x: visible !important;
  }
  
  pre.d-code code.d-code  {
      padding-left: 18px;
      font-size: 14px;
  }
  pre.text-output {
    font-size: 14px;
  }
  }
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .custom p {
    margin-bottom: 0.5em;
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // create d-bibliography
    var bibliography = $('<d-bibliography></d-bibliography>');
    $('#distill-bibliography').wrap(bibliography);
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace citations with <d-cite>
    $('.citation').each(function(i, val) {
      appendix = true;
      var cites = $(this).attr('data-cites').split(" ");
      var dt_cite = $('<d-cite></d-cite>');
      dt_cite.attr('key', cites.join());
      $(this).replaceWith(dt_cite);
    });
    // remove refs
    $('#refs').remove();
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-toc a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // replace code blocks with d-code
    $('pre>code').each(function(i, val) {
      var code = $(this);
      var pre = code.parent();
      var clz = "";
      var language = pre.attr('class');
      if (language) {
        // map unknown languages to "clike" (without this they just dissapear)
        if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                                 "javascript", "js", "julia", "lua", "markdown",
                                 "markup", "mathml", "python", "svg", "xml"]) == -1)
          language = "clike";
        language = ' language="' + language + '"';
        var dt_code = $('<d-code block' + language + clz + '></d-code>');
        dt_code.text(code.text());
        pre.replaceWith(dt_code);
      } else {
        code.addClass('text-output').unwrap().changeElementType('pre');
      }
    });
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('d-code, pre.text-output, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // table of contents
      if (have_authors) // adjust border if we are in authors
        $('.d-toc').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
      $('d-code').each(function(i, val) {
        var style = document.createElement('style');
        style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                          '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
        if (this.shadowRoot)
          this.shadowRoot.appendChild(style);
      });
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-toc-header').remove();
    $('.d-toc').remove();
    $('.d-toc-separator').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="sparklyr-1.4.0_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="sparklyr-1.4.0_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="sparklyr-1.4.0_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="sparklyr-1.4.0_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"sparklyr 1.4: Weighted Sampling, Tidyr Verbs, Robust Scaler, RAPIDS, and more","description":"Sparklyr 1.4 is now available! This release comes with delightful new features such as weighted sampling and tidyr verbs support for Spark dataframes, robust scaler for standardizing data based on median and interquartile range, spark_connect interface for RAPIDS GPU acceleration plugin, as well as a number of dplyr-related improvements.","authors":[{"author":"Yitao Li","authorURL":"https://github.com/yitao-li","affiliation":"RStudio","affiliationURL":"https://www.rstudio.com"}],"publishedDate":"2020-09-30T00:00:00.000+00:00","citationText":"Li, 2020"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>sparklyr 1.4: Weighted Sampling, Tidyr Verbs, Robust Scaler, RAPIDS, and more</h1>
<p>Sparklyr 1.4 is now available! This release comes with delightful new features such as weighted sampling and tidyr verbs support for Spark dataframes, robust scaler for standardizing data based on median and interquartile range, spark_connect interface for RAPIDS GPU acceleration plugin, as well as a number of dplyr-related improvements.</p>
</div>

<div class="d-byline">
  Yitao Li <a href="https://github.com/yitao-li" class="uri">https://github.com/yitao-li</a> (RStudio)<a href="https://www.rstudio.com" class="uri">https://www.rstudio.com</a>
  
<br/>09-30-2020
</div>

<div class="d-article">
<p><a href="https://sparklyr.ai"><code>sparklyr</code></a> 1.4 is now available on <a href="https://cran.r-project.org/web/packages/sparklyr/index.html">CRAN</a>! To install <code>sparklyr</code> 1.4 from CRAN, run</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
install.packages(&quot;sparklyr&quot;)</code></pre>
</div>
<p>In this blog post, we will showcase the following much anticipated new functionalities from the <code>sparklyr</code> 1.4 release:</p>
<ul>
<li><a href="#parallelized-weighted-sampling">Parallelized Weighted Sampling</a> with Spark</li>
<li>Support for <a href="#tidyr-verbs">Tidyr Verbs</a> on Spark Dataframes</li>
<li><a href="#robust-scaler"><code>ft_robust_scaler</code></a> as the R interface for <a href="https://spark.apache.org/docs/3.0.0/api/java/org/apache/spark/ml/feature/RobustScaler.html">RobustScaler</a> from Spark 3.0</li>
<li>Option for enabling <a href="#rapids"><code>RAPIDS</code></a> GPU acceleration plugin in <code>spark_connect()</code></li>
<li><a href="#higher-order-functions-and-dplyr-related-improvements">Higher-order functions and <code>dplyr</code>-related improvements</a></li>
</ul>
<h2 id="parallelized-weighted-sampling">Parallelized Weighted Sampling</h2>
<p>Readers familiar with <code>dplyr::sample_n()</code> and <code>dplyr::sample_frac()</code> functions may have noticed both of them support weighted-sampling use cases on R dataframes, e.g.,</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
dplyr::sample_n(mtcars, size = 3, weight = mpg, replace = FALSE)</code></pre>
</div>
<pre><code>
               mpg cyl  disp  hp drat    wt  qsec vs am gear carb
Fiat 128      32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
Merc 280C     17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
Mazda RX4 Wag 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4</code></pre>
<p>and</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
dplyr::sample_frac(mtcars, size = 0.1, weight = mpg, replace = FALSE)</code></pre>
</div>
<pre><code>
             mpg cyl  disp  hp drat    wt  qsec vs am gear carb
Honda Civic 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
Merc 450SE  16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
Fiat X1-9   27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1</code></pre>
<p>will select some random subset of <code>mtcars</code> using the <code>mpg</code> attribute as the sampling weight for each row. If <code>replace = FALSE</code> is set, then a row is removed from the sampling population once it gets selected, whereas when setting <code>replace = TRUE</code>, each row will always stay in the sampling population and can be selected multiple times.</p>
<p>Now the exact same use cases are supported for Spark dataframes in <code>sparklyr</code> 1.4! For example:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(sparklyr)

sc &lt;- spark_connect(master = &quot;local&quot;)
mtcars_sdf &lt;- copy_to(sc, mtcars, repartition = 4L)

dplyr::sample_n(mtcars_sdf, size = 5, weight = mpg, replace = FALSE)</code></pre>
</div>
<p>will return a random subset of size 5 from the Spark dataframe <code>mtcars_sdf</code>.</p>
<p>More importantly, the sampling algorithm being implemented in <code>sparklyr</code> 1.4 is something that fits perfectly into the MapReduce paradigm: as we have split our <code>mtcars</code> data into 4 partitions of <code>mtcars_sdf</code> by specifying <code>repartition = 4L</code>, the algorithm will first process each partition independently and in parallel, selecting a sample set of size up to 5 from each, and then reduce all 4 sample sets into a final sample set of size 5 by choosing records having the top 5 highest sampling priorities among all.</p>
<p>How is such parallelization possible, especially for the sampling without replacement scenario, where the desired result is defined as the outcome of a sequential process? A detailed answer to this question is in <a href="https://blogs.rstudio.com/ai/posts/2020-07-29-parallelized-sampling/">this blog post</a>, which includes a definition of the problem (in particular, the exact meaning of sampling weights in term of probabilities), a high-level explanation of the current solution and the motivation behind it, and also, some mathematical details all hidden in one link to a PDF file, so that non-math-oriented readers can get the gist of everything else without getting scared away, while math-oriented readers enjoy working out all the integrals themselves before peeking at the answer.</p>
<h2 id="tidyr-verbs">Tidyr Verbs</h2>
<p>The specialized implementations of the following <a href="https://tidyr.tidyverse.org/"><code>tidyr</code></a> verbs that work efficiently with Spark dataframes were included as part of <code>sparklyr</code> 1.4:</p>
<ul>
<li><code>tidyr::fill</code></li>
<li><code>tidyr::nest</code></li>
<li><code>tidyr::unnest</code></li>
<li><code>tidyr::pivot_wider</code></li>
<li><code>tidyr::pivot_longer</code></li>
<li><code>tidyr::separate</code></li>
<li><code>tidyr::unite</code></li>
</ul>
<p>We can demonstrate how those verbs are useful for tidying data through some examples.</p>
<p>Let’s say we are given <code>mtcars_sdf</code>, a Spark dataframe containing all rows from <code>mtcars</code> plus the name of each row:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(sparklyr)

sc &lt;- spark_connect(master = &quot;local&quot;)
mtcars_sdf &lt;- cbind(
  data.frame(model = rownames(mtcars)),
  data.frame(mtcars, row.names = NULL)
) %&gt;%
  copy_to(sc, ., repartition = 4L)

print(mtcars_sdf, n = 5)</code></pre>
</div>
<pre><code>
# Source: spark&lt;?&gt; [?? x 12]
  model          mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Mazda RX4     21       6   160   110  3.9   2.62  16.5     0     1     4     4
2 Mazda RX4 W…  21       6   160   110  3.9   2.88  17.0     0     1     4     4
3 Datsun 710    22.8     4   108    93  3.85  2.32  18.6     1     1     4     1
4 Hornet 4 Dr…  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1
5 Hornet Spor…  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2
# … with more rows</code></pre>
<p>and we would like to turn all numeric attributes in <code>mtcar_sdf</code> (in other words, all columns other than the <code>model</code> column) into key-value pairs stored in 2 columns, with the <code>key</code> column storing the name of each attribute, and the <code>value</code> column storing each attribute’s numeric value. One way to accomplish that with <code>tidyr</code> is by utilizing the <code>tidyr::pivot_longer</code> functionality:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mtcars_kv_sdf &lt;- mtcars_sdf %&gt;%
  tidyr::pivot_longer(cols = -model, names_to = &quot;key&quot;, values_to = &quot;value&quot;)
print(mtcars_kv_sdf, n = 5)</code></pre>
</div>
<pre><code>
# Source: spark&lt;?&gt; [?? x 3]
  model     key   value
  &lt;chr&gt;     &lt;chr&gt; &lt;dbl&gt;
1 Mazda RX4 am      1
2 Mazda RX4 carb    4
3 Mazda RX4 cyl     6
4 Mazda RX4 disp  160
5 Mazda RX4 drat    3.9
# … with more rows</code></pre>
<p>To undo the effect of <code>tidyr::pivot_longer</code>, we can apply <code>tidyr::pivot_wider</code> to our <code>mtcars_kv_sdf</code> Spark dataframe, and get back the original data that was present in <code>mtcars_sdf</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
tbl &lt;- mtcars_kv_sdf %&gt;%
  tidyr::pivot_wider(names_from = key, values_from = value)
print(tbl, n = 5)</code></pre>
</div>
<pre><code>
# Source: spark&lt;?&gt; [?? x 12]
  model         carb   cyl  drat    hp   mpg    vs    wt    am  disp  gear  qsec
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Mazda RX4        4     6  3.9    110  21       0  2.62     1  160      4  16.5
2 Hornet 4 Dr…     1     6  3.08   110  21.4     1  3.22     0  258      3  19.4
3 Hornet Spor…     2     8  3.15   175  18.7     0  3.44     0  360      3  17.0
4 Merc 280C        4     6  3.92   123  17.8     1  3.44     0  168.     4  18.9
5 Merc 450SLC      3     8  3.07   180  15.2     0  3.78     0  276.     3  18
# … with more rows</code></pre>
<p>Another way to reduce many columns into fewer ones is by using <code>tidyr::nest</code> to move some columns into nested tables. For instance, we can create a nested table <code>perf</code> encapsulating all performance-related attributes from <code>mtcars</code> (namely, <code>hp</code>, <code>mpg</code>, <code>disp</code>, and <code>qsec</code>). However, unlike R dataframes, Spark Dataframes do not have the concept of nested tables, and the closest to nested tables we can get is a <code>perf</code> column containing named structs with <code>hp</code>, <code>mpg</code>, <code>disp</code>, and <code>qsec</code> attributes:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mtcars_nested_sdf &lt;- mtcars_sdf %&gt;%
  tidyr::nest(perf = c(hp, mpg, disp, qsec))</code></pre>
</div>
<p>We can then inspect the type of <code>perf</code> column in <code>mtcars_nested_sdf</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
sdf_schema(mtcars_nested_sdf)$perf$type</code></pre>
</div>
<pre><code>
[1] &quot;ArrayType(StructType(StructField(hp,DoubleType,true), StructField(mpg,DoubleType,true), StructField(disp,DoubleType,true), StructField(qsec,DoubleType,true)),true)&quot;</code></pre>
<p>and inspect individual struct elements within <code>perf</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
perf &lt;- mtcars_nested_sdf %&gt;% dplyr::pull(perf)
unlist(perf[[1]])</code></pre>
</div>
<pre><code>
    hp    mpg   disp   qsec
110.00  21.00 160.00  16.46</code></pre>
<p>Finally, we can also use <code>tidyr::unnest</code> to undo the effects of <code>tidyr::nest</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mtcars_unnested_sdf &lt;- mtcars_nested_sdf %&gt;%
  tidyr::unnest(col = perf)
print(mtcars_unnested_sdf, n = 5)</code></pre>
</div>
<pre><code>
# Source: spark&lt;?&gt; [?? x 12]
  model          cyl  drat    wt    vs    am  gear  carb    hp   mpg  disp  qsec
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Mazda RX4        6  3.9   2.62     0     1     4     4   110  21    160   16.5
2 Hornet 4 Dr…     6  3.08  3.22     1     0     3     1   110  21.4  258   19.4
3 Duster 360       8  3.21  3.57     0     0     3     4   245  14.3  360   15.8
4 Merc 280         6  3.92  3.44     1     0     4     4   123  19.2  168.  18.3
5 Lincoln Con…     8  3     5.42     0     0     3     4   215  10.4  460   17.8
# … with more rows</code></pre>
<h2 id="robust-scaler">Robust Scaler</h2>
<p><a href="https://spark.apache.org/docs/3.0.0/api/java/org/apache/spark/ml/feature/RobustScaler.html">RobustScaler</a> is a new functionality introduced in Spark 3.0 (<a href="https://issues.apache.org/jira/browse/SPARK-28399">SPARK-28399</a>). Thanks to a <a href="https://github.com/sparklyr/sparklyr/pull/2254">pull request</a> by <a href="https://github.com/zero323">@zero323</a>, an R interface for <code>RobustScaler</code>, namely, the <code>ft_robust_scaler()</code> function, is now part of <code>sparklyr</code>.</p>
<p>It is often observed that many machine learning algorithms perform better on numeric inputs that are standardized. Many of us have learned in stats 101 that given a random variable <span class="math inline">\(X\)</span>, we can compute its mean <span class="math inline">\(\mu = E[X]\)</span>, standard deviation <span class="math inline">\(\sigma = \sqrt{E[X^2] - (E[X])^2}\)</span>, and then obtain a standard score <span class="math inline">\(z = \frac{X - \mu}{\sigma}\)</span> which has mean of 0 and standard deviation of 1.</p>
<p>However, notice both <span class="math inline">\(E[X]\)</span> and <span class="math inline">\(E[X^2]\)</span> from above are quantities that can be easily skewed by extreme outliers in <span class="math inline">\(X\)</span>, causing distortions in <span class="math inline">\(z\)</span>.</p>
<p>An alternative way of standardizing <span class="math inline">\(X\)</span> based on its median, 1st quartile, and 3rd quartile values, all of which are robust against outliers, would be the following:</p>
<p><span class="math inline">\(\displaystyle z = \frac{X - \text{Median}(X)}{\text{P75}(X) - \text{P25}(X)}\)</span></p>
<p>and this is precisely what <a href="https://spark.apache.org/docs/3.0.0/api/java/org/apache/spark/ml/feature/RobustScaler.html">RobustScaler</a> offers.</p>
<p>To see <code>ft_robust_scaler()</code> in action and demonstrate its usefulness, we can go through a contrived example consisting of the following steps:</p>
<ul>
<li>Draw 100 random samples from the standard normal distribution</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
sample_values &lt;- rnorm(100)
print(sample_values)</code></pre>
</div>
<pre><code>
  [1] -0.885440337  0.831855863 -0.890427366  0.437780168  0.091902152
  [6]  0.774895164 -0.839350781 -1.173025189 -0.442174680 -0.002573251
  ...</code></pre>
<ul>
<li>Inspect the minimal and maximal values among the 100 random samples:</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
print(min(sample_values))</code></pre>
</div>
<pre><code>
  [1] -2.377851</code></pre>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
print(max(sample_values))</code></pre>
</div>
<pre><code>
  [1] 2.629998</code></pre>
<ul>
<li>Now create 5 other values that are extreme outliers compared to the 100 random samples above. Given that we know all 100 samples are within the range of <span class="math inline">\((-3, 3)\)</span>, we can choose <span class="math inline">\(21, 22, \ldots, 25\)</span> as our outliers:</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
outliers &lt;- 20 + seq(5)</code></pre>
</div>
<ul>
<li>Copy all 105 values into a Spark dataframe named <code>sdf</code></li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(sparklyr)

sc &lt;- spark_connect(master = &quot;local&quot;, version = &quot;3.0.0&quot;)
sdf &lt;- copy_to(sc, data.frame(value = c(sample_values, outliers)))</code></pre>
</div>
<ul>
<li>We can then apply <code>ft_robust_scaler()</code> to obtain the standardized value for each input:</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
scaled &lt;- sdf %&gt;%
  ft_vector_assembler(&quot;value&quot;, &quot;input&quot;) %&gt;%
  ft_robust_scaler(&quot;input&quot;, &quot;scaled&quot;) %&gt;%
  dplyr::pull(scaled) %&gt;%
  unlist()</code></pre>
</div>
<ul>
<li>Plotting the result shows the non-outlier data points are scaled to values that still more or less form a bell-shaped distribution, as expected, so the scaling is robust against influences of the outliers:</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(ggplot2)

ggplot(data.frame(scaled = scaled), aes(x = scaled)) + geom_histogram(binwidth = 0.2)</code></pre>
</div>
<p><img src="images/scaled.png" id="id" class="class" style="width:40.0%;height:40.0%" /></p>
<ul>
<li>Finally, we can compare the distribution of the scaled values above with the distribution of z-scores of all input values, and notice how scaling the input with only mean and standard deviation would have caused noticeable skewness which the robust scaler has successfully avoided:</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
all_values &lt;- c(sample_values, outliers)
z_scores &lt;- (all_values - mean(all_values)) / sd(all_values)
ggplot(data.frame(scaled = z_scores), aes(x = scaled)) + geom_histogram(binwidth = 0.2)</code></pre>
</div>
<p><img src="images/skewed.png" id="id" class="class" style="width:40.0%;height:40.0%" /></p>
<h2 id="rapids">RAPIDS</h2>
<p>Readers following Apache Spark releases closely probably have noticed the recent addition of <a href="https://rapids.ai/">RAPIDS</a> GPU acceleration support in Spark 3.0. Catching up with this recent development, an option to enable RAPIDS in Spark connections was also created in <code>sparklyr</code> and shipped in <code>sparklyr</code> 1.4. On a host with RAPIDS-capable hardware (e.g., an Amazon EC2 instance of type ‘p3.2xlarge’), one can install <code>sparklyr</code> 1.4 and observe RAPIDS hardware acceleration being reflected in Spark SQL physical query plans:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(sparklyr)

sc &lt;- spark_connect(master = &quot;local&quot;, version = &quot;3.0.0&quot;, packages = &quot;rapids&quot;)
dplyr::db_explain(sc, &quot;SELECT 4&quot;)</code></pre>
</div>
<pre><code>
== Physical Plan ==
*(2) GpuColumnarToRow false
+- GpuProject [4 AS 4#45]
   +- GpuRowToColumnar TargetSize(2147483647)
      +- *(1) Scan OneRowRelation[]</code></pre>
<h2 id="higher-order-functions-and-dplyr-related-improvements">Higher-Order Functions and <code>dplyr</code>-Related Improvements</h2>
<p>All newly introduced higher-order functions from Spark 3.0, such as <code>array_sort()</code> with custom comparator, <code>transform_keys()</code>, <code>transform_values()</code>, and <code>map_zip_with()</code>, are supported by <code>sparklyr</code> 1.4.</p>
<p>In addition, all higher-order functions can now be accessed directly through <code>dplyr</code> rather than their <code>hof_*</code> counterparts in <code>sparklyr</code>, which means, for example, we can run the following <code>dplyr</code> queries to calculate the square of all array elements in column <code>x</code> of <code>sdf</code> and then sort them in descending order:</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(sparklyr)

sc &lt;- spark_connect(master = &quot;local&quot;, version = &quot;3.0.0&quot;)
sdf &lt;- copy_to(sc, tibble::tibble(x = list(c(-3, -2, 1, 5), c(6, -7, 5, 8))))

sq_desc &lt;- sdf %&gt;%
  dplyr::mutate(x = transform(x, ~ .x * .x)) %&gt;%
  dplyr::mutate(x = array_sort(x, ~ as.integer(sign(.y - .x)))) %&gt;%
  dplyr::pull(x)

print(sq_desc)</code></pre>
</div>
<pre><code>
[[1]]
[1] 25  9  4  1

[[2]]
[1] 64 49 36 25</code></pre>
<h2 id="acknowledgement">Acknowledgement</h2>
<p>In chronological order, we would like to thank the following individuals for their contribution towards <code>sparklyr</code> 1.4:</p>
<ul>
<li><a href="https:://github.com/javierluraschi">@javierluraschi</a></li>
<li><a href="https:://github.com/nealrichardson">@nealrichardson</a></li>
<li><a href="https:://github.com/yitao-li">@yitao-li</a></li>
<li><a href="https:://github.com/wkdavis">@wkdavis</a></li>
<li><a href="https:://github.com/Loquats">@Loquats</a></li>
<li><a href="https:://github.com/zero323">@zero323</a></li>
</ul>
<p>We also appreciate bug reports, feature requests, and valuable other feedback about <code>sparklyr</code> from our awesome open-source community (e.g., the weighted sampling feature in <code>sparklyr</code> 1.4 was largely motivated by this <a href="https://github.com/sparklyr/sparklyr/issues/2592">Github issue</a> filed by <a href="https://github.com/ajing">@ajing</a>, and some <code>dplyr</code>-related bug fixes shipped in this release was initiated in <a href="https://github.com/sparklyr/sparklyr/issues/2648">#2648</a> and completed with this <a href="https://github.com/sparklyr/sparklyr/pull/2651">pull request</a> by <a href="https:://github.com/wkdavis">@wkdavis</a>).</p>
<p>Last but not least, the author of this blog post is extremely grateful for fantastic editorial suggestions from <a href="https:://github.com/javierluraschi">@javierluraschi</a>, <a href="https://github.com/batpigandme">@batpigandme</a>, and <a href="https://github.com/skeydan">@skeydan</a>.</p>
<p>If you wish to learn more about <code>sparklyr</code>, we recommend checking out <a href="https://sparklyr.ai">sparklyr.ai</a>, <a href="https://spark.rstudio.com">spark.rstudio.com</a>, and also some of the previous release posts such as <a href="https://blog.rstudio.com/2020/07/16/sparklyr-1-3/">sparklyr 1.3</a> and <a href="https://blogs.rstudio.com/ai/posts/2020-04-21-sparklyr-1.2.0-released/">sparklyr 1.2</a>.</p>
<p>Thanks for reading!</p>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
