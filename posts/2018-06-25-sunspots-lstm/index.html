<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #20794d; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007ba5; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #007ba5; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #007ba5; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #20794d; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
<title>RStudio AI Blog: Predicting Sunspot Frequency with Keras</title>

<meta property="description" itemprop="description" content="In this post we will examine making time series predictions using the sunspots dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Our post will focus on both how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain."/>

<link rel="canonical" href="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/"/>
<link rel="icon" type="image/png" href="../../images/favicon.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2018-06-25"/>
<meta property="article:created" itemprop="dateCreated" content="2018-06-25"/>
<meta name="article:author" content="Matt Dancho"/>
<meta name="article:author" content="Sigrid Keydana"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="RStudio AI Blog: Predicting Sunspot Frequency with Keras"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="In this post we will examine making time series predictions using the sunspots dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Our post will focus on both how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain."/>
<meta property="og:url" content="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/"/>
<meta property="og:image" content="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/images/backtested_test.png"/>
<meta property="og:image:width" content="800"/>
<meta property="og:image:height" content="416"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="RStudio AI Blog"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="RStudio AI Blog: Predicting Sunspot Frequency with Keras"/>
<meta property="twitter:description" content="In this post we will examine making time series predictions using the sunspots dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Our post will focus on both how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain."/>
<meta property="twitter:url" content="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/"/>
<meta property="twitter:image" content="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/images/backtested_test.png"/>
<meta property="twitter:image:width" content="800"/>
<meta property="twitter:image:height" content="416"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="RStudio AI Blog: Predicting Sunspot Frequency with Keras"/>
<meta name="citation_fulltext_html_url" content="https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/"/>
<meta name="citation_online_date" content="2018/06/25"/>
<meta name="citation_publication_date" content="2018/06/25"/>
<meta name="citation_author" content="Matt Dancho"/>
<meta name="citation_author_institution" content="Business Science"/>
<meta name="citation_author" content="Sigrid Keydana"/>
<meta name="citation_author_institution" content="RStudio"/>
<!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","creative_commons","preview","categories","output","citation_url","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["Predicting Sunspot Frequency with Keras"]},{"type":"character","attributes":{},"value":["In this post we will examine making time series predictions using the sunspots dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Our post will focus on both how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain."]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Matt Dancho"]},{"type":"character","attributes":{},"value":["https://github.com/mdancho84"]},{"type":"character","attributes":{},"value":["Business Science"]},{"type":"character","attributes":{},"value":["https://www.business-science.io/"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Sigrid Keydana"]},{"type":"character","attributes":{},"value":["https://github.com/skeydan"]},{"type":"character","attributes":{},"value":["RStudio"]},{"type":"character","attributes":{},"value":["https://www.rstudio.com"]}]}]},{"type":"character","attributes":{},"value":["2018-06-25"]},{"type":"NULL"},{"type":"character","attributes":{},"value":["images/backtested_test.png"]},{"type":"character","attributes":{},"value":["TensorFlow/Keras","Time Series"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/"]},{"type":"character","attributes":{},"value":["https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["images/all_splits_zoomed.png","images/all_splits.png","images/backtested_test.png","images/backtested_train.png","images/cowplot.png","images/history.png","images/pred_test.png","images/pred_train.png","images/rnn.png","images/slice1.png","images/slice6.png","images/sunspot_nasa.jpg","images/sunspots_full.png","sunspots-lstm_files/bowser-1.9.3/bowser.min.js","sunspots-lstm_files/distill-2.2.21/template.v2.js","sunspots-lstm_files/jquery-1.11.3/jquery.min.js","sunspots-lstm_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      tolerance: 5,
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

/* adjust viewport for navbar height */
/* helps vertically center bootstrap (non-distill) content */
.min-vh-100 {
  min-height: calc(100vh - 100px) !important;
}

</style>

<script src="../../site_libs/jquery-1.11.3/jquery.min.js"></script>
<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createFuseIndex() {

  // create fuse index
  var options = {
    keys: [
      { name: 'title', weight: 20 },
      { name: 'categories', weight: 15 },
      { name: 'description', weight: 10 },
      { name: 'contents', weight: 5 },
    ],
    ignoreLocation: true,
    threshold: 0
  };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
              ? `<img src="${offsetURL(suggestion.preview)}"</img>`
              : '';
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description || ''}
                </div>
                <div class="search-item-preview">
                  ${img}
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

.nav-search {
  font-size: x-small;
}

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  font-size: 1rem;
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: auto;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

d-article details {
  grid-column: text;
  margin-bottom: 0.8em;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure img {
  width: 100%;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}

/* Citation hover box */

.tippy-box[data-theme~=light-border] {
  background-color: rgba(250, 250, 250, 0.95);
}

.tippy-content > p {
  margin-bottom: 0;
  padding: 2px;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('details, div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // hoverable references
    $('span.citation[data-cites]').each(function() {
      var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
      window.tippy(this, {
        allowHTML: true,
        content: refHtml,
        maxWidth: 500,
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start'
      });
    });

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.7/header-attrs.js"></script>
  <script src="../../site_libs/jquery-1.11.3/jquery.min.js"></script>
  <script src="../../site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="../../site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="../../site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="../../site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=UA-20375833-3"></script>
<script type="text/javascript" cookie-consent="tracking">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-20375833-3');
</script>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Predicting Sunspot Frequency with Keras","description":"In this post we will examine making time series predictions using the sunspots dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Our post will focus on both how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain.","authors":[{"author":"Matt Dancho","authorURL":"https://github.com/mdancho84","affiliation":"Business Science","affiliationURL":"https://www.business-science.io/","orcidID":""},{"author":"Sigrid Keydana","authorURL":"https://github.com/skeydan","affiliation":"RStudio","affiliationURL":"https://www.rstudio.com","orcidID":""}],"publishedDate":"2018-06-25T00:00:00.000+00:00","citationText":"Dancho & Keydana, 2018"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<span class="logo">
<img src="../../images/rstudio.png"/>
</span>
<a href="../../index.html" class="title">AI Blog</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../gallery.html">Gallery</a>
<a href="../../about.html">About</a>
<a href="../../contributing.html">Contributing</a>
<a href="../../index.xml">
<i class="fa fa-rss" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Predicting Sunspot Frequency with Keras</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../index.html#category:TensorFlow/Keras" class="dt-tag">TensorFlow/Keras</a>
  <a href="../../index.html#category:Time_Series" class="dt-tag">Time Series</a>
</div>
<!--/radix_placeholder_categories-->
<p><p>In this post we will examine making time series predictions using the sunspots dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Our post will focus on both how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain.</p></p>
</div>

<div class="d-byline">
  Matt Dancho <a href="https://github.com/mdancho84" class="uri">https://github.com/mdancho84</a> (Business Science)<a href="https://www.business-science.io/" class="uri">https://www.business-science.io/</a>
  
,   Sigrid Keydana <a href="https://github.com/skeydan" class="uri">https://github.com/skeydan</a> (RStudio)<a href="https://www.rstudio.com" class="uri">https://www.rstudio.com</a>
  
<br/>2018-06-25
</div>

<div class="d-article">
<h2 id="forecasting-sunspots-with-deep-learning">Forecasting sunspots with deep learning</h2>
<p>In this post we will examine making time series predictions using the <a href="https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/sunspot.month.html">sunspots</a> dataset that ships with base R. Sunspots are dark spots on the sun, associated with lower temperature. Heres an image from NASA showing the solar phenomenon.</p>
<figure>
<img src="images/sunspot_nasa.jpg" class="external" style="width:100.0%" alt="Figure from https://www.nasa.gov/content/goddard/largest-sunspot-of-solar-cycle" /><figcaption aria-hidden="true">Figure from <a href="https://www.nasa.gov/content/goddard/largest-sunspot-of-solar-cycle" class="uri">https://www.nasa.gov/content/goddard/largest-sunspot-of-solar-cycle</a></figcaption>
</figure>
<p>Were using the monthly version of the dataset, <code>sunspots.month</code> (there is a yearly version, too). It contains 265 years worth of data (from 1749 through 2013) on the number of sunspots per month.</p>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/sunspots_full.png" width="352" /></p>
</div>
<p>Forecasting this dataset is challenging because of high short term variability as well as long-term irregularities evident in the cycles. For example, maximum amplitudes reached by the low frequency cycle differ a lot, as does the number of high frequency cycle steps needed to reach that maximum low frequency cycle height.</p>
<p>Our post will focus on two dominant aspects: how to apply deep learning to time series forecasting, and how to properly apply cross validation in this domain. For the latter, we will use the <a href="https://cran.r-project.org/package=rsample">rsample</a> package that allows to do resampling on time series data. As to the former, our goal is not to reach utmost performance but to show the general course of action when using recurrent neural networks to model this kind of data.</p>
<h2 id="recurrent-neural-networks">Recurrent neural networks</h2>
<p>When our data has a sequential structure, it is recurrent neural networks (RNNs) we use to model it.</p>
<p>As of today, among RNNs, the best established architectures are the GRU (Gated Recurrent Unit) and the LSTM (Long Short Term Memory). For today, lets not zoom in on what makes them special, but on what they have in common with the most stripped-down RNN: the basic recurrence structure.</p>
<p>In contrast to the prototype of a neural network, often called Multilayer Perceptron (MLP), the RNN has a state that is carried on over time. This is nicely seen in this diagram from <a href="http://www.deeplearningbook.org">Goodfellow et al.</a>, a.k.a. the bible of deep learning:</p>
<figure>
<img src="images/rnn.png" class="external" alt="Figure from: http://www.deeplearningbook.org" /><figcaption aria-hidden="true">Figure from: <a href="http://www.deeplearningbook.org" class="uri">http://www.deeplearningbook.org</a></figcaption>
</figure>
<p>At each time, the state is a combination of the current input and the previous hidden state. This is reminiscent of autoregressive models, but with neural networks, there has to be some point where we halt the dependence.</p>
<p>Thats because in order to determine the weights, we keep calculating how our loss changes as the input changes. Now if the input we have to consider, at an arbitrary timestep, ranges back indefinitely - then we will not be able to calculate all those gradients. In practice, then, our hidden state will, at every iteration, be carried forward through a fixed number of steps.</p>
<p>Well come back to that as soon as weve loaded and pre-processed the data.</p>
<h2 id="setup-pre-processing-and-exploration">Setup, pre-processing, and exploration</h2>
<h3 id="libraries">Libraries</h3>
<p>Here, first, are the libraries needed for this tutorial.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Core Tidyverse</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tidyverse</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/tidyverse/glue'>glue</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>forcats</span><span class='op'>)</span>

<span class='co'># Time Series</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>timetk</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tidyquant</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tibbletime</span><span class='op'>)</span>

<span class='co'># Visualization</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>cowplot</span><span class='op'>)</span>

<span class='co'># Preprocessing</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>recipes</span><span class='op'>)</span>

<span class='co'># Sampling / Accuracy</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>rsample</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>yardstick</span><span class='op'>)</span> 

<span class='co'># Modeling</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>keras</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tfruns</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>If you have not previously run Keras in R, you will need to install Keras using the <code>install_keras()</code> function.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Install Keras if you have not installed before</span>
<span class='fu'>install_keras</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="data">Data</h3>
<p><code>sunspot.month</code> is a <code>ts</code> class (not tidy), so well convert to a tidy data set using the <code>tk_tbl()</code> function from <code>timetk</code>. We use this instead of <code>as.tibble()</code> from <code>tibble</code> to automatically preserve the time series index as a <code>zoo</code> <code>yearmon</code> index. Last, well convert the <code>zoo</code> index to date using <code>lubridate::as_date()</code> (loaded with <code>tidyquant</code>) and then change to a <code>tbl_time</code> object to make time series operations easier.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>sun_spots</span> <span class='op'>&lt;-</span> <span class='fu'>datasets</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/r/datasets/sunspot.month.html'>sunspot.month</a></span> <span class='op'>%&gt;%</span>
    <span class='fu'>tk_tbl</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>mutate</span><span class='op'>(</span>index <span class='op'>=</span> <span class='fu'>as_date</span><span class='op'>(</span><span class='va'>index</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>as_tbl_time</span><span class='op'>(</span>index <span class='op'>=</span> <span class='va'>index</span><span class='op'>)</span>

<span class='va'>sun_spots</span>
</code></pre>
</div>
</div>
<pre><code># A time tibble: 3,177 x 2
# Index: index
   index      value
   &lt;date&gt;     &lt;dbl&gt;
 1 1749-01-01  58  
 2 1749-02-01  62.6
 3 1749-03-01  70  
 4 1749-04-01  55.7
 5 1749-05-01  85  
 6 1749-06-01  83.5
 7 1749-07-01  94.8
 8 1749-08-01  66.3
 9 1749-09-01  75.9
10 1749-10-01  75.5
# ... with 3,167 more rows</code></pre>
<h3 id="exploratory-data-analysis">Exploratory data analysis</h3>
<p>The time series is long (265 years!). We can visualize the time series both in full, and zoomed in on the first 10 years to get a feel for the series.</p>
<h4 id="visualizing-sunspot-data-with-cowplot">Visualizing sunspot data with cowplot</h4>
<p>Well make two <code>ggplot</code>s and combine them using <code>cowplot::plot_grid()</code>. Note that for the zoomed in plot, we make use of <code>tibbletime::time_filter()</code>, which is an easy way to perform time-based filtering.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='va'>sun_spots</span> <span class='op'>%&gt;%</span>
    <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span><span class='va'>index</span>, <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'>palette_light</span><span class='op'>(</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span>, alpha <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_tq</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>labs</span><span class='op'>(</span>
        title <span class='op'>=</span> <span class='st'>"From 1749 to 2013 (Full Data Set)"</span>
    <span class='op'>)</span>

<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='va'>sun_spots</span> <span class='op'>%&gt;%</span>
    <span class='fu'>filter_time</span><span class='op'>(</span><span class='st'>"start"</span> <span class='op'>~</span> <span class='st'>"1800"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span><span class='va'>index</span>, <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'>palette_light</span><span class='op'>(</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span>, alpha <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_point</span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'>palette_light</span><span class='op'>(</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_smooth</span><span class='op'>(</span>method <span class='op'>=</span> <span class='st'>"loess"</span>, span <span class='op'>=</span> <span class='fl'>0.2</span>, se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme_tq</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>labs</span><span class='op'>(</span>
        title <span class='op'>=</span> <span class='st'>"1749 to 1759 (Zoomed In To Show Changes over the Year)"</span>,
        caption <span class='op'>=</span> <span class='st'>"datasets::sunspot.month"</span>
    <span class='op'>)</span>

<span class='va'>p_title</span> <span class='op'>&lt;-</span> <span class='fu'>ggdraw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>draw_label</span><span class='op'>(</span><span class='st'>"Sunspots"</span>, size <span class='op'>=</span> <span class='fl'>18</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span>, 
             colour <span class='op'>=</span> <span class='fu'>palette_light</span><span class='op'>(</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>

<span class='fu'>plot_grid</span><span class='op'>(</span><span class='va'>p_title</span>, <span class='va'>p1</span>, <span class='va'>p2</span>, ncol <span class='op'>=</span> <span class='fl'>1</span>, rel_heights <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.1</span>, <span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/cowplot.png" width="352" /></p>
</div>
<h3 id="backtesting-time-series-cross-validation">Backtesting: time series cross validation</h3>
<p>When doing cross validation on sequential data, the time dependencies on preceding samples must be preserved. We can create a cross validation sampling plan by offsetting the window used to select sequential sub-samples. In essence, were creatively dealing with the fact that theres no future test data available by creating multiple synthetic futures - a process often, esp.in finance, called backtesting.</p>
<p>As mentioned in the introduction, the <a href="https://cran.r-project.org/package=rsample">rsample</a> package includes facitlities for backtesting on time series. The vignette, <a href="https://tidymodels.github.io/rsample/articles/Applications/Time_Series.html">Time Series Analysis Example</a>, describes a procedure that uses the <code>rolling_origin()</code> function to create samples designed for time series cross validation. Well use this approach.</p>
<h4 id="developing-a-backtesting-strategy">Developing a backtesting strategy</h4>
<p>The sampling plan we create uses 100 years (<code>initial</code> = 12 x 100 samples) for the training set and 50 years (<code>assess</code> = 12 x 50) for the testing (validation) set. We select a <code>skip</code> span of about 22 years (<code>skip</code> = 12 x 22 - 1) to approximately evenly distribute the samples into 6 sets that span the entire 265 years of sunspots history. Last, we select <code>cumulative = FALSE</code> to allow the origin to shift which ensures that models on more recent data are not given an unfair advantage (more observations) over those operating on less recent data. The tibble return contains the <code>rolling_origin_resamples</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>periods_train</span> <span class='op'>&lt;-</span> <span class='fl'>12</span> <span class='op'>*</span> <span class='fl'>100</span>
<span class='va'>periods_test</span>  <span class='op'>&lt;-</span> <span class='fl'>12</span> <span class='op'>*</span> <span class='fl'>50</span>
<span class='va'>skip_span</span>     <span class='op'>&lt;-</span> <span class='fl'>12</span> <span class='op'>*</span> <span class='fl'>22</span> <span class='op'>-</span> <span class='fl'>1</span>

<span class='va'>rolling_origin_resamples</span> <span class='op'>&lt;-</span> <span class='fu'>rolling_origin</span><span class='op'>(</span>
  <span class='va'>sun_spots</span>,
  initial    <span class='op'>=</span> <span class='va'>periods_train</span>,
  assess     <span class='op'>=</span> <span class='va'>periods_test</span>,
  cumulative <span class='op'>=</span> <span class='cn'>FALSE</span>,
  skip       <span class='op'>=</span> <span class='va'>skip_span</span>
<span class='op'>)</span>

<span class='va'>rolling_origin_resamples</span>
</code></pre>
</div>
</div>
<pre><code># Rolling origin forecast resampling 
# A tibble: 6 x 2
  splits       id    
  &lt;list&gt;       &lt;chr&gt; 
1 &lt;S3: rsplit&gt; Slice1
2 &lt;S3: rsplit&gt; Slice2
3 &lt;S3: rsplit&gt; Slice3
4 &lt;S3: rsplit&gt; Slice4
5 &lt;S3: rsplit&gt; Slice5
6 &lt;S3: rsplit&gt; Slice6</code></pre>
<h4 id="visualizing-the-backtesting-strategy">Visualizing the backtesting strategy</h4>
<p>We can visualize the resamples with two custom functions. The first, <code>plot_split()</code>, plots one of the resampling splits using <code>ggplot2</code>. Note that an <code>expand_y_axis</code> argument is added to expand the date range to the full <code>sun_spots</code> dataset date range. This will become useful when we visualize all plots together.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Plotting function for a single split</span>
<span class='va'>plot_split</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>split</span>, <span class='va'>expand_y_axis</span> <span class='op'>=</span> <span class='cn'>TRUE</span>, 
                       <span class='va'>alpha</span> <span class='op'>=</span> <span class='fl'>1</span>, <span class='va'>size</span> <span class='op'>=</span> <span class='fl'>1</span>, <span class='va'>base_size</span> <span class='op'>=</span> <span class='fl'>14</span><span class='op'>)</span> <span class='op'>{</span>
    
    <span class='co'># Manipulate data</span>
    <span class='va'>train_tbl</span> <span class='op'>&lt;-</span> <span class='fu'>training</span><span class='op'>(</span><span class='va'>split</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
        <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"training"</span><span class='op'>)</span> 
    
    <span class='va'>test_tbl</span>  <span class='op'>&lt;-</span> <span class='fu'>testing</span><span class='op'>(</span><span class='va'>split</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
        <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"testing"</span><span class='op'>)</span> 
    
    <span class='va'>data_manipulated</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span><span class='va'>train_tbl</span>, <span class='va'>test_tbl</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
        <span class='fu'>as_tbl_time</span><span class='op'>(</span>index <span class='op'>=</span> <span class='va'>index</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
        <span class='fu'>mutate</span><span class='op'>(</span>key <span class='op'>=</span> <span class='fu'>fct_relevel</span><span class='op'>(</span><span class='va'>key</span>, <span class='st'>"training"</span>, <span class='st'>"testing"</span><span class='op'>)</span><span class='op'>)</span>
        
    <span class='co'># Collect attributes</span>
    <span class='va'>train_time_summary</span> <span class='op'>&lt;-</span> <span class='va'>train_tbl</span> <span class='op'>%&gt;%</span>
        <span class='fu'>tk_index</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
        <span class='fu'>tk_get_timeseries_summary</span><span class='op'>(</span><span class='op'>)</span>
    
    <span class='va'>test_time_summary</span> <span class='op'>&lt;-</span> <span class='va'>test_tbl</span> <span class='op'>%&gt;%</span>
        <span class='fu'>tk_index</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
        <span class='fu'>tk_get_timeseries_summary</span><span class='op'>(</span><span class='op'>)</span>
    
    <span class='co'># Visualize</span>
    <span class='va'>g</span> <span class='op'>&lt;-</span> <span class='va'>data_manipulated</span> <span class='op'>%&gt;%</span>
        <span class='fu'>ggplot</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>index</span>, y <span class='op'>=</span> <span class='va'>value</span>, color <span class='op'>=</span> <span class='va'>key</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
        <span class='fu'>geom_line</span><span class='op'>(</span>size <span class='op'>=</span> <span class='va'>size</span>, alpha <span class='op'>=</span> <span class='va'>alpha</span><span class='op'>)</span> <span class='op'>+</span>
        <span class='fu'>theme_tq</span><span class='op'>(</span>base_size <span class='op'>=</span> <span class='va'>base_size</span><span class='op'>)</span> <span class='op'>+</span>
        <span class='fu'>scale_color_tq</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
        <span class='fu'>labs</span><span class='op'>(</span>
          title    <span class='op'>=</span> <span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"Split: {split$id}"</span><span class='op'>)</span>,
          subtitle <span class='op'>=</span> <span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"{train_time_summary$start} to "</span>, 
                          <span class='st'>"{test_time_summary$end}"</span><span class='op'>)</span>,
            y <span class='op'>=</span> <span class='st'>""</span>, x <span class='op'>=</span> <span class='st'>""</span>
        <span class='op'>)</span> <span class='op'>+</span>
        <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"none"</span><span class='op'>)</span> 
    
    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>expand_y_axis</span><span class='op'>)</span> <span class='op'>{</span>
        
        <span class='va'>sun_spots_time_summary</span> <span class='op'>&lt;-</span> <span class='va'>sun_spots</span> <span class='op'>%&gt;%</span> 
            <span class='fu'>tk_index</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
            <span class='fu'>tk_get_timeseries_summary</span><span class='op'>(</span><span class='op'>)</span>
        
        <span class='va'>g</span> <span class='op'>&lt;-</span> <span class='va'>g</span> <span class='op'>+</span>
            <span class='fu'>scale_x_date</span><span class='op'>(</span>limits <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>sun_spots_time_summary</span><span class='op'>$</span><span class='va'>start</span>, 
                                    <span class='va'>sun_spots_time_summary</span><span class='op'>$</span><span class='va'>end</span><span class='op'>)</span><span class='op'>)</span>
    <span class='op'>}</span>
    
    <span class='va'>g</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>The <code>plot_split()</code> function takes one split (in this case Slice01), and returns a visual of the sampling strategy. We expand the axis to the range for the full dataset using <code>expand_y_axis = TRUE</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rolling_origin_resamples</span><span class='op'>$</span><span class='va'>splits</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>%&gt;%</span>
    <span class='fu'>plot_split</span><span class='op'>(</span>expand_y_axis <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<p><img src="images/slice1.png" width="262" /></p>
</div>
<p>The second function, <code>plot_sampling_plan()</code>, scales the <code>plot_split()</code> function to all of the samples using <code>purrr</code> and <code>cowplot</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Plotting function that scales to all splits </span>
<span class='va'>plot_sampling_plan</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>sampling_tbl</span>, <span class='va'>expand_y_axis</span> <span class='op'>=</span> <span class='cn'>TRUE</span>, 
                               <span class='va'>ncol</span> <span class='op'>=</span> <span class='fl'>3</span>, <span class='va'>alpha</span> <span class='op'>=</span> <span class='fl'>1</span>, <span class='va'>size</span> <span class='op'>=</span> <span class='fl'>1</span>, <span class='va'>base_size</span> <span class='op'>=</span> <span class='fl'>14</span>, 
                               <span class='va'>title</span> <span class='op'>=</span> <span class='st'>"Sampling Plan"</span><span class='op'>)</span> <span class='op'>{</span>
    
    <span class='co'># Map plot_split() to sampling_tbl</span>
    <span class='va'>sampling_tbl_with_plots</span> <span class='op'>&lt;-</span> <span class='va'>sampling_tbl</span> <span class='op'>%&gt;%</span>
        <span class='fu'>mutate</span><span class='op'>(</span>gg_plots <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>splits</span>, <span class='va'>plot_split</span>, 
                              expand_y_axis <span class='op'>=</span> <span class='va'>expand_y_axis</span>,
                              alpha <span class='op'>=</span> <span class='va'>alpha</span>, base_size <span class='op'>=</span> <span class='va'>base_size</span><span class='op'>)</span><span class='op'>)</span>
    
    <span class='co'># Make plots with cowplot</span>
    <span class='va'>plot_list</span> <span class='op'>&lt;-</span> <span class='va'>sampling_tbl_with_plots</span><span class='op'>$</span><span class='va'>gg_plots</span> 
    
    <span class='va'>p_temp</span> <span class='op'>&lt;-</span> <span class='va'>plot_list</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>+</span> <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span><span class='op'>)</span>
    <span class='va'>legend</span> <span class='op'>&lt;-</span> <span class='fu'>get_legend</span><span class='op'>(</span><span class='va'>p_temp</span><span class='op'>)</span>
    
    <span class='va'>p_body</span>  <span class='op'>&lt;-</span> <span class='fu'>plot_grid</span><span class='op'>(</span>plotlist <span class='op'>=</span> <span class='va'>plot_list</span>, ncol <span class='op'>=</span> <span class='va'>ncol</span><span class='op'>)</span>
    
    <span class='va'>p_title</span> <span class='op'>&lt;-</span> <span class='fu'>ggdraw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
        <span class='fu'>draw_label</span><span class='op'>(</span><span class='va'>title</span>, size <span class='op'>=</span> <span class='fl'>14</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span>, 
                   colour <span class='op'>=</span> <span class='fu'>palette_light</span><span class='op'>(</span><span class='op'>)</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>
    
    <span class='va'>g</span> <span class='op'>&lt;-</span> <span class='fu'>plot_grid</span><span class='op'>(</span><span class='va'>p_title</span>, <span class='va'>p_body</span>, <span class='va'>legend</span>, ncol <span class='op'>=</span> <span class='fl'>1</span>, 
                   rel_heights <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.05</span>, <span class='fl'>1</span>, <span class='fl'>0.05</span><span class='op'>)</span><span class='op'>)</span>
    
    <span class='va'>g</span>
    
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>We can now visualize the entire backtesting strategy with <code>plot_sampling_plan()</code>. We can see how the sampling plan shifts the sampling window with each progressive slice of the train/test splits.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rolling_origin_resamples</span> <span class='op'>%&gt;%</span>
    <span class='fu'>plot_sampling_plan</span><span class='op'>(</span>expand_y_axis <span class='op'>=</span> <span class='cn'>T</span>, ncol <span class='op'>=</span> <span class='fl'>3</span>, alpha <span class='op'>=</span> <span class='fl'>1</span>, size <span class='op'>=</span> <span class='fl'>1</span>, base_size <span class='op'>=</span> <span class='fl'>10</span>, 
                       title <span class='op'>=</span> <span class='st'>"Backtesting Strategy: Rolling Origin Sampling Plan"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><br/></p>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/all_splits.png" width="400" /></p>
</div>
<p>And, we can set <code>expand_y_axis = FALSE</code> to zoom in on the samples.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rolling_origin_resamples</span> <span class='op'>%&gt;%</span>
    <span class='fu'>plot_sampling_plan</span><span class='op'>(</span>expand_y_axis <span class='op'>=</span> <span class='cn'>F</span>, ncol <span class='op'>=</span> <span class='fl'>3</span>, alpha <span class='op'>=</span> <span class='fl'>1</span>, size <span class='op'>=</span> <span class='fl'>1</span>, base_size <span class='op'>=</span> <span class='fl'>10</span>, 
                       title <span class='op'>=</span> <span class='st'>"Backtesting Strategy: Zoomed In"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><br/></p>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/all_splits_zoomed.png" width="400" /></p>
</div>
<p>Well use this backtesting strategy (6 samples from one time series each with 50/10 split in years and a ~20 year offset) when testing the veracity of the LSTM model on the sunspots dataset.</p>
<h2 id="the-lstm-model">The LSTM model</h2>
<p>To begin, well develop an LSTM model on a single sample from the backtesting strategy, namely, the most recent slice. Well then apply the model to all samples to investigate modeling performance.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>example_split</span>    <span class='op'>&lt;-</span> <span class='va'>rolling_origin_resamples</span><span class='op'>$</span><span class='va'>splits</span><span class='op'>[[</span><span class='fl'>6</span><span class='op'>]</span><span class='op'>]</span>
<span class='va'>example_split_id</span> <span class='op'>&lt;-</span> <span class='va'>rolling_origin_resamples</span><span class='op'>$</span><span class='va'>id</span><span class='op'>[[</span><span class='fl'>6</span><span class='op'>]</span><span class='op'>]</span>
</code></pre>
</div>
</div>
<p>We can reuse the <code>plot_split()</code> function to visualize the split. Set <code>expand_y_axis = FALSE</code> to zoom in on the subsample.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>plot_split</span><span class='op'>(</span><span class='va'>example_split</span>, expand_y_axis <span class='op'>=</span> <span class='cn'>FALSE</span>, size <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>theme</span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ggtitle</span><span class='op'>(</span><span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"Split: {example_split_id}"</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><img src="images/slice6.png" /></p>
<h3 id="data-setup">Data setup</h3>
<p>To aid hyperparameter tuning, besides the training set we also need a validation set. For example, we will use a callback, <code>callback_early_stopping</code>, that stops training when no significant performance is seen on the validation set (whats considered significant is up to you).</p>
<p>We will dedicate 2 thirds of the analysis set to training, and 1 third to validation.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df_trn</span> <span class='op'>&lt;-</span> <span class='fu'>analysis</span><span class='op'>(</span><span class='va'>example_split</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>800</span>, , drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>
<span class='va'>df_val</span> <span class='op'>&lt;-</span> <span class='fu'>analysis</span><span class='op'>(</span><span class='va'>example_split</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>801</span><span class='op'>:</span><span class='fl'>1200</span>, , drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>
<span class='va'>df_tst</span> <span class='op'>&lt;-</span> <span class='fu'>assessment</span><span class='op'>(</span><span class='va'>example_split</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>First, lets combine the training and testing data sets into a single data set with a column <code>key</code> that specifies where they came from (either training or testing). Note that the <code>tbl_time</code> object will need to have the index respecified during the <code>bind_rows()</code> step, but <a href="https://github.com/tidyverse/dplyr/issues/3259">this issue</a> should be corrected in <code>dplyr</code> soon.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span>
  <span class='va'>df_trn</span> <span class='op'>%&gt;%</span> <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"training"</span><span class='op'>)</span>,
  <span class='va'>df_val</span> <span class='op'>%&gt;%</span> <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"validation"</span><span class='op'>)</span>,
  <span class='va'>df_tst</span> <span class='op'>%&gt;%</span> <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"testing"</span><span class='op'>)</span>
<span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>as_tbl_time</span><span class='op'>(</span>index <span class='op'>=</span> <span class='va'>index</span><span class='op'>)</span>

<span class='va'>df</span>
</code></pre>
</div>
</div>
<pre><code># A time tibble: 1,800 x 3
# Index: index
   index      value key     
   &lt;date&gt;     &lt;dbl&gt; &lt;chr&gt;   
 1 1849-06-01  81.1 training
 2 1849-07-01  78   training
 3 1849-08-01  67.7 training
 4 1849-09-01  93.7 training
 5 1849-10-01  71.5 training
 6 1849-11-01  99   training
 7 1849-12-01  97   training
 8 1850-01-01  78   training
 9 1850-02-01  89.4 training
10 1850-03-01  82.6 training
# ... with 1,790 more rows</code></pre>
<h3 id="preprocessing-with-recipes">Preprocessing with recipes</h3>
<p>The LSTM algorithm will usually work better if the input data has been centered and scaled. We can conveniently accomplish this using the <code>recipes</code> package. In addition to <code>step_center</code> and <code>step_scale</code>, were using <code>step_sqrt</code> to reduce variance and remov outliers. The actual transformations are executed when we <code>bake</code> the data according to the recipe:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>rec_obj</span> <span class='op'>&lt;-</span> <span class='fu'>recipe</span><span class='op'>(</span><span class='va'>value</span> <span class='op'>~</span> <span class='va'>.</span>, <span class='va'>df</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>step_sqrt</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>step_center</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>step_scale</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>prep</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>df_processed_tbl</span> <span class='op'>&lt;-</span> <span class='fu'>bake</span><span class='op'>(</span><span class='va'>rec_obj</span>, <span class='va'>df</span><span class='op'>)</span>

<span class='va'>df_processed_tbl</span>
</code></pre>
</div>
</div>
<pre><code># A tibble: 1,800 x 3
   index      value key     
   &lt;date&gt;     &lt;dbl&gt; &lt;fct&gt;   
 1 1849-06-01 0.714 training
 2 1849-07-01 0.660 training
 3 1849-08-01 0.473 training
 4 1849-09-01 0.922 training
 5 1849-10-01 0.544 training
 6 1849-11-01 1.01  training
 7 1849-12-01 0.974 training
 8 1850-01-01 0.660 training
 9 1850-02-01 0.852 training
10 1850-03-01 0.739 training
# ... with 1,790 more rows</code></pre>
<p>Next, lets capture the original center and scale so we can invert the steps after modeling. The square root step can then simply be undone by squaring the back-transformed data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>center_history</span> <span class='op'>&lt;-</span> <span class='va'>rec_obj</span><span class='op'>$</span><span class='va'>steps</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span><span class='op'>$</span><span class='va'>means</span><span class='op'>[</span><span class='st'>"value"</span><span class='op'>]</span>
<span class='va'>scale_history</span>  <span class='op'>&lt;-</span> <span class='va'>rec_obj</span><span class='op'>$</span><span class='va'>steps</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span><span class='op'>$</span><span class='va'>sds</span><span class='op'>[</span><span class='st'>"value"</span><span class='op'>]</span>

<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"center"</span> <span class='op'>=</span> <span class='va'>center_history</span>, <span class='st'>"scale"</span> <span class='op'>=</span> <span class='va'>scale_history</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<pre><code>center.value  scale.value 
    6.694468     3.238935 </code></pre>
<h3 id="reshaping-the-data">Reshaping the data</h3>
<p>Keras LSTM expects the input as well as the target data to be in a specific shape. The input has to be a 3-d array of size <code>num_samples, num_timesteps, num_features</code>.</p>
<p>Here, <code>num_samples</code> is the number of observations in the set. This will get fed to the model in portions of <code>batch_size</code>. The second dimension, <code>num_timesteps</code>, is the length of the hidden state we were talking about above. Finally, the third dimension is the number of predictors were using. For univariate time series, this is 1.</p>
<p>How long should we choose the hidden state to be? This generally depends on the dataset and our goal. If we did one-step-ahead forecasts - thus, forecasting the following month only - our main concern would be choosing a state length that allows to learn any patterns present in the data.</p>
<p>Now say we wanted to forecast 12 months instead, as does <a href="http://sidc.be/silso/home">SILSO</a>, the <em>World Data Center for the production, preservation and dissemination of the international sunspot number</em>. The way we can do this, with Keras, is by wiring the LSTM hidden states to sets of consecutive outputs of the same length. Thus, if we want to produce predictions for 12 months, our LSTM should have a hidden state length of 12.</p>
<p>These 12 time steps will then get wired to 12 linear predictor units using a <code>time_distributed()</code> wrapper. That wrappers task is to apply the same calculation (i.e., the same weight matrix) to every state input it receives.</p>
<p>Now, whats the target arrays format supposed to be? As were forecasting several timesteps here, the target data again needs to be 3-dimensional. Dimension 1 again is the batch dimension, dimension 2 again corresponds to the number of timesteps (the forecasted ones), and dimension 3 is the size of the wrapped layer. In our case, the wrapped layer is a <code>layer_dense()</code> of a single unit, as we want exactly one prediction per point in time.</p>
<p>So, lets reshape the data. The main action here is creating the sliding windows of 12 steps of input, followed by 12 steps of output each. This is easiest to understand with a shorter and simpler example. Say our input were the numbers from 1 to 10, and our chosen sequence length (state size) were 4. Tthis is how we would want our training input to look:</p>
<pre><code>1,2,3,4
2,3,4,5
3,4,5,6</code></pre>
<p>And our target data, correspondingly:</p>
<pre><code>5,6,7,8
6,7,8,9
7,8,9,10</code></pre>
<p>Well define a short function that does this reshaping on a given dataset. Then finally, we add the third axis that is formally needed (even though that axis is of size 1 in our case).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># these variables are being defined just because of the order in which</span>
<span class='co'># we present things in this post (first the data, then the model)</span>
<span class='co'># they will be superseded by FLAGS$n_timesteps, FLAGS$batch_size and n_predictions</span>
<span class='co'># in the following snippet</span>
<span class='va'>n_timesteps</span> <span class='op'>&lt;-</span> <span class='fl'>12</span>
<span class='va'>n_predictions</span> <span class='op'>&lt;-</span> <span class='va'>n_timesteps</span>
<span class='va'>batch_size</span> <span class='op'>&lt;-</span> <span class='fl'>10</span>

<span class='co'># functions used</span>
<span class='va'>build_matrix</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>tseries</span>, <span class='va'>overall_timesteps</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/t.html'>t</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/lapply.html'>sapply</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>tseries</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>overall_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> 
    <span class='va'>tseries</span><span class='op'>[</span><span class='va'>x</span><span class='op'>:</span><span class='op'>(</span><span class='va'>x</span> <span class='op'>+</span> <span class='va'>overall_timesteps</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>reshape_X_3d</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>, <span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span>, <span class='fl'>1</span><span class='op'>)</span>
  <span class='va'>X</span>
<span class='op'>}</span>

<span class='co'># extract values from data frame</span>
<span class='va'>train_vals</span> <span class='op'>&lt;-</span> <span class='va'>df_processed_tbl</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"training"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pull</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>valid_vals</span> <span class='op'>&lt;-</span> <span class='va'>df_processed_tbl</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"validation"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pull</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>test_vals</span> <span class='op'>&lt;-</span> <span class='va'>df_processed_tbl</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"testing"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>pull</span><span class='op'>(</span><span class='op'>)</span>


<span class='co'># build the windowed matrices</span>
<span class='va'>train_matrix</span> <span class='op'>&lt;-</span>
  <span class='fu'>build_matrix</span><span class='op'>(</span><span class='va'>train_vals</span>, <span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>n_predictions</span><span class='op'>)</span>
<span class='va'>valid_matrix</span> <span class='op'>&lt;-</span>
  <span class='fu'>build_matrix</span><span class='op'>(</span><span class='va'>valid_vals</span>, <span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>n_predictions</span><span class='op'>)</span>
<span class='va'>test_matrix</span> <span class='op'>&lt;-</span> <span class='fu'>build_matrix</span><span class='op'>(</span><span class='va'>test_vals</span>, <span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>n_predictions</span><span class='op'>)</span>

<span class='co'># separate matrices into training and testing parts</span>
<span class='co'># also, discard last batch if there are fewer than batch_size samples</span>
<span class='co'># (a purely technical requirement)</span>
<span class='va'>X_train</span> <span class='op'>&lt;-</span> <span class='va'>train_matrix</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_timesteps</span><span class='op'>]</span>
<span class='va'>y_train</span> <span class='op'>&lt;-</span> <span class='va'>train_matrix</span><span class='op'>[</span>, <span class='op'>(</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>X_train</span> <span class='op'>&lt;-</span> <span class='va'>X_train</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_train</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>batch_size</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>y_train</span> <span class='op'>&lt;-</span> <span class='va'>y_train</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>y_train</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>batch_size</span><span class='op'>)</span>, <span class='op'>]</span>

<span class='va'>X_valid</span> <span class='op'>&lt;-</span> <span class='va'>valid_matrix</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_timesteps</span><span class='op'>]</span>
<span class='va'>y_valid</span> <span class='op'>&lt;-</span> <span class='va'>valid_matrix</span><span class='op'>[</span>, <span class='op'>(</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>X_valid</span> <span class='op'>&lt;-</span> <span class='va'>X_valid</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_valid</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>batch_size</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>y_valid</span> <span class='op'>&lt;-</span> <span class='va'>y_valid</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>y_valid</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>batch_size</span><span class='op'>)</span>, <span class='op'>]</span>

<span class='va'>X_test</span> <span class='op'>&lt;-</span> <span class='va'>test_matrix</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_timesteps</span><span class='op'>]</span>
<span class='va'>y_test</span> <span class='op'>&lt;-</span> <span class='va'>test_matrix</span><span class='op'>[</span>, <span class='op'>(</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>X_test</span> <span class='op'>&lt;-</span> <span class='va'>X_test</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_test</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>batch_size</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>y_test</span> <span class='op'>&lt;-</span> <span class='va'>y_test</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>y_test</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>batch_size</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='co'># add on the required third axis</span>
<span class='va'>X_train</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>X_train</span><span class='op'>)</span>
<span class='va'>X_valid</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>X_valid</span><span class='op'>)</span>
<span class='va'>X_test</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>X_test</span><span class='op'>)</span>

<span class='va'>y_train</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>y_train</span><span class='op'>)</span>
<span class='va'>y_valid</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>y_valid</span><span class='op'>)</span>
<span class='va'>y_test</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>y_test</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="building-the-lstm-model">Building the LSTM model</h3>
<p>Now that we have our data in the required form, lets finally build the model. As always in deep learning, an important, and often time-consuming, part of the job is tuning hyperparameters. To keep this post self-contained, and considering this is primarily a tutorial on how to use LSTM in R, lets assume the following settings were found after extensive experimentation (in reality experimentation <em>did</em> take place, but not to a degree that performance couldnt possibly be improved).</p>
<p>Instead of hard coding the hyperparameters, well use <a href="https://tensorflow.rstudio.com/tools/tfruns/articles/tuning.html">tfruns</a> to set up an environment where we could easily perform grid search.</p>
<p>Well quickly comment on what these parameters do but mainly leave those topics to further posts.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>FLAGS</span> <span class='op'>&lt;-</span> <span class='fu'>flags</span><span class='op'>(</span>
  <span class='co'># There is a so-called "stateful LSTM" in Keras. While LSTM is stateful</span>
  <span class='co'># per se, this adds a further tweak where the hidden states get </span>
  <span class='co'># initialized with values from the item at same position in the previous</span>
  <span class='co'># batch. This is helpful just under specific circumstances, or if you want</span>
  <span class='co'># to create an "infinite stream" of states, in which case you'd use 1 as </span>
  <span class='co'># the batch size. Below, we show how the code would have to be changed to</span>
  <span class='co'># use this, but it won't be further discussed here.</span>
  <span class='fu'>flag_boolean</span><span class='op'>(</span><span class='st'>"stateful"</span>, <span class='cn'>FALSE</span><span class='op'>)</span>,
  <span class='co'># Should we use several layers of LSTM?</span>
  <span class='co'># Again, just included for completeness, it did not yield any superior </span>
  <span class='co'># performance on this task.</span>
  <span class='co'># This will actually stack exactly one additional layer of LSTM units.</span>
  <span class='fu'>flag_boolean</span><span class='op'>(</span><span class='st'>"stack_layers"</span>, <span class='cn'>FALSE</span><span class='op'>)</span>,
  <span class='co'># number of samples fed to the model in one go</span>
  <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"batch_size"</span>, <span class='fl'>10</span><span class='op'>)</span>,
  <span class='co'># size of the hidden state, equals size of predictions</span>
  <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"n_timesteps"</span>, <span class='fl'>12</span><span class='op'>)</span>,
  <span class='co'># how many epochs to train for</span>
  <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"n_epochs"</span>, <span class='fl'>100</span><span class='op'>)</span>,
  <span class='co'># fraction of the units to drop for the linear transformation of the inputs</span>
  <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"dropout"</span>, <span class='fl'>0.2</span><span class='op'>)</span>,
  <span class='co'># fraction of the units to drop for the linear transformation of the </span>
  <span class='co'># recurrent state</span>
  <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"recurrent_dropout"</span>, <span class='fl'>0.2</span><span class='op'>)</span>,
  <span class='co'># loss function. Found to work better for this specific case than mean</span>
  <span class='co'># squared error</span>
  <span class='fu'>flag_string</span><span class='op'>(</span><span class='st'>"loss"</span>, <span class='st'>"logcosh"</span><span class='op'>)</span>,
  <span class='co'># optimizer = stochastic gradient descent. Seemed to work better than adam </span>
  <span class='co'># or rmsprop here (as indicated by limited testing)</span>
  <span class='fu'>flag_string</span><span class='op'>(</span><span class='st'>"optimizer_type"</span>, <span class='st'>"sgd"</span><span class='op'>)</span>,
  <span class='co'># size of the LSTM layer</span>
  <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"n_units"</span>, <span class='fl'>128</span><span class='op'>)</span>,
  <span class='co'># learning rate</span>
  <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"lr"</span>, <span class='fl'>0.003</span><span class='op'>)</span>,
  <span class='co'># momentum, an additional parameter to the SGD optimizer</span>
  <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"momentum"</span>, <span class='fl'>0.9</span><span class='op'>)</span>,
  <span class='co'># parameter to the early stopping callback</span>
  <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"patience"</span>, <span class='fl'>10</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># the number of predictions we'll make equals the length of the hidden state</span>
<span class='va'>n_predictions</span> <span class='op'>&lt;-</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span>
<span class='co'># how many features = predictors we have</span>
<span class='va'>n_features</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>
<span class='co'># just in case we wanted to try different optimizers, we could add here</span>
<span class='va'>optimizer</span> <span class='op'>&lt;-</span> <span class='kw'><a href='https://rdrr.io/r/base/switch.html'>switch</a></span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>optimizer_type</span>,
                    sgd <span class='op'>=</span> <span class='fu'>optimizer_sgd</span><span class='op'>(</span>lr <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>lr</span>, 
                                        momentum <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>momentum</span><span class='op'>)</span>
                    <span class='op'>)</span>

<span class='co'># callbacks to be passed to the fit() function</span>
<span class='co'># We just use one here: we may stop before n_epochs if the loss on the</span>
<span class='co'># validation set does not decrease (by a configurable amount, over a </span>
<span class='co'># configurable time)</span>
<span class='va'>callbacks</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
  <span class='fu'>callback_early_stopping</span><span class='op'>(</span>patience <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>patience</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>After all these preparations, the code for constructing and training the model is rather short! Lets first quickly view the long version, that would allow you to test stacking several LSTMs or use a stateful LSTM, then go through the final short version (that does neither) and comment on it.</p>
<p>This, just for reference, is the complete code.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>model</span> <span class='op'>&lt;-</span> <span class='fu'>keras_model_sequential</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>model</span> <span class='op'>%&gt;%</span>
  <span class='fu'>layer_lstm</span><span class='op'>(</span>
    units <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_units</span>,
    batch_input_shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span>, <span class='va'>n_features</span><span class='op'>)</span>,
    dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>dropout</span>,
    recurrent_dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>recurrent_dropout</span>,
    return_sequences <span class='op'>=</span> <span class='cn'>TRUE</span>,
    stateful <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>stateful</span>
  <span class='op'>)</span>

<span class='kw'>if</span> <span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>stack_layers</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>model</span> <span class='op'>%&gt;%</span>
    <span class='fu'>layer_lstm</span><span class='op'>(</span>
      units <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_units</span>,
      dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>dropout</span>,
      recurrent_dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>recurrent_dropout</span>,
      return_sequences <span class='op'>=</span> <span class='cn'>TRUE</span>,
      stateful <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>stateful</span>
    <span class='op'>)</span>
<span class='op'>}</span>
<span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>time_distributed</span><span class='op'>(</span><span class='fu'>layer_dense</span><span class='op'>(</span>units <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>model</span> <span class='op'>%&gt;%</span>
  <span class='fu'>compile</span><span class='op'>(</span>
    loss <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>loss</span>,
    optimizer <span class='op'>=</span> <span class='va'>optimizer</span>,
    metrics <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='st'>"mean_squared_error"</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='kw'>if</span> <span class='op'>(</span><span class='op'>!</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>stateful</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>fit</span><span class='op'>(</span>
    x          <span class='op'>=</span> <span class='va'>X_train</span>,
    y          <span class='op'>=</span> <span class='va'>y_train</span>,
    validation_data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>X_valid</span>, <span class='va'>y_valid</span><span class='op'>)</span>,
    batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>,
    epochs     <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_epochs</span>,
    callbacks <span class='op'>=</span> <span class='va'>callbacks</span>
  <span class='op'>)</span>
  
<span class='op'>}</span> <span class='kw'>else</span> <span class='op'>{</span>
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_epochs</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>fit</span><span class='op'>(</span>
      x          <span class='op'>=</span> <span class='va'>X_train</span>,
      y          <span class='op'>=</span> <span class='va'>y_train</span>,
      validation_data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>X_valid</span>, <span class='va'>y_valid</span><span class='op'>)</span>,
      callbacks <span class='op'>=</span> <span class='va'>callbacks</span>,
      batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>,
      epochs     <span class='op'>=</span> <span class='fl'>1</span>,
      shuffle    <span class='op'>=</span> <span class='cn'>FALSE</span>
    <span class='op'>)</span>
    <span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>reset_states</span><span class='op'>(</span><span class='op'>)</span>
  <span class='op'>}</span>
<span class='op'>}</span>

<span class='kw'>if</span> <span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>stateful</span><span class='op'>)</span>
  <span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>reset_states</span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Now lets step through the simpler, yet better (or equally) performing configuration below.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># create the model</span>
<span class='va'>model</span> <span class='op'>&lt;-</span> <span class='fu'>keras_model_sequential</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># add layers</span>
<span class='co'># we have just two, the LSTM and the time_distributed </span>
<span class='va'>model</span> <span class='op'>%&gt;%</span>
  <span class='fu'>layer_lstm</span><span class='op'>(</span>
    units <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_units</span>, 
    <span class='co'># the first layer in a model needs to know the shape of the input data</span>
    batch_input_shape  <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span>, <span class='va'>n_features</span><span class='op'>)</span>,
    dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>dropout</span>,
    recurrent_dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>recurrent_dropout</span>,
    <span class='co'># by default, an LSTM just returns the final state</span>
    return_sequences <span class='op'>=</span> <span class='cn'>TRUE</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>time_distributed</span><span class='op'>(</span><span class='fu'>layer_dense</span><span class='op'>(</span>units <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>model</span> <span class='op'>%&gt;%</span>
  <span class='fu'>compile</span><span class='op'>(</span>
    loss <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>loss</span>,
    optimizer <span class='op'>=</span> <span class='va'>optimizer</span>,
    <span class='co'># in addition to the loss, Keras will inform us about current </span>
    <span class='co'># MSE while training</span>
    metrics <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='st'>"mean_squared_error"</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='va'>history</span> <span class='op'>&lt;-</span> <span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>fit</span><span class='op'>(</span>
  x          <span class='op'>=</span> <span class='va'>X_train</span>,
  y          <span class='op'>=</span> <span class='va'>y_train</span>,
  validation_data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>X_valid</span>, <span class='va'>y_valid</span><span class='op'>)</span>,
  batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>,
  epochs     <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_epochs</span>,
  callbacks <span class='op'>=</span> <span class='va'>callbacks</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>As we see, training was stopped after ~55 epochs as validation loss did not decrease any more. We also see that performance on the validation set is way worse than performance on the training set - normally indicating overfitting.</p>
<p>This topic too, well leave to a separate discussion another time, but interestingly regularization using higher values of <code>dropout</code> and <code>recurrent_dropout</code> (combined with increasing model capacity) did not yield better generalization performance. This is probably related to the characteristics of this specific time series we mentioned in the introduction.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>history</span>, metrics <span class='op'>=</span> <span class='st'>"loss"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><img src="images/history.png" /></p>
<p>Now lets see how well the model was able to capture the characteristics of the training set.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>pred_train</span> <span class='op'>&lt;-</span> <span class='va'>model</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>X_train</span>, batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='va'>.</span><span class='op'>[</span>, , <span class='fl'>1</span><span class='op'>]</span>

<span class='co'># Retransform values to original scale</span>
<span class='va'>pred_train</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>pred_train</span> <span class='op'>*</span> <span class='va'>scale_history</span> <span class='op'>+</span> <span class='va'>center_history</span><span class='op'>)</span> <span class='op'>^</span><span class='fl'>2</span>
<span class='va'>compare_train</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"training"</span><span class='op'>)</span>

<span class='co'># build a dataframe that has both actual and predicted values</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>pred_train</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>varname</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"pred_train"</span>, <span class='va'>i</span><span class='op'>)</span>
  <span class='va'>compare_train</span> <span class='op'>&lt;-</span>
    <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>compare_train</span>,<span class='op'>!</span><span class='op'>!</span><span class='va'>varname</span> <span class='op'>:=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>i</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>,
      <span class='va'>pred_train</span><span class='op'>[</span><span class='va'>i</span>,<span class='op'>]</span>,
      <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>compare_train</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span>
    <span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>We compute the average RSME over all sequences of predictions.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>coln</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>compare_train</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>compare_train</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>cols</span> <span class='op'>&lt;-</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>coln</span>, <span class='fu'>quo</span><span class='op'>(</span><span class='fu'>sym</span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>rsme_train</span> <span class='op'>&lt;-</span>
  <span class='fu'>map_dbl</span><span class='op'>(</span><span class='va'>cols</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>col</span><span class='op'>)</span>
    <span class='fu'>rmse</span><span class='op'>(</span>
      <span class='va'>compare_train</span>,
      truth <span class='op'>=</span> <span class='va'>value</span>,
      estimate <span class='op'>=</span> <span class='op'>!</span><span class='op'>!</span><span class='va'>col</span>,
      na.rm <span class='op'>=</span> <span class='cn'>TRUE</span>
    <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>rsme_train</span>
</code></pre>
</div>
</div>
<pre><code>21.01495</code></pre>
<p>How do these predictions really look? As a visualization of all predicted sequences would look pretty crowded, we arbitrarily pick start points at regular intervals.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>compare_train</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>index</span>, y <span class='op'>=</span> <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train1</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train50</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train100</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train150</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train200</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train250</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train300</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train350</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train400</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train450</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train500</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train550</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train600</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train650</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train700</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train750</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Predictions on the training set"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/pred_train.png" width="400" /></p>
</div>
<p>This looks pretty good. From the validation loss, we dont quite expect the same from the test set, though.</p>
<p>Lets see.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>pred_test</span> <span class='op'>&lt;-</span> <span class='va'>model</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>X_test</span>, batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='va'>.</span><span class='op'>[</span>, , <span class='fl'>1</span><span class='op'>]</span>

<span class='co'># Retransform values to original scale</span>
<span class='va'>pred_test</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>pred_test</span> <span class='op'>*</span> <span class='va'>scale_history</span> <span class='op'>+</span> <span class='va'>center_history</span><span class='op'>)</span> <span class='op'>^</span><span class='fl'>2</span>
<span class='va'>pred_test</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>10</span>, <span class='fl'>1</span><span class='op'>:</span><span class='fl'>5</span><span class='op'>]</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>compare_test</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"testing"</span><span class='op'>)</span>

<span class='co'># build a dataframe that has both actual and predicted values</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>pred_test</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>varname</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"pred_test"</span>, <span class='va'>i</span><span class='op'>)</span>
  <span class='va'>compare_test</span> <span class='op'>&lt;-</span>
    <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>compare_test</span>,<span class='op'>!</span><span class='op'>!</span><span class='va'>varname</span> <span class='op'>:=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>i</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>,
      <span class='va'>pred_test</span><span class='op'>[</span><span class='va'>i</span>,<span class='op'>]</span>,
      <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>compare_test</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span>
    <span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>compare_test</span> <span class='op'>%&gt;%</span> <span class='fu'>write_csv</span><span class='op'>(</span><span class='fu'>str_replace</span><span class='op'>(</span><span class='va'>model_path</span>, <span class='st'>".hdf5"</span>, <span class='st'>".test.csv"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>compare_test</span><span class='op'>[</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span><span class='op'>:</span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>10</span><span class='op'>)</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2</span>, <span class='fl'>4</span><span class='op'>:</span><span class='fl'>8</span><span class='op'>)</span><span class='op'>]</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>coln</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>compare_test</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>compare_test</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>cols</span> <span class='op'>&lt;-</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>coln</span>, <span class='fu'>quo</span><span class='op'>(</span><span class='fu'>sym</span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>rsme_test</span> <span class='op'>&lt;-</span>
  <span class='fu'>map_dbl</span><span class='op'>(</span><span class='va'>cols</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>col</span><span class='op'>)</span>
    <span class='fu'>rmse</span><span class='op'>(</span>
      <span class='va'>compare_test</span>,
      truth <span class='op'>=</span> <span class='va'>value</span>,
      estimate <span class='op'>=</span> <span class='op'>!</span><span class='op'>!</span><span class='va'>col</span>,
      na.rm <span class='op'>=</span> <span class='cn'>TRUE</span>
    <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>rsme_test</span>
</code></pre>
</div>
</div>
<pre><code>31.31616</code></pre>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>compare_test</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>index</span>, y <span class='op'>=</span> <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test1</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test50</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test100</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test150</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test200</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test250</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test300</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test350</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test400</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test450</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>  
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test500</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test550</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>ggtitle</span><span class='op'>(</span><span class='st'>"Predictions on test set"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/pred_test.png" width="400" /></p>
</div>
<p>Thats not as good as on the training set, but not bad either, given this time series is quite challenging.</p>
<p>Having defined and run our model on a manually chosen example split, lets now revert to our overall re-sampling frame.</p>
<h3 id="backtesting-the-model-on-all-splits">Backtesting the model on all splits</h3>
<p>To obtain predictions on all splits, we move the above code into a function and apply it to all splits. First, heres the function. It returns a list of two dataframes, one for the training and test sets each, that contain the models predictions together with the actual values.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>obtain_predictions</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>split</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>df_trn</span> <span class='op'>&lt;-</span> <span class='fu'>analysis</span><span class='op'>(</span><span class='va'>split</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>800</span>, , drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>
  <span class='va'>df_val</span> <span class='op'>&lt;-</span> <span class='fu'>analysis</span><span class='op'>(</span><span class='va'>split</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>801</span><span class='op'>:</span><span class='fl'>1200</span>, , drop <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>]</span>
  <span class='va'>df_tst</span> <span class='op'>&lt;-</span> <span class='fu'>assessment</span><span class='op'>(</span><span class='va'>split</span><span class='op'>)</span>
  
  <span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'>bind_rows</span><span class='op'>(</span>
    <span class='va'>df_trn</span> <span class='op'>%&gt;%</span> <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"training"</span><span class='op'>)</span>,
    <span class='va'>df_val</span> <span class='op'>%&gt;%</span> <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"validation"</span><span class='op'>)</span>,
    <span class='va'>df_tst</span> <span class='op'>%&gt;%</span> <span class='fu'>add_column</span><span class='op'>(</span>key <span class='op'>=</span> <span class='st'>"testing"</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>as_tbl_time</span><span class='op'>(</span>index <span class='op'>=</span> <span class='va'>index</span><span class='op'>)</span>
  
  <span class='va'>rec_obj</span> <span class='op'>&lt;-</span> <span class='fu'>recipe</span><span class='op'>(</span><span class='va'>value</span> <span class='op'>~</span> <span class='va'>.</span>, <span class='va'>df</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>step_sqrt</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>step_center</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>step_scale</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>prep</span><span class='op'>(</span><span class='op'>)</span>
  
  <span class='va'>df_processed_tbl</span> <span class='op'>&lt;-</span> <span class='fu'>bake</span><span class='op'>(</span><span class='va'>rec_obj</span>, <span class='va'>df</span><span class='op'>)</span>
  
  <span class='va'>center_history</span> <span class='op'>&lt;-</span> <span class='va'>rec_obj</span><span class='op'>$</span><span class='va'>steps</span><span class='op'>[[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span><span class='op'>$</span><span class='va'>means</span><span class='op'>[</span><span class='st'>"value"</span><span class='op'>]</span>
  <span class='va'>scale_history</span>  <span class='op'>&lt;-</span> <span class='va'>rec_obj</span><span class='op'>$</span><span class='va'>steps</span><span class='op'>[[</span><span class='fl'>3</span><span class='op'>]</span><span class='op'>]</span><span class='op'>$</span><span class='va'>sds</span><span class='op'>[</span><span class='st'>"value"</span><span class='op'>]</span>
  
  <span class='va'>FLAGS</span> <span class='op'>&lt;-</span> <span class='fu'>flags</span><span class='op'>(</span>
    <span class='fu'>flag_boolean</span><span class='op'>(</span><span class='st'>"stateful"</span>, <span class='cn'>FALSE</span><span class='op'>)</span>,
    <span class='fu'>flag_boolean</span><span class='op'>(</span><span class='st'>"stack_layers"</span>, <span class='cn'>FALSE</span><span class='op'>)</span>,
    <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"batch_size"</span>, <span class='fl'>10</span><span class='op'>)</span>,
    <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"n_timesteps"</span>, <span class='fl'>12</span><span class='op'>)</span>,
    <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"n_epochs"</span>, <span class='fl'>100</span><span class='op'>)</span>,
    <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"dropout"</span>, <span class='fl'>0.2</span><span class='op'>)</span>,
    <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"recurrent_dropout"</span>, <span class='fl'>0.2</span><span class='op'>)</span>,
    <span class='fu'>flag_string</span><span class='op'>(</span><span class='st'>"loss"</span>, <span class='st'>"logcosh"</span><span class='op'>)</span>,
    <span class='fu'>flag_string</span><span class='op'>(</span><span class='st'>"optimizer_type"</span>, <span class='st'>"sgd"</span><span class='op'>)</span>,
    <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"n_units"</span>, <span class='fl'>128</span><span class='op'>)</span>,
    <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"lr"</span>, <span class='fl'>0.003</span><span class='op'>)</span>,
    <span class='fu'>flag_numeric</span><span class='op'>(</span><span class='st'>"momentum"</span>, <span class='fl'>0.9</span><span class='op'>)</span>,
    <span class='fu'>flag_integer</span><span class='op'>(</span><span class='st'>"patience"</span>, <span class='fl'>10</span><span class='op'>)</span>
  <span class='op'>)</span>
  
  <span class='va'>n_predictions</span> <span class='op'>&lt;-</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span>
  <span class='va'>n_features</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>
  
  <span class='va'>optimizer</span> <span class='op'>&lt;-</span> <span class='kw'><a href='https://rdrr.io/r/base/switch.html'>switch</a></span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>optimizer_type</span>,
                      sgd <span class='op'>=</span> <span class='fu'>optimizer_sgd</span><span class='op'>(</span>lr <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>lr</span>, momentum <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>momentum</span><span class='op'>)</span><span class='op'>)</span>
  <span class='va'>callbacks</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    <span class='fu'>callback_early_stopping</span><span class='op'>(</span>patience <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>patience</span><span class='op'>)</span>
  <span class='op'>)</span>
  
  <span class='va'>train_vals</span> <span class='op'>&lt;-</span> <span class='va'>df_processed_tbl</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"training"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>select</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>pull</span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>valid_vals</span> <span class='op'>&lt;-</span> <span class='va'>df_processed_tbl</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"validation"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>select</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>pull</span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>test_vals</span> <span class='op'>&lt;-</span> <span class='va'>df_processed_tbl</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"testing"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>select</span><span class='op'>(</span><span class='va'>value</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'>pull</span><span class='op'>(</span><span class='op'>)</span>
  
  <span class='va'>train_matrix</span> <span class='op'>&lt;-</span>
    <span class='fu'>build_matrix</span><span class='op'>(</span><span class='va'>train_vals</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>n_predictions</span><span class='op'>)</span>
  <span class='va'>valid_matrix</span> <span class='op'>&lt;-</span>
    <span class='fu'>build_matrix</span><span class='op'>(</span><span class='va'>valid_vals</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>n_predictions</span><span class='op'>)</span>
  <span class='va'>test_matrix</span> <span class='op'>&lt;-</span>
    <span class='fu'>build_matrix</span><span class='op'>(</span><span class='va'>test_vals</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>n_predictions</span><span class='op'>)</span>
  
  <span class='va'>X_train</span> <span class='op'>&lt;-</span> <span class='va'>train_matrix</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>:</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span><span class='op'>]</span>
  <span class='va'>y_train</span> <span class='op'>&lt;-</span>
    <span class='va'>train_matrix</span><span class='op'>[</span>, <span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>
  <span class='va'>X_train</span> <span class='op'>&lt;-</span>
    <span class='va'>X_train</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_train</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span>,<span class='op'>]</span>
  <span class='va'>y_train</span> <span class='op'>&lt;-</span>
    <span class='va'>y_train</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>y_train</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span>,<span class='op'>]</span>
  
  <span class='va'>X_valid</span> <span class='op'>&lt;-</span> <span class='va'>valid_matrix</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>:</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span><span class='op'>]</span>
  <span class='va'>y_valid</span> <span class='op'>&lt;-</span>
    <span class='va'>valid_matrix</span><span class='op'>[</span>, <span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>
  <span class='va'>X_valid</span> <span class='op'>&lt;-</span>
    <span class='va'>X_valid</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_valid</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span>,<span class='op'>]</span>
  <span class='va'>y_valid</span> <span class='op'>&lt;-</span>
    <span class='va'>y_valid</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>y_valid</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span>,<span class='op'>]</span>
  
  <span class='va'>X_test</span> <span class='op'>&lt;-</span> <span class='va'>test_matrix</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>:</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span><span class='op'>]</span>
  <span class='va'>y_test</span> <span class='op'>&lt;-</span>
    <span class='va'>test_matrix</span><span class='op'>[</span>, <span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>]</span>
  <span class='va'>X_test</span> <span class='op'>&lt;-</span>
    <span class='va'>X_test</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_test</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span>,<span class='op'>]</span>
  <span class='va'>y_test</span> <span class='op'>&lt;-</span>
    <span class='va'>y_test</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>y_test</span><span class='op'>)</span> <span class='op'>%/%</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span> <span class='op'>*</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span>,<span class='op'>]</span>
  
  <span class='va'>X_train</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>X_train</span><span class='op'>)</span>
  <span class='va'>X_valid</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>X_valid</span><span class='op'>)</span>
  <span class='va'>X_test</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>X_test</span><span class='op'>)</span>
  
  <span class='va'>y_train</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>y_train</span><span class='op'>)</span>
  <span class='va'>y_valid</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>y_valid</span><span class='op'>)</span>
  <span class='va'>y_test</span> <span class='op'>&lt;-</span> <span class='fu'>reshape_X_3d</span><span class='op'>(</span><span class='va'>y_test</span><span class='op'>)</span>
  
  <span class='va'>model</span> <span class='op'>&lt;-</span> <span class='fu'>keras_model_sequential</span><span class='op'>(</span><span class='op'>)</span>
  
  <span class='va'>model</span> <span class='op'>%&gt;%</span>
    <span class='fu'>layer_lstm</span><span class='op'>(</span>
      units            <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_units</span>,
      batch_input_shape  <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span>, <span class='va'>n_features</span><span class='op'>)</span>,
      dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>dropout</span>,
      recurrent_dropout <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>recurrent_dropout</span>,
      return_sequences <span class='op'>=</span> <span class='cn'>TRUE</span>
    <span class='op'>)</span>     <span class='op'>%&gt;%</span> <span class='fu'>time_distributed</span><span class='op'>(</span><span class='fu'>layer_dense</span><span class='op'>(</span>units <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>
  
  <span class='va'>model</span> <span class='op'>%&gt;%</span>
    <span class='fu'>compile</span><span class='op'>(</span>
      loss <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>loss</span>,
      optimizer <span class='op'>=</span> <span class='va'>optimizer</span>,
      metrics <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='st'>"mean_squared_error"</span><span class='op'>)</span>
    <span class='op'>)</span>
  
  <span class='va'>model</span> <span class='op'>%&gt;%</span> <span class='fu'>fit</span><span class='op'>(</span>
    x          <span class='op'>=</span> <span class='va'>X_train</span>,
    y          <span class='op'>=</span> <span class='va'>y_train</span>,
    validation_data <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>X_valid</span>, <span class='va'>y_valid</span><span class='op'>)</span>,
    batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span>,
    epochs     <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_epochs</span>,
    callbacks <span class='op'>=</span> <span class='va'>callbacks</span>
  <span class='op'>)</span>
  
  
  <span class='va'>pred_train</span> <span class='op'>&lt;-</span> <span class='va'>model</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>X_train</span>, batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='va'>.</span><span class='op'>[</span>, , <span class='fl'>1</span><span class='op'>]</span>
  
  <span class='co'># Retransform values</span>
  <span class='va'>pred_train</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>pred_train</span> <span class='op'>*</span> <span class='va'>scale_history</span> <span class='op'>+</span> <span class='va'>center_history</span><span class='op'>)</span> <span class='op'>^</span> <span class='fl'>2</span>
  <span class='va'>compare_train</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"training"</span><span class='op'>)</span>
  
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>pred_train</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>varname</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"pred_train"</span>, <span class='va'>i</span><span class='op'>)</span>
    <span class='va'>compare_train</span> <span class='op'>&lt;-</span>
      <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>compare_train</span>, <span class='op'>!</span><span class='op'>!</span><span class='va'>varname</span> <span class='op'>:=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
        <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>i</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>,
        <span class='va'>pred_train</span><span class='op'>[</span><span class='va'>i</span>, <span class='op'>]</span>,
        <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>compare_train</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span>
      <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>}</span>
  
  <span class='va'>pred_test</span> <span class='op'>&lt;-</span> <span class='va'>model</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>X_test</span>, batch_size <span class='op'>=</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>batch_size</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='va'>.</span><span class='op'>[</span>, , <span class='fl'>1</span><span class='op'>]</span>
  
  <span class='co'># Retransform values</span>
  <span class='va'>pred_test</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='va'>pred_test</span> <span class='op'>*</span> <span class='va'>scale_history</span> <span class='op'>+</span> <span class='va'>center_history</span><span class='op'>)</span> <span class='op'>^</span> <span class='fl'>2</span>
  <span class='va'>compare_test</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/stats/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>key</span> <span class='op'>==</span> <span class='st'>"testing"</span><span class='op'>)</span>
  
  <span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>pred_test</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>varname</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"pred_test"</span>, <span class='va'>i</span><span class='op'>)</span>
    <span class='va'>compare_test</span> <span class='op'>&lt;-</span>
      <span class='fu'>mutate</span><span class='op'>(</span><span class='va'>compare_test</span>, <span class='op'>!</span><span class='op'>!</span><span class='va'>varname</span> <span class='op'>:=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
        <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='va'>i</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>,
        <span class='va'>pred_test</span><span class='op'>[</span><span class='va'>i</span>, <span class='op'>]</span>,
        <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>compare_test</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>FLAGS</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span>
      <span class='op'>)</span><span class='op'>)</span>
  <span class='op'>}</span>
  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>train <span class='op'>=</span> <span class='va'>compare_train</span>, test <span class='op'>=</span> <span class='va'>compare_test</span><span class='op'>)</span>
  
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Mapping the function over all splits yields a list of predictions.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all_split_preds</span> <span class='op'>&lt;-</span> <span class='va'>rolling_origin_resamples</span> <span class='op'>%&gt;%</span>
     <span class='fu'>mutate</span><span class='op'>(</span>predict <span class='op'>=</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>splits</span>, <span class='va'>obtain_predictions</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Calculate RMSE on all splits:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>calc_rmse</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>coln</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>4</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span><span class='op'>]</span>
  <span class='va'>cols</span> <span class='op'>&lt;-</span> <span class='fu'>map</span><span class='op'>(</span><span class='va'>coln</span>, <span class='fu'>quo</span><span class='op'>(</span><span class='fu'>sym</span><span class='op'>(</span><span class='va'>.</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
  <span class='fu'>map_dbl</span><span class='op'>(</span><span class='va'>cols</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>col</span><span class='op'>)</span>
    <span class='fu'>rmse</span><span class='op'>(</span>
      <span class='va'>df</span>,
      truth <span class='op'>=</span> <span class='va'>value</span>,
      estimate <span class='op'>=</span> <span class='op'>!</span><span class='op'>!</span><span class='va'>col</span>,
      na.rm <span class='op'>=</span> <span class='cn'>TRUE</span>
    <span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>all_split_preds</span> <span class='op'>&lt;-</span> <span class='va'>all_split_preds</span> <span class='op'>%&gt;%</span> <span class='fu'>unnest</span><span class='op'>(</span><span class='va'>predict</span><span class='op'>)</span>
<span class='va'>all_split_preds_train</span> <span class='op'>&lt;-</span> <span class='va'>all_split_preds</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>11</span>, by <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>all_split_preds_test</span> <span class='op'>&lt;-</span> <span class='va'>all_split_preds</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>2</span>, <span class='fl'>12</span>, by <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>, <span class='op'>]</span>

<span class='va'>all_split_rmses_train</span> <span class='op'>&lt;-</span> <span class='va'>all_split_preds_train</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>rmse <span class='op'>=</span> <span class='fu'>map_dbl</span><span class='op'>(</span><span class='va'>predict</span>, <span class='va'>calc_rmse</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>rmse</span><span class='op'>)</span>

<span class='va'>all_split_rmses_test</span> <span class='op'>&lt;-</span> <span class='va'>all_split_preds_test</span> <span class='op'>%&gt;%</span>
  <span class='fu'>mutate</span><span class='op'>(</span>rmse <span class='op'>=</span> <span class='fu'>map_dbl</span><span class='op'>(</span><span class='va'>predict</span>, <span class='va'>calc_rmse</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>select</span><span class='op'>(</span><span class='va'>id</span>, <span class='va'>rmse</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>How does it look? Heres RMSE on the training set for the 6 splits.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all_split_rmses_train</span>
</code></pre>
</div>
</div>
<pre><code># A tibble: 6 x 2
  id      rmse
  &lt;chr&gt;  &lt;dbl&gt;
1 Slice1  22.2
2 Slice2  20.9
3 Slice3  18.8
4 Slice4  23.5
5 Slice5  22.1
6 Slice6  21.1</code></pre>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>all_split_rmses_test</span>
</code></pre>
</div>
</div>
<pre><code># A tibble: 6 x 2
  id      rmse
  &lt;chr&gt;  &lt;dbl&gt;
1 Slice1  21.6
2 Slice2  20.6
3 Slice3  21.3
4 Slice4  31.4
5 Slice5  35.2
6 Slice6  31.4</code></pre>
<p>Looking at these numbers, we see something interesting: Generalization performance is much better for the first three slices of the time series than for the latter ones. This confirms our impression, stated above, that there seems to be some hidden development going on, rendering forecasting more difficult.</p>
<p>And here are visualizations of the predictions on the respective training and test sets.</p>
<p>First, the training sets:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>plot_train</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>slice</span>, <span class='va'>name</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>slice</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>index</span>, y <span class='op'>=</span> <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train1</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train50</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train100</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train150</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train200</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train250</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train300</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train350</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train400</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train450</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train500</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train550</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train600</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train650</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train700</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_train750</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ggtitle</span><span class='op'>(</span><span class='va'>name</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>train_plots</span> <span class='op'>&lt;-</span> <span class='fu'>map2</span><span class='op'>(</span><span class='va'>all_split_preds_train</span><span class='op'>$</span><span class='va'>predict</span>, <span class='va'>all_split_preds_train</span><span class='op'>$</span><span class='va'>id</span>, <span class='va'>plot_train</span><span class='op'>)</span>
<span class='va'>p_body_train</span>  <span class='op'>&lt;-</span> <span class='fu'>plot_grid</span><span class='op'>(</span>plotlist <span class='op'>=</span> <span class='va'>train_plots</span>, ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
<span class='va'>p_title_train</span> <span class='op'>&lt;-</span> <span class='fu'>ggdraw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>draw_label</span><span class='op'>(</span><span class='st'>"Backtested Predictions: Training Sets"</span>, size <span class='op'>=</span> <span class='fl'>18</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span><span class='op'>)</span>

<span class='fu'>plot_grid</span><span class='op'>(</span><span class='va'>p_title_train</span>, <span class='va'>p_body_train</span>, ncol <span class='op'>=</span> <span class='fl'>1</span>, rel_heights <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.05</span>, <span class='fl'>1</span>, <span class='fl'>0.05</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><br/></p>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/backtested_train.png" width="400" /></p>
</div>
<p>And the test sets:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>plot_test</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>slice</span>, <span class='va'>name</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'>ggplot</span><span class='op'>(</span><span class='va'>slice</span>, <span class='fu'>aes</span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>index</span>, y <span class='op'>=</span> <span class='va'>value</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span> <span class='fu'>geom_line</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test1</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test50</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test100</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test150</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test200</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test250</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test300</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test350</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test400</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"red"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test450</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"green"</span><span class='op'>)</span> <span class='op'>+</span>  
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test500</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"cyan"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>geom_line</span><span class='op'>(</span><span class='fu'>aes</span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred_test550</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"violet"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>ggtitle</span><span class='op'>(</span><span class='va'>name</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>test_plots</span> <span class='op'>&lt;-</span> <span class='fu'>map2</span><span class='op'>(</span><span class='va'>all_split_preds_test</span><span class='op'>$</span><span class='va'>predict</span>, <span class='va'>all_split_preds_test</span><span class='op'>$</span><span class='va'>id</span>, <span class='va'>plot_test</span><span class='op'>)</span>

<span class='va'>p_body_test</span>  <span class='op'>&lt;-</span> <span class='fu'>plot_grid</span><span class='op'>(</span>plotlist <span class='op'>=</span> <span class='va'>test_plots</span>, ncol <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span>
<span class='va'>p_title_test</span> <span class='op'>&lt;-</span> <span class='fu'>ggdraw</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'>draw_label</span><span class='op'>(</span><span class='st'>"Backtested Predictions: Test Sets"</span>, size <span class='op'>=</span> <span class='fl'>18</span>, fontface <span class='op'>=</span> <span class='st'>"bold"</span><span class='op'>)</span>

<span class='fu'>plot_grid</span><span class='op'>(</span><span class='va'>p_title_test</span>, <span class='va'>p_body_test</span>, ncol <span class='op'>=</span> <span class='fl'>1</span>, rel_heights <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.05</span>, <span class='fl'>1</span>, <span class='fl'>0.05</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p><br/></p>
<div class="layout-chunk" data-layout="l-body-outset">
<p><img src="images/backtested_test.png" width="400" /></p>
</div>
<p>This has been a long post, and necessarily will have left a lot of questions open, first and foremost: How do we obtain good settings for the hyperparameters (learning rate, number of epochs, dropout)? How do we choose the length of the hidden state? Or even, can we have an intuition how well LSTM will perform on a given dataset (with its specific characteristics)? We will tackle questions like the above in upcoming posts.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<!--radix_placeholder_article_footer-->
<div class="article-footer">
  <p class="social_footer">
    <span class="disqus-comments">
      <i class="fas fa-comments"></i>
      &nbsp;
      <span class="disqus-comment-count" data-disqus-identifier="posts/2018-06-25-sunspots-lstm/">Comment on this article</span>
    </span>
    <span class="article-sharing">
      Share: &nbsp;
      <a href="https://twitter.com/share?text=Predicting%20Sunspot%20Frequency%20with%20Keras&amp;url=https%3A%2F%2Fblogs.rstudio.com%2Ftensorflow%2Fposts%2F2018-06-25-sunspots-lstm%2F">
        <i class="fab fa-twitter"></i>
      </a>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblogs.rstudio.com%2Ftensorflow%2Fposts%2F2018-06-25-sunspots-lstm%2F&amp;title=Predicting%20Sunspot%20Frequency%20with%20Keras">
        <i class="fab fa-linkedin"></i>
      </a>
    </span>
  </p>
  <script id="dsq-count-scr" src="https://tensorflow-for-r-blog.disqus.com/count.js" async></script>
  <div id="disqus_thread" class="hidden"></div>
  <script type="text/javascript" cookie-consent="functionality">
var disqus_config = function () {
  this.page.url = 'https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/';
  this.page.identifier = 'posts/2018-06-25-sunspots-lstm/';
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://tensorflow-for-r-blog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
  <p>
    <div class="subscribe">
<div id="subscribe-caption" style="line-height: 1.2; margin-bottom: 2px;">Enjoy this blog? Get notified of new posts by email:</div>

<script src="https://app-ab02.marketo.com/js/forms2/js/forms2.min.js"></script>
<form class="mtktoBlogEmailForm" id="mktoForm_2224"></form>
<script>

// establish metrics based on where the form is located
var in_sidebar = $('#subscribe-caption').parents('.sidebar-section').length;
if (in_sidebar) {
  var form_width = 190;
  var base_width = form_width - 23;
  var email_width = base_width + 'px';
  var label_width = (base_width - 20) + 'px';
  var button_width = email_width;
  var button_padding = '30px';
  var button_margin = '';
  var font_size = '12px';
} else {
  var form_width = 400;
  var base_width = form_width - 23;
  var email_width = base_width + 'px';
  var label_width = (base_width - 20) + 'px';
  var button_width = email_width;
  var button_padding = '30px';
  var button_margin = '12px';
  var font_size = '15px';
}

$('#subscribe-caption')
  .css('width', base_width)
  .css('font-size', font_size);


MktoForms2.loadForm("https://app-ab02.marketo.com", "709-NXN-706", 2224, function(form) {

  // get jquery reference to form
  form = $(form.getFormElem().get(0));

  $(form).css('width', form_width + 'px');
  $(form).find('.mktoOffset').remove();
  $(form).find('.mktoGutter').remove();
  $(form).find('.mktoEmailField').css('width', email_width);
  $(form).find('.mktoLabel').children().attr('style', 'font-weight: 400');
  $(form).find('.mktoLabel')
      .css('width', label_width)
      .css('font-size', font_size);
  $(form).find('.mktoButtonRow')
      .css('width', button_width)
      .css('text-align', 'center');
  $(form).find('.mktoButtonWrap').attr('style', '');
  $(form).find('.mktoButton')
      .css('margin-top', '10px')
      .css('padding-left', button_padding)
      .css('padding-right', button_padding)
      .css('font-size', font_size)
      .css('margin-top', button_margin);
});
</script>
Posts also available at <a href="https://www.r-bloggers.com">r-bloggers</a>

<script>
  document.addEventListener("DOMContentLoaded", function(){
    var menulink = document.querySelector("a[href='#category:R']");
    if (menulink) menulink.parentNode.style.display = "None";
    
    for (var e of document.querySelectorAll(".dt-tag")) {
      if (e.innerHTML == 'R') e.style.display = "None";
    }
  });
</script>
</div>
  </p>
</div>
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>


<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">Dancho &amp; Keydana (2018, June 25). RStudio AI Blog: Predicting Sunspot Frequency with Keras. Retrieved from https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{dancho2018predicting,
  author = {Dancho, Matt and Keydana, Sigrid},
  title = {RStudio AI Blog: Predicting Sunspot Frequency with Keras},
  url = {https://blogs.rstudio.com/tensorflow/posts/2018-06-25-sunspots-lstm/},
  year = {2018}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
