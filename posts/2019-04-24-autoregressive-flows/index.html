<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #545454; font-weight: bold; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #a1024a; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007faa; font-weight: bold; } /* ControlFlow */
code span.ch { color: #008000; } /* Char */
code span.cn { color: #d91e18; } /* Constant */
code span.co { color: #545454; } /* Comment */
code span.cv { color: #545454; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #aa5d00; } /* DataType */
code span.dv { color: #a1024a; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #a1024a; } /* Float */
code span.fu { color: #4254a7; } /* Function */
code span.im { } /* Import */
code span.in { color: #545454; font-weight: bold; } /* Information */
code span.kw { color: #007faa; font-weight: bold; } /* Keyword */
code span.op { color: #696969; } /* Operator */
code span.ot { color: #007faa; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #008000; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #008000; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #008000; } /* VerbatimString */
code span.wa { color: #545454; font-weight: bold; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
<title>RStudio AI Blog: Experimenting with autoregressive flows in TensorFlow Probability</title>

<meta property="description" itemprop="description" content="Continuing from the recent introduction to bijectors in TensorFlow Probability (TFP), this post brings autoregressivity to the table. Using TFP through the new R package tfprobability, we look at the implementation of masked autoregressive flows (MAF) and put them to use on two different datasets."/>

<link rel="canonical" href="https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/"/>
<link rel="license" href="https://creativecommons.org/licenses/by/4.0/"/>
<link rel="icon" type="image/png" href="../../images/favicon.png"/>

<!--  https://schema.org/Article -->
<meta property="article:published" itemprop="datePublished" content="2019-04-24"/>
<meta property="article:created" itemprop="dateCreated" content="2019-04-24"/>
<meta name="article:author" content="Sigrid Keydana"/>

<!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
<meta property="og:title" content="RStudio AI Blog: Experimenting with autoregressive flows in TensorFlow Probability"/>
<meta property="og:type" content="article"/>
<meta property="og:description" content="Continuing from the recent introduction to bijectors in TensorFlow Probability (TFP), this post brings autoregressivity to the table. Using TFP through the new R package tfprobability, we look at the implementation of masked autoregressive flows (MAF) and put them to use on two different datasets."/>
<meta property="og:url" content="https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/"/>
<meta property="og:image" content="https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/images/made.png"/>
<meta property="og:image:width" content="686"/>
<meta property="og:image:height" content="398"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:site_name" content="RStudio AI Blog"/>

<!--  https://dev.twitter.com/cards/types/summary -->
<meta property="twitter:card" content="summary_large_image"/>
<meta property="twitter:title" content="RStudio AI Blog: Experimenting with autoregressive flows in TensorFlow Probability"/>
<meta property="twitter:description" content="Continuing from the recent introduction to bijectors in TensorFlow Probability (TFP), this post brings autoregressivity to the table. Using TFP through the new R package tfprobability, we look at the implementation of masked autoregressive flows (MAF) and put them to use on two different datasets."/>
<meta property="twitter:url" content="https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/"/>
<meta property="twitter:image" content="https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/images/made.png"/>
<meta property="twitter:image:width" content="686"/>
<meta property="twitter:image:height" content="398"/>

<!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
<meta name="citation_title" content="RStudio AI Blog: Experimenting with autoregressive flows in TensorFlow Probability"/>
<meta name="citation_fulltext_html_url" content="https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/"/>
<meta name="citation_fulltext_world_readable" content=""/>
<meta name="citation_online_date" content="2019/04/24"/>
<meta name="citation_publication_date" content="2019/04/24"/>
<meta name="citation_author" content="Sigrid Keydana"/>
<meta name="citation_author_institution" content="RStudio"/>
<!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Masked Autoregressive Flow for Density Estimation;citation_publication_date=2017;citation_author=George Papamakarios;citation_author=Theo Pavlakou;citation_author=Iain Murray"/>
  <meta name="citation_reference" content="citation_title=Conditional Image Generation with PixelCNN Decoders;citation_publication_date=2016;citation_volume=abs/1606.05328;citation_author=Aaron Oord;citation_author=Nal Kalchbrenner;citation_author=Oriol Vinyals;citation_author=Lasse Espeholt;citation_author=Alex Graves;citation_author=Koray Kavukcuoglu"/>
  <meta name="citation_reference" content="citation_title=Density estimation using Real NVP;citation_publication_date=2016;citation_volume=abs/1605.08803;citation_author=Laurent Dinh;citation_author=Jascha Sohl-Dickstein;citation_author=Samy Bengio"/>
  <meta name="citation_reference" content="citation_title=PixelCNN++: Improving the PixelCNN with Discretized Logistic Mixture Likelihood and Other Modifications;citation_publication_date=2017;citation_volume=abs/1701.05517;citation_author=Tim Salimans;citation_author=Andrej Karpathy;citation_author=Xi Chen;citation_author=Diederik P. Kingma"/>
  <meta name="citation_reference" content="citation_title=PixelSNAIL: An Improved Autoregressive Generative Model;citation_publication_date=2017;citation_volume=abs/1712.09763;citation_author=Xi Chen;citation_author=Nikhil Mishra;citation_author=Mostafa Rohaninejad;citation_author=Pieter Abbeel"/>
  <meta name="citation_reference" content="citation_title=Image Transformer;citation_publication_date=2018;citation_volume=abs/1802.05751;citation_author=Niki Parmar;citation_author=Ashish Vaswani;citation_author=Jakob Uszkoreit;citation_author=Lukasz Kaiser;citation_author=Noam Shazeer;citation_author=Alexander Ku"/>
  <meta name="citation_reference" content="citation_title=MADE: Masked Autoencoder for Distribution Estimation;citation_publication_date=2015;citation_volume=abs/1502.03509;citation_author=Mathieu Germain;citation_author=Karol Gregor;citation_author=Iain Murray;citation_author=Hugo Larochelle"/>
  <!--radix_placeholder_rmarkdown_metadata-->

<script type="text/json" id="radix-rmarkdown-metadata">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["creative_commons","title","description","author","slug","date","categories","bibliography","output","preview","citation_url","canonical_url"]}},"value":[{"type":"character","attributes":{},"value":["CC BY"]},{"type":"character","attributes":{},"value":["Experimenting with autoregressive flows in TensorFlow Probability"]},{"type":"character","attributes":{},"value":["Continuing from the recent introduction to bijectors in TensorFlow Probability (TFP), this post brings autoregressivity to the table. Using TFP through the new R package tfprobability, we look at the implementation of masked autoregressive flows (MAF) and put them to use on two different datasets."]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","affiliation","affiliation_url"]}},"value":[{"type":"character","attributes":{},"value":["Sigrid Keydana"]},{"type":"character","attributes":{},"value":["RStudio"]},{"type":"character","attributes":{},"value":["https://www.rstudio.com/"]}]}]},{"type":"character","attributes":{},"value":["keydana2019autoregressive"]},{"type":"character","attributes":{},"value":["04-24-2019"]},{"type":"character","attributes":{},"value":["Probabilistic ML/DL","Unsupervised Learning","TensorFlow/Keras"]},{"type":"character","attributes":{},"value":["bibliography.bib"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained"]}},"value":[{"type":"logical","attributes":{},"value":[false]}]}]},{"type":"character","attributes":{},"value":["images/made.png"]},{"type":"character","attributes":{},"value":["https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/"]},{"type":"character","attributes":{},"value":["https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/"]}]}
</script>
<!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["bibliography.bib","experimenting-with-autoregressive-flows_files/bowser-1.9.3/bowser.min.js","experimenting-with-autoregressive-flows_files/distill-2.2.21/template.v2.js","experimenting-with-autoregressive-flows_files/jquery-1.11.3/jquery.min.js","experimenting-with-autoregressive-flows_files/webcomponents-2.0.0/webcomponents.js","images/made.png","images/maf_results.png"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
<meta name="distill:offset" content="../.."/>

<script type="application/javascript">

  window.headroom_prevent_pin = false;

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // initialize headroom for banner
    var header = $('header').get(0);
    var headerHeight = header.offsetHeight;
    var headroom = new Headroom(header, {
      onPin : function() {
        if (window.headroom_prevent_pin) {
          window.headroom_prevent_pin = false;
          headroom.unpin();
        }
      }
    });
    headroom.init();
    if(window.location.hash)
      headroom.unpin();
    $(header).addClass('headroom--transition');

    // offset scroll location for banner on hash change
    // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
    window.addEventListener("hashchange", function(event) {
      window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
    });

    // responsive menu
    $('.distill-site-header').each(function(i, val) {
      var topnav = $(this);
      var toggle = topnav.find('.nav-toggle');
      toggle.on('click', function() {
        topnav.toggleClass('responsive');
      });
    });

    // nav dropdowns
    $('.nav-dropbtn').click(function(e) {
      $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
      $(this).parent().siblings('.nav-dropdown')
         .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $("body").click(function(e){
      $('.nav-dropdown-content').removeClass('nav-dropdown-active');
    });
    $(".nav-dropdown").click(function(e){
      e.stopPropagation();
    });
  });
</script>

<style type="text/css">

/* Theme (user-documented overrideables for nav appearance) */

.distill-site-nav {
  color: rgba(255, 255, 255, 0.8);
  background-color: #0F2E3D;
  font-size: 15px;
  font-weight: 300;
}

.distill-site-nav a {
  color: inherit;
  text-decoration: none;
}

.distill-site-nav a:hover {
  color: white;
}

@media print {
  .distill-site-nav {
    display: none;
  }
}

.distill-site-header {

}

.distill-site-footer {

}


/* Site Header */

.distill-site-header {
  width: 100%;
  box-sizing: border-box;
  z-index: 3;
}

.distill-site-header .nav-left {
  display: inline-block;
  margin-left: 8px;
}

@media screen and (max-width: 768px) {
  .distill-site-header .nav-left {
    margin-left: 0;
  }
}


.distill-site-header .nav-right {
  float: right;
  margin-right: 8px;
}

.distill-site-header a,
.distill-site-header .title {
  display: inline-block;
  text-align: center;
  padding: 14px 10px 14px 10px;
}

.distill-site-header .title {
  font-size: 18px;
  min-width: 150px;
}

.distill-site-header .logo {
  padding: 0;
}

.distill-site-header .logo img {
  display: none;
  max-height: 20px;
  width: auto;
  margin-bottom: -4px;
}

.distill-site-header .nav-image img {
  max-height: 18px;
  width: auto;
  display: inline-block;
  margin-bottom: -3px;
}



@media screen and (min-width: 1000px) {
  .distill-site-header .logo img {
    display: inline-block;
  }
  .distill-site-header .nav-left {
    margin-left: 20px;
  }
  .distill-site-header .nav-right {
    margin-right: 20px;
  }
  .distill-site-header .title {
    padding-left: 12px;
  }
}


.distill-site-header .nav-toggle {
  display: none;
}

.nav-dropdown {
  display: inline-block;
  position: relative;
}

.nav-dropdown .nav-dropbtn {
  border: none;
  outline: none;
  color: rgba(255, 255, 255, 0.8);
  padding: 16px 10px;
  background-color: transparent;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  margin: 0;
  margin-top: 1px;
  z-index: 2;
}

.nav-dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 200px;
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 4px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
  z-index: 1;
  margin-top: 2px;
  white-space: nowrap;
  padding-top: 4px;
  padding-bottom: 4px;
}

.nav-dropdown-content hr {
  margin-top: 4px;
  margin-bottom: 4px;
  border: none;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.nav-dropdown-active {
  display: block;
}

.nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
  color: black;
  padding: 6px 24px;
  text-decoration: none;
  display: block;
  text-align: left;
}

.nav-dropdown-content .nav-dropdown-header {
  display: block;
  padding: 5px 24px;
  padding-bottom: 0;
  text-transform: uppercase;
  font-size: 14px;
  color: #999999;
  white-space: nowrap;
}

.nav-dropdown:hover .nav-dropbtn {
  color: white;
}

.nav-dropdown-content a:hover {
  background-color: #ddd;
  color: black;
}

.nav-right .nav-dropdown-content {
  margin-left: -45%;
  right: 0;
}

@media screen and (max-width: 768px) {
  .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
  .distill-site-header a.nav-toggle {
    float: right;
    display: block;
  }
  .distill-site-header .title {
    margin-left: 0;
  }
  .distill-site-header .nav-right {
    margin-right: 0;
  }
  .distill-site-header {
    overflow: hidden;
  }
  .nav-right .nav-dropdown-content {
    margin-left: 0;
  }
}


@media screen and (max-width: 768px) {
  .distill-site-header.responsive {position: relative; min-height: 500px; }
  .distill-site-header.responsive a.nav-toggle {
    position: absolute;
    right: 0;
    top: 0;
  }
  .distill-site-header.responsive a,
  .distill-site-header.responsive .nav-dropdown {
    display: block;
    text-align: left;
  }
  .distill-site-header.responsive .nav-left,
  .distill-site-header.responsive .nav-right {
    width: 100%;
  }
  .distill-site-header.responsive .nav-dropdown {float: none;}
  .distill-site-header.responsive .nav-dropdown-content {position: relative;}
  .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
    display: block;
    width: 100%;
    text-align: left;
  }
}

/* Site Footer */

.distill-site-footer {
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 3;
  margin-top: 30px;
  padding-top: 30px;
  padding-bottom: 30px;
  text-align: center;
}

/* Headroom */

d-title {
  padding-top: 6rem;
}

@media print {
  d-title {
    padding-top: 4rem;
  }
}

.headroom {
  z-index: 1000;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
}

.headroom--transition {
  transition: all .4s ease-in-out;
}

.headroom--unpinned {
  top: -100px;
}

.headroom--pinned {
  top: 0;
}

</style>

<link href="../../site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
<link href="../../site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
<script src="../../site_libs/headroom-0.9.4/headroom.min.js"></script>
<script src="../../site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
<script src="../../site_libs/fuse-6.4.1/fuse.min.js"></script>

<script type="application/javascript">

function getMeta(metaName) {
  var metas = document.getElementsByTagName('meta');
  for (let i = 0; i < metas.length; i++) {
    if (metas[i].getAttribute('name') === metaName) {
      return metas[i].getAttribute('content');
    }
  }
  return '';
}

function offsetURL(url) {
  var offset = getMeta('distill:offset');
  return offset ? offset + '/' + url : url;
}

function createIndex() {
  var options = {
    keys: [
      "title",
      "categories",
      "description",
      "contents"
    ]
  };
  return new window.Fuse([],options);
}

function createFuseIndex() {

  // create fuse index
  var options = { keys: ["title", "description", "contents"] };
  var fuse = new window.Fuse([], options);

  // fetch the main search.json
  return fetch(offsetURL('search.json'))
    .then(function(response) {
      if (response.status == 200) {
        return response.json().then(function(json) {
          // index main articles
          json.articles.forEach(function(article) {
            fuse.add(article);
          });
          // download collections and index their articles
          return Promise.all(json.collections.map(function(collection) {
            return fetch(offsetURL(collection)).then(function(response) {
              if (response.status === 200) {
                return response.json().then(function(articles) {
                  articles.forEach(function(article) {
                    fuse.add(article);
                  });
                })
              } else {
                return Promise.reject(
                  new Error('Unexpected status from search index request: ' +
                            response.status)
                );
              }
            });
          })).then(function() {
            return fuse;
          });
        });

      } else {
        return Promise.reject(
          new Error('Unexpected status from search index request: ' +
                      response.status)
        );
      }
    });
}

window.document.addEventListener("DOMContentLoaded", function (event) {

  // get search element (bail if we don't have one)
  var searchEl = window.document.getElementById('distill-search');
  if (!searchEl)
    return;

  createFuseIndex()
    .then(function(fuse) {

      // make search box visible
      searchEl.classList.remove('hidden');

      // initialize autocomplete
      var options = {
        autoselect: true,
        hint: false,
        minLength: 2,
      };
      window.autocomplete(searchEl, options, [{
        source: function(query, callback) {
          const searchOptions = {
            isCaseSensitive: false,
            shouldSort: true,
            minMatchCharLength: 2,
            limit: 10,
            keys: [
              { name: 'title', weight: 20 },
              { name: 'categories', weight: 15 },
              { name: 'description', weight: 10 },
              { name: 'contents', weight: 5 },
            ],
          };
          var results = fuse.search(query, searchOptions);
          callback(results
            .map(function(result) { return result.item; })
            .filter(function(item) { return !!item.description; })
          );
        },
        templates: {
          suggestion: function(suggestion) {
            var html = `
              <div class="search-item">
                <h3>${suggestion.title}</h3>
                <div class="search-item-description">
                  ${suggestion.description}
                </div>
                <div class="search-item-preview">
                  <img src="${suggestion.preview ? offsetURL(suggestion.preview) : ''}"</img>
                </div>
              </div>
            `;
            return html;
          }
        }
      }]).on('autocomplete:selected', function(event, suggestion) {
        window.location.href = offsetURL(suggestion.path);
      });
      // remove inline display style on autocompleter (we want to
      // manage responsive display via css)
      $('.algolia-autocomplete').css("display", "");
    })
    .catch(function(error) {
      console.log(error);
    });

});

</script>

<style type="text/css">

/* Algolioa Autocomplete */

.algolia-autocomplete {
  display: inline-block;
  margin-left: 10px;
  vertical-align: sub;
  background-color: white;
  color: black;
  padding: 6px;
  padding-top: 8px;
  padding-bottom: 0;
  border-radius: 6px;
  border: 1px #0F2E3D solid;
  width: 180px;
}


@media screen and (max-width: 768px) {
  .distill-site-nav .algolia-autocomplete {
    display: none;
    visibility: hidden;
  }
  .distill-site-nav.responsive .algolia-autocomplete {
    display: inline-block;
    visibility: visible;
  }
  .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
    margin-left: 0;
    width: 400px;
    max-height: 400px;
  }
}

.algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
  width: 90%;
  outline: none;
  border: none;
}

.algolia-autocomplete .aa-hint {
  color: #999;
}
.algolia-autocomplete .aa-dropdown-menu {
  width: 550px;
  max-height: 70vh;
  overflow-x: visible;
  overflow-y: scroll;
  padding: 5px;
  margin-top: 3px;
  margin-left: -150px;
  background-color: #fff;
  border-radius: 5px;
  border: 1px solid #999;
  border-top: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
  cursor: pointer;
  padding: 5px 4px;
  border-bottom: 1px solid #eee;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
  border-bottom: none;
  margin-bottom: 2px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
  overflow: hidden;
  font-size: 0.8em;
  line-height: 1.4em;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
  margin-block-start: 0;
  margin-block-end: 5px;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
  display: inline-block;
  overflow: hidden;
  height: 2.8em;
  width: 80%;
  margin-right: 4%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
  display: inline-block;
  width: 15%;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
  height: 3em;
  width: auto;
  display: none;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
  display: initial;
}

.algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
  background-color: #eee;
}
.algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
  font-weight: bold;
  font-style: normal;
}

</style>


<!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

<style type="text/css">

body {
  background-color: white;
}

.pandoc-table {
  width: 100%;
}

.pandoc-table>caption {
  margin-bottom: 10px;
}

.pandoc-table th:not([align]) {
  text-align: left;
}

.pagedtable-footer {
  font-size: 15px;
}

d-byline .byline {
  grid-template-columns: 2fr 2fr;
}

d-byline .byline h3 {
  margin-block-start: 1.5em;
}

d-byline .byline .authors-affiliations h3 {
  margin-block-start: 0.5em;
}

.authors-affiliations .orcid-id {
  width: 16px;
  height:16px;
  margin-left: 4px;
  margin-right: 4px;
  vertical-align: middle;
  padding-bottom: 2px;
}

d-title .dt-tags {
  margin-top: 1em;
  grid-column: text;
}

.dt-tags .dt-tag {
  text-decoration: none;
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0em 0.4em;
  margin-right: 0.5em;
  margin-bottom: 0.4em;
  font-size: 70%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

d-article table.gt_table td,
d-article table.gt_table th {
  border-bottom: none;
}

.html-widget {
  margin-bottom: 2.0em;
}

.l-screen-inset {
  padding-right: 16px;
}

.l-screen .caption {
  margin-left: 10px;
}

.shaded {
  background: rgb(247, 247, 247);
  padding-top: 20px;
  padding-bottom: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .html-widget {
  margin-bottom: 0;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.shaded .shaded-content {
  background: white;
}

.text-output {
  margin-top: 0;
  line-height: 1.5em;
}

.hidden {
  display: none !important;
}

d-article {
  padding-top: 2.5rem;
  padding-bottom: 30px;
}

d-appendix {
  padding-top: 30px;
}

d-article>p>img {
  width: 100%;
}

d-article h2 {
  margin: 1rem 0 1.5rem 0;
}

d-article h3 {
  margin-top: 1.5rem;
}

d-article iframe {
  border: 1px solid rgba(0, 0, 0, 0.1);
  margin-bottom: 2.0em;
  width: 100%;
}

/* Tweak code blocks */

d-article div.sourceCode code,
d-article pre code {
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
}

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: hidden;
}

d-article div.sourceCode {
  background-color: white;
}

d-article div.sourceCode pre {
  padding-left: 10px;
  font-size: 12px;
  border-left: 2px solid rgba(0,0,0,0.1);
}

d-article pre {
  font-size: 12px;
  color: black;
  background: none;
  margin-top: 0;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

d-article pre a {
  border-bottom: none;
}

d-article pre a:hover {
  border-bottom: none;
  text-decoration: underline;
}

@media(min-width: 768px) {

d-article pre,
d-article div.sourceCode,
d-article div.sourceCode pre {
  overflow: visible !important;
}

d-article div.sourceCode pre {
  padding-left: 18px;
  font-size: 14px;
}

d-article pre {
  font-size: 14px;
}

}

figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

/* CSS for d-contents */

.d-contents {
  grid-column: text;
  color: rgba(0,0,0,0.8);
  font-size: 0.9em;
  padding-bottom: 1em;
  margin-bottom: 1em;
  padding-bottom: 0.5em;
  margin-bottom: 1em;
  padding-left: 0.25em;
  justify-self: start;
}

@media(min-width: 1000px) {
  .d-contents.d-contents-float {
    height: 0;
    grid-column-start: 1;
    grid-column-end: 4;
    justify-self: center;
    padding-right: 3em;
    padding-left: 2em;
  }
}

.d-contents nav h3 {
  font-size: 18px;
  margin-top: 0;
  margin-bottom: 1em;
}

.d-contents li {
  list-style-type: none
}

.d-contents nav > ul {
  padding-left: 0;
}

.d-contents ul {
  padding-left: 1em
}

.d-contents nav ul li {
  margin-top: 0.6em;
  margin-bottom: 0.2em;
}

.d-contents nav a {
  font-size: 13px;
  border-bottom: none;
  text-decoration: none
  color: rgba(0, 0, 0, 0.8);
}

.d-contents nav a:hover {
  text-decoration: underline solid rgba(0, 0, 0, 0.6)
}

.d-contents nav > ul > li > a {
  font-weight: 600;
}

.d-contents nav > ul > li > ul {
  font-weight: inherit;
}

.d-contents nav > ul > li > ul > li {
  margin-top: 0.2em;
}


.d-contents nav ul {
  margin-top: 0;
  margin-bottom: 0.25em;
}

.d-article-with-toc h2:nth-child(2) {
  margin-top: 0;
}


/* Figure */

.figure {
  position: relative;
  margin-bottom: 2.5em;
  margin-top: 1.5em;
}

.figure img {
  width: 100%;
}

.figure .caption {
  color: rgba(0, 0, 0, 0.6);
  font-size: 12px;
  line-height: 1.5em;
}

.figure img.external {
  background: white;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
  padding: 18px;
  box-sizing: border-box;
}

.figure .caption a {
  color: rgba(0, 0, 0, 0.6);
}

.figure .caption b,
.figure .caption strong, {
  font-weight: 600;
  color: rgba(0, 0, 0, 1.0);
}

/* Citations */

d-article .citation {
  color: inherit;
  cursor: inherit;
}

div.hanging-indent{
  margin-left: 1em; text-indent: -1em;
}


/* Tweak 1000px media break to show more text */

@media(min-width: 1000px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 16px;
  }

  .grid {
    grid-column-gap: 16px;
  }

  d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
  }
  figure .caption, .figure .caption, figure figcaption {
    font-size: 13px;
  }
}

@media(min-width: 1180px) {
  .base-grid,
  distill-header,
  d-title,
  d-abstract,
  d-article,
  d-appendix,
  distill-appendix,
  d-byline,
  d-footnote-list,
  d-citation-list,
  distill-footer {
    grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
    grid-column-gap: 32px;
  }

  .grid {
    grid-column-gap: 32px;
  }
}


/* Get the citation styles for the appendix (not auto-injected on render since
   we do our own rendering of the citation appendix) */

d-appendix .citation-appendix,
.d-appendix .citation-appendix {
  font-size: 11px;
  line-height: 15px;
  border-left: 1px solid rgba(0, 0, 0, 0.1);
  padding-left: 18px;
  border: 1px solid rgba(0,0,0,0.1);
  background: rgba(0, 0, 0, 0.02);
  padding: 10px 18px;
  border-radius: 3px;
  color: rgba(150, 150, 150, 1);
  overflow: hidden;
  margin-top: -12px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Include appendix styles here so they can be overridden */

d-appendix {
  contain: layout style;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-top: 60px;
  margin-bottom: 0;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  color: rgba(0,0,0,0.5);
  padding-top: 60px;
  padding-bottom: 48px;
}

d-appendix h3 {
  grid-column: page-start / text-start;
  font-size: 15px;
  font-weight: 500;
  margin-top: 1em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.65);
}

d-appendix h3 + * {
  margin-top: 1em;
}

d-appendix ol {
  padding: 0 0 0 15px;
}

@media (min-width: 768px) {
  d-appendix ol {
    padding: 0 0 0 30px;
    margin-left: -30px;
  }
}

d-appendix li {
  margin-bottom: 1em;
}

d-appendix a {
  color: rgba(0, 0, 0, 0.6);
}

d-appendix > * {
  grid-column: text;
}

d-appendix > d-footnote-list,
d-appendix > d-citation-list,
d-appendix > distill-appendix {
  grid-column: screen;
}

/* Include footnote styles here so they can be overridden */

d-footnote-list {
  contain: layout style;
}

d-footnote-list > * {
  grid-column: text;
}

d-footnote-list a.footnote-backlink {
  color: rgba(0,0,0,0.3);
  padding-left: 0.5em;
}



/* Anchor.js */

.anchorjs-link {
  /*transition: all .25s linear; */
  text-decoration: none;
  border-bottom: none;
}
*:hover > .anchorjs-link {
  margin-left: -1.125em !important;
  text-decoration: none;
  border-bottom: none;
}

/* Social footer */

.social_footer {
  margin-top: 30px;
  margin-bottom: 0;
  color: rgba(0,0,0,0.67);
}

.disqus-comments {
  margin-right: 30px;
}

.disqus-comment-count {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  cursor: pointer;
}

#disqus_thread {
  margin-top: 30px;
}

.article-sharing a {
  border-bottom: none;
  margin-right: 8px;
}

.article-sharing a:hover {
  border-bottom: none;
}

.sidebar-section.subscribe {
  font-size: 12px;
  line-height: 1.6em;
}

.subscribe p {
  margin-bottom: 0.5em;
}


.article-footer .subscribe {
  font-size: 15px;
  margin-top: 45px;
}


.sidebar-section.custom {
  font-size: 12px;
  line-height: 1.6em;
}

.custom p {
  margin-bottom: 0.5em;
}

/* Styles for listing layout (hide title) */
.layout-listing d-title, .layout-listing .d-title {
  display: none;
}

/* Styles for posts lists (not auto-injected) */


.posts-with-sidebar {
  padding-left: 45px;
  padding-right: 45px;
}

.posts-list .description h2,
.posts-list .description p {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
}

.posts-list .description h2 {
  font-weight: 700;
  border-bottom: none;
  padding-bottom: 0;
}

.posts-list h2.post-tag {
  border-bottom: 1px solid rgba(0, 0, 0, 0.2);
  padding-bottom: 12px;
}
.posts-list {
  margin-top: 60px;
  margin-bottom: 24px;
}

.posts-list .post-preview {
  text-decoration: none;
  overflow: hidden;
  display: block;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 24px 0;
}

.post-preview-last {
  border-bottom: none !important;
}

.posts-list .posts-list-caption {
  grid-column: screen;
  font-weight: 400;
}

.posts-list .post-preview h2 {
  margin: 0 0 6px 0;
  line-height: 1.2em;
  font-style: normal;
  font-size: 24px;
}

.posts-list .post-preview p {
  margin: 0 0 12px 0;
  line-height: 1.4em;
  font-size: 16px;
}

.posts-list .post-preview .thumbnail {
  box-sizing: border-box;
  margin-bottom: 24px;
  position: relative;
  max-width: 500px;
}
.posts-list .post-preview img {
  width: 100%;
  display: block;
}

.posts-list .metadata {
  font-size: 12px;
  line-height: 1.4em;
  margin-bottom: 18px;
}

.posts-list .metadata > * {
  display: inline-block;
}

.posts-list .metadata .publishedDate {
  margin-right: 2em;
}

.posts-list .metadata .dt-authors {
  display: block;
  margin-top: 0.3em;
  margin-right: 2em;
}

.posts-list .dt-tags {
  display: block;
  line-height: 1em;
}

.posts-list .dt-tags .dt-tag {
  display: inline-block;
  color: rgba(0,0,0,0.6);
  padding: 0.3em 0.4em;
  margin-right: 0.2em;
  margin-bottom: 0.4em;
  font-size: 60%;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 3px;
  text-transform: uppercase;
  font-weight: 500;
}

.posts-list img {
  opacity: 1;
}

.posts-list img[data-src] {
  opacity: 0;
}

.posts-more {
  clear: both;
}


.posts-sidebar {
  font-size: 16px;
}

.posts-sidebar h3 {
  font-size: 16px;
  margin-top: 0;
  margin-bottom: 0.5em;
  font-weight: 400;
  text-transform: uppercase;
}

.sidebar-section {
  margin-bottom: 30px;
}

.categories ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
}

.categories li {
  color: rgba(0, 0, 0, 0.8);
  margin-bottom: 0;
}

.categories li>a {
  border-bottom: none;
}

.categories li>a:hover {
  border-bottom: 1px solid rgba(0, 0, 0, 0.4);
}

.categories .active {
  font-weight: 600;
}

.categories .category-count {
  color: rgba(0, 0, 0, 0.4);
}


@media(min-width: 768px) {
  .posts-list .post-preview h2 {
    font-size: 26px;
  }
  .posts-list .post-preview .thumbnail {
    float: right;
    width: 30%;
    margin-bottom: 0;
  }
  .posts-list .post-preview .description {
    float: left;
    width: 45%;
  }
  .posts-list .post-preview .metadata {
    float: left;
    width: 20%;
    margin-top: 8px;
  }
  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.5em;
    font-size: 16px;
  }
  .posts-with-sidebar .posts-list {
    float: left;
    width: 75%;
  }
  .posts-with-sidebar .posts-sidebar {
    float: right;
    width: 20%;
    margin-top: 60px;
    padding-top: 24px;
    padding-bottom: 24px;
  }
}


/* Improve display for browsers without grid (IE/Edge <= 15) */

.downlevel {
  line-height: 1.6em;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  margin: 0;
}

.downlevel .d-title {
  padding-top: 6rem;
  padding-bottom: 1.5rem;
}

.downlevel .d-title h1 {
  font-size: 50px;
  font-weight: 700;
  line-height: 1.1em;
  margin: 0 0 0.5rem;
}

.downlevel .d-title p {
  font-weight: 300;
  font-size: 1.2rem;
  line-height: 1.55em;
  margin-top: 0;
}

.downlevel .d-byline {
  padding-top: 0.8em;
  padding-bottom: 0.8em;
  font-size: 0.8rem;
  line-height: 1.8em;
}

.downlevel .section-separator {
  border: none;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.downlevel .d-article {
  font-size: 1.06rem;
  line-height: 1.7em;
  padding-top: 1rem;
  padding-bottom: 2rem;
}


.downlevel .d-appendix {
  padding-left: 0;
  padding-right: 0;
  max-width: none;
  font-size: 0.8em;
  line-height: 1.7em;
  margin-bottom: 0;
  color: rgba(0,0,0,0.5);
  padding-top: 40px;
  padding-bottom: 48px;
}

.downlevel .footnotes ol {
  padding-left: 13px;
}

.downlevel .base-grid,
.downlevel .distill-header,
.downlevel .d-title,
.downlevel .d-abstract,
.downlevel .d-article,
.downlevel .d-appendix,
.downlevel .distill-appendix,
.downlevel .d-byline,
.downlevel .d-footnote-list,
.downlevel .d-citation-list,
.downlevel .distill-footer,
.downlevel .appendix-bottom,
.downlevel .posts-container {
  padding-left: 40px;
  padding-right: 40px;
}

@media(min-width: 768px) {
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
  padding-left: 150px;
  padding-right: 150px;
  max-width: 900px;
}
}

.downlevel pre code {
  display: block;
  border-left: 2px solid rgba(0, 0, 0, .1);
  padding: 0 0 0 20px;
  font-size: 14px;
}

.downlevel code, .downlevel pre {
  color: black;
  background: none;
  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

.downlevel .posts-list .post-preview {
  color: inherit;
}



</style>

<script type="application/javascript">

function is_downlevel_browser() {
  if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                 window.navigator.userAgent)) {
    return true;
  } else {
    return window.load_distill_framework === undefined;
  }
}

// show body when load is complete
function on_load_complete() {

  // add anchors
  if (window.anchors) {
    window.anchors.options.placement = 'left';
    window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
  }


  // set body to visible
  document.body.style.visibility = 'visible';

  // force redraw for leaflet widgets
  if (window.HTMLWidgets) {
    var maps = window.HTMLWidgets.findAll(".leaflet");
    $.each(maps, function(i, el) {
      var map = this.getMap();
      map.invalidateSize();
      map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer)
          layer.redraw();
      });
    });
  }

  // trigger 'shown' so htmlwidgets resize
  $('d-article').trigger('shown');
}

function init_distill() {

  init_common();

  // create front matter
  var front_matter = $('<d-front-matter></d-front-matter>');
  $('#distill-front-matter').wrap(front_matter);

  // create d-title
  $('.d-title').changeElementType('d-title');

  // create d-byline
  var byline = $('<d-byline></d-byline>');
  $('.d-byline').replaceWith(byline);

  // create d-article
  var article = $('<d-article></d-article>');
  $('.d-article').wrap(article).children().unwrap();

  // move posts container into article
  $('.posts-container').appendTo($('d-article'));

  // create d-appendix
  $('.d-appendix').changeElementType('d-appendix');

  // flag indicating that we have appendix items
  var appendix = $('.appendix-bottom').children('h3').length > 0;

  // replace footnotes with <d-footnote>
  $('.footnote-ref').each(function(i, val) {
    appendix = true;
    var href = $(this).attr('href');
    var id = href.replace('#', '');
    var fn = $('#' + id);
    var fn_p = $('#' + id + '>p');
    fn_p.find('.footnote-back').remove();
    var text = fn_p.html();
    var dtfn = $('<d-footnote></d-footnote>');
    dtfn.html(text);
    $(this).replaceWith(dtfn);
  });
  // remove footnotes
  $('.footnotes').remove();

  // move refs into #references-listing
  $('#references-listing').replaceWith($('#refs'));

  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    var id = $(this).attr('id');
    $('.d-contents a[href="#' + id + '"]').parent().remove();
    appendix = true;
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
  });

  // show d-appendix if we have appendix content
  $("d-appendix").css('display', appendix ? 'grid' : 'none');

  // localize layout chunks to just output
  $('.layout-chunk').each(function(i, val) {

    // capture layout
    var layout = $(this).attr('data-layout');

    // apply layout to markdown level block elements
    var elements = $(this).children().not('div.sourceCode, pre, script');
    elements.each(function(i, el) {
      var layout_div = $('<div class="' + layout + '"></div>');
      if (layout_div.hasClass('shaded')) {
        var shaded_content = $('<div class="shaded-content"></div>');
        $(this).wrap(shaded_content);
        $(this).parent().wrap(layout_div);
      } else {
        $(this).wrap(layout_div);
      }
    });


    // unwrap the layout-chunk div
    $(this).children().unwrap();
  });

  // remove code block used to force  highlighting css
  $('.distill-force-highlighting-css').parent().remove();

  // remove empty line numbers inserted by pandoc when using a
  // custom syntax highlighting theme
  $('code.sourceCode a:empty').remove();

  // load distill framework
  load_distill_framework();

  // wait for window.distillRunlevel == 4 to do post processing
  function distill_post_process() {

    if (!window.distillRunlevel || window.distillRunlevel < 4)
      return;

    // hide author/affiliations entirely if we have no authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
    if (!have_authors)
      $('d-byline').addClass('hidden');

    // article with toc class
    $('.d-contents').parent().addClass('d-article-with-toc');

    // strip links that point to #
    $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

    // add orcid ids
    $('.authors-affiliations').find('.author').each(function(i, el) {
      var orcid_id = front_matter.authors[i].orcidID;
      if (orcid_id) {
        var a = $('<a></a>');
        a.attr('href', 'https://orcid.org/' + orcid_id);
        var img = $('<img></img>');
        img.addClass('orcid-id');
        img.attr('alt', 'ORCID ID');
        img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
        a.append(img);
        $(this).append(a);
      }
    });

    // hide elements of author/affiliations grid that have no value
    function hide_byline_column(caption) {
      $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
    }

    // affiliations
    var have_affiliations = false;
    for (var i = 0; i<front_matter.authors.length; ++i) {
      var author = front_matter.authors[i];
      if (author.affiliation !== "&nbsp;") {
        have_affiliations = true;
        break;
      }
    }
    if (!have_affiliations)
      $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

    // published date
    if (!front_matter.publishedDate)
      hide_byline_column("Published");

    // document object identifier
    var doi = $('d-byline').find('h3:contains("DOI")');
    var doi_p = doi.next().empty();
    if (!front_matter.doi) {
      // if we have a citation and valid citationText then link to that
      if ($('#citation').length > 0 && front_matter.citationText) {
        doi.html('Citation');
        $('<a href="#citation"></a>')
          .text(front_matter.citationText)
          .appendTo(doi_p);
      } else {
        hide_byline_column("DOI");
      }
    } else {
      $('<a></a>')
         .attr('href', "https://doi.org/" + front_matter.doi)
         .html(front_matter.doi)
         .appendTo(doi_p);
    }

     // change plural form of authors/affiliations
    if (front_matter.authors.length === 1) {
      var grid = $('.authors-affiliations');
      grid.children('h3:contains("Authors")').text('Author');
      grid.children('h3:contains("Affiliations")').text('Affiliation');
    }

    // remove d-appendix and d-footnote-list local styles
    $('d-appendix > style:first-child').remove();
    $('d-footnote-list > style:first-child').remove();

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // clear polling timer
    clearInterval(tid);

    // show body now that everything is ready
    on_load_complete();
  }

  var tid = setInterval(distill_post_process, 50);
  distill_post_process();

}

function init_downlevel() {

  init_common();

   // insert hr after d-title
  $('.d-title').after($('<hr class="section-separator"/>'));

  // check if we have authors
  var front_matter = JSON.parse($("#distill-front-matter").html());
  var have_authors = front_matter.authors && front_matter.authors.length > 0;

  // manage byline/border
  if (!have_authors)
    $('.d-byline').remove();
  $('.d-byline').after($('<hr class="section-separator"/>'));
  $('.d-byline a').remove();

  // remove toc
  $('.d-contents').remove();

  // move appendix elements
  $('h1.appendix, h2.appendix').each(function(i, val) {
    $(this).changeElementType('h3');
  });
  $('h3.appendix').each(function(i, val) {
    $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
  });


  // inject headers into references and footnotes
  var refs_header = $('<h3></h3>');
  refs_header.text('References');
  $('#refs').prepend(refs_header);

  var footnotes_header = $('<h3></h3');
  footnotes_header.text('Footnotes');
  $('.footnotes').children('hr').first().replaceWith(footnotes_header);

  // move appendix-bottom entries to the bottom
  $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
  $('.appendix-bottom').remove();

  // remove appendix if it's empty
  if ($('.d-appendix').children().length === 0)
    $('.d-appendix').remove();

  // prepend separator above appendix
  $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

  // trim code
  $('pre>code').each(function(i, val) {
    $(this).html($.trim($(this).html()));
  });

  // move posts-container right before article
  $('.posts-container').insertBefore($('.d-article'));

  $('body').addClass('downlevel');

  on_load_complete();
}


function init_common() {

  // jquery plugin to change element types
  (function($) {
    $.fn.changeElementType = function(newType) {
      var attrs = {};

      $.each(this[0].attributes, function(idx, attr) {
        attrs[attr.nodeName] = attr.nodeValue;
      });

      this.replaceWith(function() {
        return $("<" + newType + "/>", attrs).append($(this).contents());
      });
    };
  })(jQuery);

  // prevent underline for linked images
  $('a > img').parent().css({'border-bottom' : 'none'});

  // mark non-body figures created by knitr chunks as 100% width
  $('.layout-chunk').each(function(i, val) {
    var figures = $(this).find('img, .html-widget');
    if ($(this).attr('data-layout') !== "l-body") {
      figures.css('width', '100%');
    } else {
      figures.css('max-width', '100%');
      figures.filter("[width]").each(function(i, val) {
        var fig = $(this);
        fig.css('width', fig.attr('width') + 'px');
      });

    }
  });

  // auto-append index.html to post-preview links in file: protocol
  // and in rstudio ide preview
  $('.post-preview').each(function(i, val) {
    if (window.location.protocol === "file:")
      $(this).attr('href', $(this).attr('href') + "index.html");
  });

  // get rid of index.html references in header
  if (window.location.protocol !== "file:") {
    $('.distill-site-header a[href]').each(function(i,val) {
      $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
    });
  }

  // add class to pandoc style tables
  $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
  $('.kable-table').children('table').addClass('pandoc-table');

  // add figcaption style to table captions
  $('caption').parent('table').addClass("figcaption");

  // initialize posts list
  if (window.init_posts_list)
    window.init_posts_list();

  // implmement disqus comment link
  $('.disqus-comment-count').click(function() {
    window.headroom_prevent_pin = true;
    $('#disqus_thread').toggleClass('hidden');
    if (!$('#disqus_thread').hasClass('hidden')) {
      var offset = $(this).offset();
      $(window).resize();
      $('html, body').animate({
        scrollTop: offset.top - 35
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  if (is_downlevel_browser())
    init_downlevel();
  else
    window.addEventListener('WebComponentsReady', init_distill);
});

</script>

<!--/radix_placeholder_distill-->
  <script src="../../site_libs/header-attrs-2.5/header-attrs.js"></script>
  <script src="../../site_libs/jquery-1.11.3/jquery.min.js"></script>
  <script src="../../site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="../../site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="../../site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="../../site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-20375833-3"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-20375833-3');
</script>
<!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Experimenting with autoregressive flows in TensorFlow Probability","description":"Continuing from the recent introduction to bijectors in TensorFlow Probability (TFP), this post brings autoregressivity to the table. Using TFP through the new R package tfprobability, we look at the implementation of masked autoregressive flows (MAF) and put them to use on two different datasets.","authors":[{"author":"Sigrid Keydana","authorURL":"#","affiliation":"RStudio","affiliationURL":"https://www.rstudio.com/","orcidID":""}],"publishedDate":"2019-04-24T00:00:00.000+00:00","citationText":"Keydana, 2019"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<span class="logo">
<img src="../../images/rstudio.png"/>
</span>
<a href="../../index.html" class="title">AI Blog</a>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="../../index.html">Home</a>
<a href="../../gallery.html">Gallery</a>
<a href="../../about.html">About</a>
<a href="../../contributing.html">Contributing</a>
<a href="../../index.xml">
<i class="fa fa-rss" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Experimenting with autoregressive flows in TensorFlow Probability</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
  <a href="../../index.html#category:Probabilistic_ML/DL" class="dt-tag">Probabilistic ML/DL</a>
  <a href="../../index.html#category:Unsupervised_Learning" class="dt-tag">Unsupervised Learning</a>
  <a href="../../index.html#category:TensorFlow/Keras" class="dt-tag">TensorFlow/Keras</a>
</div>
<!--/radix_placeholder_categories-->
<p><p>Continuing from the recent introduction to bijectors in TensorFlow Probability (TFP), this post brings autoregressivity to the table. Using TFP through the new R package tfprobability, we look at the implementation of masked autoregressive flows (MAF) and put them to use on two different datasets.</p></p>
</div>

<div class="d-byline">
  Sigrid Keydana  (RStudio)<a href="https://www.rstudio.com/" class="uri">https://www.rstudio.com/</a>
  
<br/>04-24-2019
</div>

<div class="d-article">
<p>In the <a href="https://blogs.rstudio.com/tensorflow/posts/2019-04-05-bijectors-flows/">first part of this mini-series on autoregressive flow models</a>, we looked at <em>bijectors</em> in TensorFlow Probability (TFP), and saw how to use them for sampling and density estimation. We singled out the <em>affine bijector</em> to demonstrate the mechanics of flow construction: We start from a distribution that is easy to sample from, and that allows for straightforward calculation of its density. Then, we attach some number of invertible transformations, optimizing for data-likelihood under the final transformed distribution. The efficiency of that (log)likelihood calculation is where normalizing flows excel: Loglikelihood under the (unknown) target distribution is obtained as a sum of the density under the base distribution of the inverse-transformed data plus the absolute log determinant of the inverse Jacobian.</p>
<p>Now, an affine flow will seldom be powerful enough to model nonlinear, complex transformations. In constrast, autoregressive models have shown substantive success in density estimation as well as sample generation. Combined with more involved architectures, feature engineering, and extensive compute, the concept of autoregressivity has powered  and is powering  state-of-the-art architectures in areas such as image, speech and video modeling.</p>
<p>This post will be concerned with the building blocks of autoregressive flows in TFP. While we wont exactly be building state-of-the-art models, well try to understand and play with some major ingredients, hopefully enabling the reader to do her own experiments on her own data.</p>
<p>This post has three parts: First, well look at autoregressivity and its implementation in TFP. Then, we try to (approximately) reproduce one of the experiments in the MAF paper (<em>Masked Autoregressive Flows for Distribution Estimation</em> <span class="citation" data-cites="2017arXiv170507057P">(Papamakarios, Pavlakou, and Murray <a href="#ref-2017arXiv170507057P" role="doc-biblioref">2017</a>)</span>)  essentially a proof of concept. Finally, for the third time on this blog, we come back to the task of analysing audio data, with mixed results.</p>
<h2 id="autoregressivity-and-masking">Autoregressivity and masking</h2>
<p>In distribution estimation, autoregressivity enters the scene via the chain rule of probability that decomposes a joint density into a product of conditional densities:</p>
<p><span class="math display">\[
p(\mathbf{x}) = \prod_{i}p(\mathbf{x}_i|\mathbf{x}_{1:i1})
\]</span></p>
<p>In practice, this means that autoregressive models have to impose an order on the variables - an order which might or might not make sense. Approaches here include choosing orderings at random and/or using different orderings for each layer. While in recurrent neural networks, autoregressivity is conserved due to the recurrence relation inherent in state updating, it is not clear a priori how autoregressivity is to be achieved in a densely connected architecture. A computationally efficient solution was proposed in <em>MADE: Masked Autoencoder for Distribution Estimation</em><span class="citation" data-cites="GermainGML15">(Germain et al. <a href="#ref-GermainGML15" role="doc-biblioref">2015</a>)</span>: Starting from a densely connected layer, mask out all connections that should not be allowed, i.e., all connections from input feature <span class="math inline">\(i\)</span> to said layers activations <span class="math inline">\(1 ... i-1\)</span>. Or expressed differently, activation <span class="math inline">\(i\)</span> may be connected to input features <span class="math inline">\(1 ... i-1\)</span> only. Then when adding more layers, care must be taken to ensure that all required connections are masked so that at the end, output <span class="math inline">\(i\)</span> will only ever have seen inputs <span class="math inline">\(1 ... i-1\)</span>.</p>
<p>Thus masked autoregressive flows are a fusion of two major approaches - autoregressive models (which need not be flows) and flows (which need not be autoregressive). In TFP these are provided by <code>MaskedAutoregressiveFlow</code>,<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> to be used as a bijector in a <code>TransformedDistribution</code>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>While the documentation shows how to use this bijector, the step from theoretical understanding to coding a black box may seem wide. If youre anything like the author, here you might feel the urge to look under the hood and verify that things really are the way youre assuming. So lets give in to curiosity and allow ourselves a little escapade into the source code.</p>
<p>Peeking ahead, this is how well construct a masked autoregressive flow in TFP (again using the still new-ish R bindings provided by <a href="http://github.io/tfprobability">tfprobability</a>):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tfprobability</span><span class='op'>)</span>

<span class='va'>maf</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_masked_autoregressive_flow</span><span class='op'>(</span>
    shift_and_log_scale_fn <span class='op'>=</span> <span class='fu'>tfb_masked_autoregressive_default_template</span><span class='op'>(</span>
      hidden_layers <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>num_hidden</span>, <span class='va'>num_hidden</span><span class='op'>)</span>,
      activation <span class='op'>=</span> <span class='va'>tf</span><span class='op'>$</span><span class='va'>nn</span><span class='op'>$</span><span class='va'>tanh</span><span class='op'>)</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Pulling apart the relevant entities here, <code>tfb_masked_autoregressive_flow</code> is a bijector, with the usual methods <code>tfb_forward()</code>, <code>tfb_inverse()</code>, <code>tfb_forward_log_det_jacobian()</code> and <code>tfb_inverse_log_det_jacobian()</code>. The default <code>shift_and_log_scale_fn</code>, <code>tfb_masked_autoregressive_default_template</code>, constructs a little neural network of its own, with a configurable number of hidden units per layer, a configurable activation function and optionally, other configurable parameters to be passed to the underlying <code>dense</code> layers. Its these dense layers that have to respect the autoregressive property. Can we take a look at how this is done? Yes we can, provided were not afraid of a little Python.</p>
<p><code>masked_autoregressive_default_template</code> (now leaving out the <code>tfb_</code> as weve entered Python-land) uses <code>masked_dense</code> to do what youd suppose a thus-named function might be doing: construct a dense layer that has part of the weight matrix masked out. How? Well see after a few Python setup statements.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="im">import</span> tensorflow_probability <span class="im">as</span> tfp</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>tfd <span class="op">=</span> tfp.distributions</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>tfb <span class="op">=</span> tfp.bijectors</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>tf.enable_eager_execution()</span></code></pre></div>
</div>
<p>The following code snippets are taken from <code>masked_dense</code> (in its <a href="https://github.com/tensorflow/probability/blob/master/tensorflow_probability/python/bijectors/masked_autoregressive.py">current form on master</a>), and when possible, simplified for better readability, accommodating just the specifics of the chosen example - a toy matrix of shape 2x3:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co"># construct some toy input data (this line obviously not from the original code)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>inputs <span class="op">=</span> tf.constant(np.arange(<span class="fl">1.</span>,<span class="dv">7</span>), shape <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co"># (partly) determine shape of mask from shape of input</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>input_depth <span class="op">=</span> tf.compat.dimension_value(inputs.shape.with_rank_at_least(<span class="dv">1</span>)[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>num_blocks <span class="op">=</span> input_depth</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>num_blocks <span class="co"># 3</span></span></code></pre></div>
</div>
<p>Our toy layer should have 4 units:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>units <span class="op">=</span> <span class="dv">4</span></span></code></pre></div>
</div>
<p>The mask is initialized to all zeros. Considering it will be used to elementwise multiply the weight matrix, were a bit surprised at its shape (shouldnt it be the other way round?). No worries; all will turn out correct in the end.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>mask <span class="op">=</span> np.zeros([units, input_depth], dtype<span class="op">=</span>tf.float32.as_numpy_dtype())</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>mask</span></code></pre></div>
</div>
<pre><code>array([[0., 0., 0.],
       [0., 0., 0.],
       [0., 0., 0.],
       [0., 0., 0.]], dtype=float32)</code></pre>
<p>Now to whitelist the allowed connections, we have to fill in ones whenever information flow <em>is</em> allowed by the autoregressive property:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">def</span> _gen_slices(num_blocks, n_in, n_out):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>  slices <span class="op">=</span> []</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>  col <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>  d_in <span class="op">=</span> n_in <span class="op">//</span> num_blocks</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>  d_out <span class="op">=</span> n_out <span class="op">//</span> num_blocks</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>  row <span class="op">=</span> d_out </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>  <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_blocks):</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    row_slice <span class="op">=</span> <span class="bu">slice</span>(row, <span class="va">None</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    col_slice <span class="op">=</span> <span class="bu">slice</span>(col, col <span class="op">+</span> d_in)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>    slices.append([row_slice, col_slice])</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>    col <span class="op">+=</span> d_in</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>    row <span class="op">+=</span> d_out</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>  <span class="cf">return</span> slices</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a>slices <span class="op">=</span> _gen_slices(num_blocks, input_depth, units)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="cf">for</span> [row_slice, col_slice] <span class="kw">in</span> slices:</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a>  mask[row_slice, col_slice] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>mask</span></code></pre></div>
</div>
<pre><code>array([[0., 0., 0.],
       [1., 0., 0.],
       [1., 1., 0.],
       [1., 1., 1.]], dtype=float32)</code></pre>
<p>Again, does this look mirror-inverted? A transpose fixes shape and logic both:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>mask <span class="op">=</span> mask.t</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>mask</span></code></pre></div>
</div>
<pre><code>array([[0., 1., 1., 1.],
       [0., 0., 1., 1.],
       [0., 0., 0., 1.]], dtype=float32)</code></pre>
<p>Now that we have the mask, we can create the layer (interestingly, as of this writing not (yet?) a <code>tf.keras</code> layer):</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>layer <span class="op">=</span> tf.compat.v1.layers.Dense(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>        units,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>        kernel_initializer<span class="op">=</span>masked_initializer, <span class="co"># 1</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>        kernel_constraint<span class="op">=</span><span class="kw">lambda</span> x: mask <span class="op">*</span> x   <span class="co"># 2</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>        )</span></code></pre></div>
</div>
<p>Here we see masking going on in two ways. For one, the weight initializer is masked:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>kernel_initializer <span class="op">=</span> tf.compat.v1.glorot_normal_initializer()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="kw">def</span> masked_initializer(shape, dtype<span class="op">=</span><span class="va">None</span>, partition_info<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a> <span class="cf">return</span> mask <span class="op">*</span> kernel_initializer(shape, dtype, partition_info)</span></code></pre></div>
</div>
<p>And secondly, a kernel constraint makes sure that after optimization, the relative units are zeroed out again:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>kernel_constraint<span class="op">=</span><span class="kw">lambda</span> x: mask <span class="op">*</span> x </span></code></pre></div>
</div>
<p>Just for fun, lets apply the layer to our toy input:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>layer.<span class="bu">apply</span>(inputs)</span></code></pre></div>
</div>
<pre><code>&lt;tf.Tensor: id=30, shape=(2, 4), dtype=float64, numpy=
array([[ 0.        , -0.7489589 , -0.43329933,  1.42710014],
       [ 0.        , -2.9958356 , -1.71647246,  1.09258015]])&gt;</code></pre>
<p>Zeroes where expected. And double-checking on the weight matrix</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>layer.kernel</span></code></pre></div>
</div>
<pre><code>&lt;tf.Variable &#39;dense/kernel:0&#39; shape=(3, 4) dtype=float64, numpy=
array([[ 0.        , -0.7489589 , -0.42214942, -0.6473454 ],
       [-0.        ,  0.        , -0.00557496, -0.46692933],
       [-0.        , -0.        , -0.        ,  1.00276807]])&gt;</code></pre>
<p>Good. Now hopefully after this little deep dive, things have become a bit more concrete. Of course in a bigger model, the autoregressive property has to be conserved between layers as well.</p>
<p>On to the second topic, application of MAF to a real-world dataset.</p>
<h2 id="masked-autoregressive-flow">Masked Autoregressive Flow</h2>
<p>The MAF paper<span class="citation" data-cites="2017arXiv170507057P">(Papamakarios, Pavlakou, and Murray <a href="#ref-2017arXiv170507057P" role="doc-biblioref">2017</a>)</span> applied masked autoregressive flows (as well as single-layer-<em>MADE</em><span class="citation" data-cites="GermainGML15">(Germain et al. <a href="#ref-GermainGML15" role="doc-biblioref">2015</a>)</span> and Real NVP <span class="citation" data-cites="DinhSB16">(Dinh, Sohl-Dickstein, and Bengio <a href="#ref-DinhSB16" role="doc-biblioref">2016</a>)</span>) to a number of datasets, including MNIST, CIFAR-10 and several datasets from the <a href="http://archive.ics.uci.edu/ml/index.html">UCI Machine Learning Repository</a>.</p>
<p>We pick one of the UCI datasets: <a href="http://archive.ics.uci.edu/ml/datasets/gas+sensors+for+home+activity+monitoring">Gas sensors for home activity monitoring</a>. On this dataset, the MAF authors obtained the best results using a MAF with 10 flows, so this is what we will try.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:unnamed-chunk-13"></span>
<img src="images/maf_results.png" alt="Figure from Masked Autoregressive Flow for Density Estimation[@2017arXiv170507057P]" width="338" />
<p class="caption">
Figure 1: Figure from Masked Autoregressive Flow for Density Estimation<span class="citation" data-cites="2017arXiv170507057P">(Papamakarios, Pavlakou, and Murray <a href="#ref-2017arXiv170507057P" role="doc-biblioref">2017</a>)</span>
</p>
</div>
</div>
<p>Collecting information from the paper, we know that</p>
<ul>
<li>data was included from the file <em>ethylene_CO.txt</em> only;</li>
<li>discrete columns were eliminated, as well as all columns with correlations &gt; .98; and</li>
<li>the remaining 8 columns<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> were standardised (z-transformed).</li>
</ul>
<p>Regarding the neural network architecture, we gather that</p>
<ul>
<li>each of the 10 MAF layers was followed by a batchnorm;</li>
<li>as to feature order, the first MAF layer used the variable order that came with the dataset; then every consecutive layer reversed it;</li>
<li>specifically for this dataset and as opposed to all other UCI datasets, <em>tanh</em> was used for activation instead of <em>relu</em>;</li>
<li>the Adam optimizer was used, with a learning rate of 1e-4;</li>
<li>there were two hidden layers for each MAF, with 100 units each;</li>
<li>training went on until no improvement occurred for 30 consecutive epochs on the validation set; and</li>
<li>the base distribution was a multivariate Gaussian.</li>
</ul>
<p>This is all useful information for our attempt to estimate this dataset, but the essential bit is this. In case you knew the dataset already, you might have been wondering how the authors would deal with the dimensionality of the data: It is a time series, and the MADE architecture explored above introduces autoregressivity between features, not time steps. So how is the additional temporal autoregressivity to be handled? The answer is: The time dimension is essentially removed. In the authors words,</p>
<blockquote>
<p>[] it is a time series but was treated as if each example were an i.i.d. sample from the marginal distribution.</p>
</blockquote>
<p>This undoubtedly is useful information for our present modeling attempt, but it also tells us something else: We might have to look beyond MADE layers for actual time series modeling.</p>
<p>Now though lets look at this example of using MAF for multivariate modeling, with no time or spatial dimension to be taken into account.</p>
<p>Following the hints the authors gave us, this is what we do.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># load libraries -------------------------------------------------------------</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tensorflow</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tfprobability</span><span class='op'>)</span>

<span class='fu'>tfe_enable_eager_execution</span><span class='op'>(</span>device_policy <span class='op'>=</span> <span class='st'>"silent"</span><span class='op'>)</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>tfdatasets</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>readr</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://purrr.tidyverse.org'>purrr</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>caret</span><span class='op'>)</span>

<span class='co'># read data ------------------------------------------------------------------</span>
<span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'>read_table2</span><span class='op'>(</span><span class='st'>"ethylene_CO.txt"</span>,
                  skip <span class='op'>=</span> <span class='fl'>1</span>,
                  col_names <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
<span class='fu'><a href='https://tibble.tidyverse.org/reference/glimpse.html'>glimpse</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<pre><code>Observations: 4,208,261
Variables: 19
$ X1  &lt;dbl&gt; 0.00, 0.01, 0.01, 0.03, 0.04, 0.05, 0.06, 0.07, 0.07, 0.09,...
$ X2  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
$ X3  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,...
$ X4  &lt;dbl&gt; -50.85, -49.40, -40.04, -47.14, -33.58, -48.59, -48.27, -47.14,... 
$ X5  &lt;dbl&gt; -1.95, -5.53, -16.09, -10.57, -20.79, -11.54, -9.11, -4.56,...
$ X6  &lt;dbl&gt; -41.82, -42.78, -27.59, -32.28, -33.25, -36.16, -31.31, -16.57,... 
$ X7  &lt;dbl&gt; 1.30, 0.49, 0.00, 4.40, 6.03, 6.03, 5.37, 4.40, 23.98, 2.77,...
$ X8  &lt;dbl&gt; -4.07, 3.58, -7.16, -11.22, 3.42, 0.33, -7.97, -2.28, -2.12,...
$ X9  &lt;dbl&gt; -28.73, -34.55, -42.14, -37.94, -34.22, -29.05, -30.34, -24.35,...
$ X10 &lt;dbl&gt; -13.49, -9.59, -12.52, -7.16, -14.46, -16.74, -8.62, -13.17,...
$ X11 &lt;dbl&gt; -3.25, 5.37, -5.86, -1.14, 8.31, -1.14, 7.00, -6.34, -0.81,...
$ X12 &lt;dbl&gt; 55139.95, 54395.77, 53960.02, 53047.71, 52700.28, 51910.52,...
$ X13 &lt;dbl&gt; 50669.50, 50046.91, 49299.30, 48907.00, 48330.96, 47609.00,...
$ X14 &lt;dbl&gt; 9626.26, 9433.20, 9324.40, 9170.64, 9073.64, 8982.88, 8860.51,...
$ X15 &lt;dbl&gt; 9762.62, 9591.21, 9449.81, 9305.58, 9163.47, 9021.08, 8966.48,...
$ X16 &lt;dbl&gt; 24544.02, 24137.13, 23628.90, 23101.66, 22689.54, 22159.12,...
$ X17 &lt;dbl&gt; 21420.68, 20930.33, 20504.94, 20101.42, 19694.07, 19332.57,...
$ X18 &lt;dbl&gt; 7650.61, 7498.79, 7369.67, 7285.13, 7156.74, 7067.61, 6976.13,...
$ X19 &lt;dbl&gt; 6928.42, 6800.66, 6697.47, 6578.52, 6468.32, 6385.31, 6300.97,...</code></pre>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># we don't know if we'll end up with the same columns as the authors did,</span>
<span class='co'># but we try (at least we do end up with 8 columns)</span>
<span class='va'>df</span> <span class='op'>&lt;-</span> <span class='va'>df</span><span class='op'>[</span>,<span class='op'>-</span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>3</span><span class='op'>)</span><span class='op'>]</span>
<span class='va'>hc</span> <span class='op'>&lt;-</span> <span class='fu'>findCorrelation</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/cor.html'>cor</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span>, cutoff <span class='op'>=</span> <span class='fl'>0.985</span><span class='op'>)</span>
<span class='va'>df2</span> <span class='op'>&lt;-</span> <span class='va'>df</span><span class='op'>[</span>,<span class='op'>-</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>hc</span><span class='op'>)</span><span class='op'>]</span>

<span class='co'># scale</span>
<span class='va'>df2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/scale.html'>scale</a></span><span class='op'>(</span><span class='va'>df2</span><span class='op'>)</span>
<span class='va'>df2</span>
</code></pre>
</div>
</div>
<pre><code># A tibble: 4,208,261 x 8
      X4     X5     X8    X9    X13    X16    X17   X18
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 -50.8  -1.95  -4.07 -28.7 50670. 24544. 21421. 7651.
 2 -49.4  -5.53   3.58 -34.6 50047. 24137. 20930. 7499.
 3 -40.0 -16.1   -7.16 -42.1 49299. 23629. 20505. 7370.
 4 -47.1 -10.6  -11.2  -37.9 48907  23102. 20101. 7285.
 5 -33.6 -20.8    3.42 -34.2 48331. 22690. 19694. 7157.
 6 -48.6 -11.5    0.33 -29.0 47609  22159. 19333. 7068.
 7 -48.3  -9.11  -7.97 -30.3 47047. 21932. 19028. 6976.
 8 -47.1  -4.56  -2.28 -24.4 46758. 21504. 18780. 6900.
 9 -42.3  -2.77  -2.12 -27.6 46197. 21125. 18439. 6827.
10 -44.6   3.58  -0.65 -35.5 45652. 20836. 18209. 6790.
#  with 4,208,251 more rows</code></pre>
<p>Now set up the data generation process:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># train-test split</span>
<span class='va'>n_rows</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>df2</span><span class='op'>)</span> <span class='co'># 4208261</span>
<span class='va'>train_ids</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>n_rows</span>, <span class='fl'>0.5</span> <span class='op'>*</span> <span class='va'>n_rows</span><span class='op'>)</span>
<span class='va'>x_train</span> <span class='op'>&lt;-</span> <span class='va'>df2</span><span class='op'>[</span><span class='va'>train_ids</span>, <span class='op'>]</span>
<span class='va'>x_test</span> <span class='op'>&lt;-</span> <span class='va'>df2</span><span class='op'>[</span><span class='op'>-</span><span class='va'>train_ids</span>, <span class='op'>]</span>

<span class='co'># create datasets</span>
<span class='va'>batch_size</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>
<span class='va'>train_dataset</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='va'>x_train</span>, <span class='va'>tf</span><span class='op'>$</span><span class='va'>float32</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='va'>tensor_slices_dataset</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dataset_batch</span><span class='op'>(</span><span class='va'>batch_size</span><span class='op'>)</span>

<span class='va'>test_dataset</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>cast</span><span class='op'>(</span><span class='va'>x_test</span>, <span class='va'>tf</span><span class='op'>$</span><span class='va'>float32</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='va'>tensor_slices_dataset</span> <span class='op'>%&gt;%</span>
  <span class='fu'>dataset_batch</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>x_test</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>To construct the flow, the first thing needed is the base distribution.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>base_dist</span> <span class='op'>&lt;-</span> <span class='fu'>tfd_multivariate_normal_diag</span><span class='op'>(</span>loc <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>df2</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Now for the flow, by default constructed with batchnorm and permutation of feature order.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>num_hidden</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>
<span class='va'>dim</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>df2</span><span class='op'>)</span>

<span class='va'>use_batchnorm</span> <span class='op'>&lt;-</span> <span class='cn'>TRUE</span>
<span class='va'>use_permute</span> <span class='op'>&lt;-</span> <span class='cn'>TRUE</span>
<span class='va'>num_mafs</span> <span class='op'>&lt;-</span><span class='fl'>10</span>
<span class='va'>num_layers</span> <span class='op'>&lt;-</span> <span class='fl'>3</span> <span class='op'>*</span> <span class='va'>num_mafs</span>

<span class='va'>bijectors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span>mode <span class='op'>=</span> <span class='st'>"list"</span>, length <span class='op'>=</span> <span class='va'>num_layers</span><span class='op'>)</span>

<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>num_layers</span>, by <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>maf</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_masked_autoregressive_flow</span><span class='op'>(</span>
    shift_and_log_scale_fn <span class='op'>=</span> <span class='fu'>tfb_masked_autoregressive_default_template</span><span class='op'>(</span>
      hidden_layers <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>num_hidden</span>, <span class='va'>num_hidden</span><span class='op'>)</span>,
      activation <span class='op'>=</span> <span class='va'>tf</span><span class='op'>$</span><span class='va'>nn</span><span class='op'>$</span><span class='va'>tanh</span><span class='op'>)</span><span class='op'>)</span>
  <span class='va'>bijectors</span><span class='op'>[[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>maf</span>
  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>use_batchnorm</span><span class='op'>)</span>
    <span class='va'>bijectors</span><span class='op'>[[</span><span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_batch_normalization</span><span class='op'>(</span><span class='op'>)</span>
  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>use_permute</span><span class='op'>)</span>
    <span class='va'>bijectors</span><span class='op'>[[</span><span class='va'>i</span> <span class='op'>+</span> <span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_permute</span><span class='op'>(</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span><span class='op'>(</span><span class='va'>df2</span><span class='op'>)</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fl'>0</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='kw'>if</span> <span class='op'>(</span><span class='va'>use_permute</span><span class='op'>)</span> <span class='va'>bijectors</span> <span class='op'>&lt;-</span> <span class='va'>bijectors</span><span class='op'>[</span><span class='op'>-</span><span class='va'>num_layers</span><span class='op'>]</span>

<span class='va'>flow</span> <span class='op'>&lt;-</span> <span class='va'>bijectors</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/keep.html'>discard</a></span><span class='op'>(</span><span class='va'>is.null</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='co'># tfb_chain expects arguments in reverse order of application</span>
  <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>tfb_chain</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>target_dist</span> <span class='op'>&lt;-</span> <span class='fu'>tfd_transformed_distribution</span><span class='op'>(</span>
  distribution <span class='op'>=</span> <span class='va'>base_dist</span>,
  bijector <span class='op'>=</span> <span class='va'>flow</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<p>And configuring the optimizer:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>optimizer</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='va'>train</span><span class='op'>$</span><span class='fu'>AdamOptimizer</span><span class='op'>(</span><span class='fl'>1e-4</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Under that isotropic Gaussian we chose as a base distribution, how likely are the data?</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>base_loglik</span> <span class='op'>&lt;-</span> <span class='va'>base_dist</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>x_train</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>base_loglik</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span>        <span class='co'># -11.33871</span>

<span class='va'>base_loglik_test</span> <span class='op'>&lt;-</span> <span class='va'>base_dist</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>x_test</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>base_loglik_test</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span>   <span class='co'># -11.36431</span>
</code></pre>
</div>
</div>
<p>And, just as a quick sanity check: What is the loglikelihood of the data under the transformed distribution <em>before any training</em>?</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>target_loglik_pre</span> <span class='op'>&lt;-</span>
  <span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>x_train</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>target_loglik_pre</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span>        <span class='co'># -11.22097</span>

<span class='va'>target_loglik_pre_test</span> <span class='op'>&lt;-</span>
  <span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>x_test</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>target_loglik_pre_test</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span>   <span class='co'># -11.36431</span>
</code></pre>
</div>
</div>
<p>The values match - good. Here now is the training loop. Being impatient, we already keep checking the loglikelihood on the (complete) test set to see if were making any progress.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>n_epochs</span> <span class='op'>&lt;-</span> <span class='fl'>10</span>

<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_epochs</span><span class='op'>)</span> <span class='op'>{</span>
  
  <span class='va'>agg_loglik</span> <span class='op'>&lt;-</span> <span class='fl'>0</span>
  <span class='va'>num_batches</span> <span class='op'>&lt;-</span> <span class='fl'>0</span>
  <span class='va'>iter</span> <span class='op'>&lt;-</span> <span class='fu'>make_iterator_one_shot</span><span class='op'>(</span><span class='va'>train_dataset</span><span class='op'>)</span>
  
  <span class='fu'>until_out_of_range</span><span class='op'>(</span><span class='op'>{</span>
    <span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='fu'>iterator_get_next</span><span class='op'>(</span><span class='va'>iter</span><span class='op'>)</span>
    <span class='va'>loss</span> <span class='op'>&lt;-</span>
      <span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span>
        <span class='op'>-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span><span class='op'>)</span>
    <span class='va'>optimizer</span><span class='op'>$</span><span class='fu'>minimize</span><span class='op'>(</span><span class='va'>loss</span><span class='op'>)</span>
    
    <span class='va'>loglik</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span><span class='op'>)</span>
    <span class='va'>agg_loglik</span> <span class='op'>&lt;-</span> <span class='va'>agg_loglik</span> <span class='op'>+</span> <span class='va'>loglik</span>
    <span class='va'>num_batches</span> <span class='op'>&lt;-</span> <span class='va'>num_batches</span> <span class='op'>+</span> <span class='fl'>1</span>
    
    <span class='va'>test_iter</span> <span class='op'>&lt;-</span> <span class='fu'>make_iterator_one_shot</span><span class='op'>(</span><span class='va'>test_dataset</span><span class='op'>)</span>
    <span class='va'>test_batch</span> <span class='op'>&lt;-</span> <span class='fu'>iterator_get_next</span><span class='op'>(</span><span class='va'>test_iter</span><span class='op'>)</span>
    <span class='va'>loglik_test_current</span> <span class='op'>&lt;-</span> <span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>test_batch</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='op'>)</span>
    
    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>num_batches</span> <span class='op'>%%</span> <span class='fl'>100</span> <span class='op'>==</span> <span class='fl'>1</span><span class='op'>)</span>
      <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span>
        <span class='st'>"Epoch "</span>,
        <span class='va'>i</span>,
        <span class='st'>": "</span>,
        <span class='st'>"Batch "</span>,
        <span class='va'>num_batches</span>,
        <span class='st'>": "</span>,
        <span class='op'>(</span><span class='va'>agg_loglik</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>num_batches</span>,
        <span class='st'>" --- test: "</span>,
        <span class='va'>loglik_test_current</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span>,
        <span class='st'>"\n"</span>
      <span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>With both training and test sets amounting to over 2 million records each, we did not have the patience to run this model <em>until no improvement occurred for 30 consecutive epochs on the validation set</em> (like the authors did). However, the picture we get from one complete epochs run is pretty clear: The setup seems to work pretty okay.</p>
<pre><code>Epoch  1 :  Batch      1:  -8.212026  --- test:  -10.09264 
Epoch  1 :  Batch   1001:   2.222953  --- test:   1.894102 
Epoch  1 :  Batch   2001:   2.810996  --- test:   2.147804 
Epoch  1 :  Batch   3001:   3.136733  --- test:   3.673271 
Epoch  1 :  Batch   4001:   3.335549  --- test:   4.298822 
Epoch  1 :  Batch   5001:   3.474280  --- test:   4.502975 
Epoch  1 :  Batch   6001:   3.606634  --- test:   4.612468 
Epoch  1 :  Batch   7001:   3.695355  --- test:   4.146113 
Epoch  1 :  Batch   8001:   3.767195  --- test:   3.770533 
Epoch  1 :  Batch   9001:   3.837641  --- test:   4.819314 
Epoch  1 :  Batch  10001:   3.908756  --- test:   4.909763 
Epoch  1 :  Batch  11001:   3.972645  --- test:   3.234356 
Epoch  1 :  Batch  12001:   4.020613  --- test:   5.064850 
Epoch  1 :  Batch  13001:   4.067531  --- test:   4.916662 
Epoch  1 :  Batch  14001:   4.108388  --- test:   4.857317 
Epoch  1 :  Batch  15001:   4.147848  --- test:   5.146242 
Epoch  1 :  Batch  16001:   4.177426  --- test:   4.929565 
Epoch  1 :  Batch  17001:   4.209732  --- test:   4.840716 
Epoch  1 :  Batch  18001:   4.239204  --- test:   5.222693 
Epoch  1 :  Batch  19001:   4.264639  --- test:   5.279918 
Epoch  1 :  Batch  20001:   4.291542  --- test:   5.29119 
Epoch  1 :  Batch  21001:   4.314462  --- test:   4.872157 
Epoch  2 :  Batch      1:   5.212013  --- test:   4.969406 </code></pre>
<p>With these training results, we regard the proof of concept as basically successful. However, from our experiments we also have to say that the choice of hyperparameters seems to matter a <em>lot</em>. For example, use of the <code>relu</code> activation function instead of <code>tanh</code> resulted in the network basically learning nothing. (As per the authors, <code>relu</code> worked fine on other datasets that had been z-transformed in just the same way.)</p>
<p><em>Batch normalization</em> here was obligatory - and this might go for flows in general. The permutation bijectors, on the other hand, did not make much of a difference on this dataset. Overall the impression is that for flows, we might either need a bag of tricks (like is commonly said about GANs), or more involved architectures (see Outlook below).</p>
<p>Finally, we wind up with an experiment, coming back to our favorite audio data, already featured in two posts: <a href="https://blogs.rstudio.com/tensorflow/posts/2018-06-06-simple-audio-classification-keras/">Simple Audio Classification with Keras</a> and <a href="https://blogs.rstudio.com/tensorflow/posts/2019-02-07-audio-background/">Audio classification with Keras: Looking closer at the non-deep learning parts</a>.</p>
<h2 id="analysing-audio-data-with-maf">Analysing audio data with MAF</h2>
<p>The <a href="https://storage.cloud.google.com/download.tensorflow.org/data/speech_commands_v0.01.tar.gz">dataset in question</a> consists of recordings of 30 words, pronounced by a number of different speakers. In those previous posts, a convnet was trained to map spectrograms to those 30 classes. Now instead we want to try something different: Train an MAF on one of the classes - the word zero, say - and see if we can use the trained network to mark non-zero words as less likely: perform <em>anomaly detection</em>, in a way. Spoiler alert: The results were not too encouraging, and if you are interested in a task like this, you might want to consider a different architecture (again, see Outlook below).</p>
<p>Nonetheless, we quickly relate what was done, as this task is a nice example of handling data where features vary over more than one axis.</p>
<p>Preprocessing starts as in the aforementioned previous posts. Here though, we explicitly use eager execution, and may sometimes hard-code known values to keep the code snippets short.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="kw">library</span>(tensorflow)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="kw">library</span>(tfprobability)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a><span class="kw">tfe_enable_eager_execution</span>(<span class="dt">device_policy =</span> <span class="st">&quot;silent&quot;</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a><span class="kw">library</span>(tfdatasets)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a><span class="kw">library</span>(readr)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a><span class="kw">library</span>(purrr)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a><span class="kw">library</span>(caret)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a><span class="kw">library</span>(stringr)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a><span class="co"># make decode_wav() run with the current release 1.13.1 as well as with the current master branch</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>decode_wav &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="cf">if</span> (reticulate<span class="op">::</span><span class="kw">py_has_attr</span>(tf, <span class="st">&quot;audio&quot;</span>)) tf<span class="op">$</span>audio<span class="op">$</span>decode_wav</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>  <span class="cf">else</span> tf<span class="op">$</span>contrib<span class="op">$</span>framework<span class="op">$</span>python<span class="op">$</span>ops<span class="op">$</span>audio_ops<span class="op">$</span>decode_wav</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a><span class="co"># same for stft()</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>stft &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="cf">if</span> (reticulate<span class="op">::</span><span class="kw">py_has_attr</span>(tf, <span class="st">&quot;signal&quot;</span>)) tf<span class="op">$</span>signal<span class="op">$</span>stft <span class="cf">else</span> tf<span class="op">$</span>spectral<span class="op">$</span>stft</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a>files &lt;-<span class="st"> </span>fs<span class="op">::</span><span class="kw">dir_ls</span>(<span class="dt">path =</span> <span class="st">&quot;audio/data_1/speech_commands_v0.01/&quot;</span>, <span class="co"># replace by yours</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a>                    <span class="dt">recursive =</span> <span class="ot">TRUE</span>,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a>                    <span class="dt">glob =</span> <span class="st">&quot;*.wav&quot;</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true"></a>files &lt;-<span class="st"> </span>files[<span class="op">!</span><span class="kw">str_detect</span>(files, <span class="st">&quot;background_noise&quot;</span>)]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true"></a>df &lt;-<span class="st"> </span><span class="kw">tibble</span>(</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true"></a>  <span class="dt">fname =</span> files,</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true"></a>  <span class="dt">class =</span> fname <span class="op">%&gt;%</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true"></a><span class="st">    </span><span class="kw">str_extract</span>(<span class="st">&quot;v0.01/.*/&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true"></a><span class="st">    </span><span class="kw">str_replace_all</span>(<span class="st">&quot;v0.01/&quot;</span>, <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true"></a><span class="st">    </span><span class="kw">str_replace_all</span>(<span class="st">&quot;/&quot;</span>, <span class="st">&quot;&quot;</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true"></a>)</span></code></pre></div>
</div>
<p>We train the MAF on pronunciations of the word zero.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='kw'>for</span> <span class='op'>(</span><span class='va'>c</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>class</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/assign.html'>assign</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"df_"</span>, <span class='va'>c</span><span class='op'>)</span>, <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>class</span> <span class='op'>==</span> <span class='va'>c</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>fname</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>df_</span> <span class='op'>&lt;-</span> <span class='va'>df_zero</span> <span class='co'># 2 * 1178 rows</span>
<span class='va'>idx_train</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>df_</span><span class='op'>)</span>, <span class='fl'>0.5</span> <span class='op'>*</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>df_</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>df_train</span> <span class='op'>&lt;-</span> <span class='va'>df_</span><span class='op'>[</span><span class='va'>idx_train</span>, <span class='op'>]</span>
<span class='va'>df_test</span> <span class='op'>&lt;-</span> <span class='va'>df_</span><span class='op'>[</span><span class='op'>-</span><span class='va'>idx_train</span>, <span class='op'>]</span>
</code></pre>
</div>
</div>
<p>Following the approach detailed in <a href="https://blogs.rstudio.com/tensorflow/posts/2019-02-07-audio-background/">Audio classification with Keras: Looking closer at the non-deep learning parts</a>, wed like to train the network on spectrograms instead of the raw time domain data. Using the same settings for <code>frame_length</code> and <code>frame_step</code> of the Short Term Fourier Transform as in that post, wed arrive at data shaped <code>number of frames x number of FFT coefficients</code>. To make this work with the <code>masked_dense()</code> employed in <code>tfb_masked_autoregressive_flow()</code>, the data would then have to be flattened, yielding an impressive 25186 features in the joint distribution.</p>
<p>With the architecture defined as above in the GAS example, this lead to the network not making much progress. Neither did leaving the data in time domain form, with 16000 features in the joint distribution. Thus, we decided to work with the FFT coefficients computed over the complete window instead, resulting in 257 joint features.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='va'>batch_size</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>

<span class='va'>sampling_rate</span> <span class='op'>&lt;-</span> <span class='fl'>16000L</span>
<span class='va'>data_generator</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>,
                           <span class='va'>batch_size</span><span class='op'>)</span> <span class='op'>{</span>
  
  <span class='va'>ds</span> <span class='op'>&lt;-</span> <span class='fu'>tensor_slices_dataset</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span> 
  
  <span class='va'>ds</span> <span class='op'>&lt;-</span> <span class='va'>ds</span> <span class='op'>%&gt;%</span>
    <span class='fu'>dataset_map</span><span class='op'>(</span><span class='kw'>function</span><span class='op'>(</span><span class='va'>obs</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>wav</span> <span class='op'>&lt;-</span>
        <span class='fu'>decode_wav</span><span class='op'>(</span><span class='op'>)</span><span class='op'>(</span><span class='va'>tf</span><span class='op'>$</span><span class='fu'>read_file</span><span class='op'>(</span><span class='va'>tf</span><span class='op'>$</span><span class='fu'>reshape</span><span class='op'>(</span><span class='va'>obs</span><span class='op'>$</span><span class='va'>fname</span>, <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
      <span class='va'>samples</span> <span class='op'>&lt;-</span> <span class='va'>wav</span><span class='op'>$</span><span class='va'>audio</span><span class='op'>[</span> ,<span class='fl'>1</span><span class='op'>]</span>
      
      <span class='co'># some wave files have fewer than 16000 samples</span>
      <span class='va'>padding</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fl'>0L</span>, <span class='va'>sampling_rate</span> <span class='op'>-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>shape</span><span class='op'>(</span><span class='va'>samples</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
      <span class='va'>padded</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>pad</span><span class='op'>(</span><span class='va'>samples</span>, <span class='va'>padding</span><span class='op'>)</span>
      
      <span class='va'>stft_out</span> <span class='op'>&lt;-</span> <span class='fu'>stft</span><span class='op'>(</span><span class='op'>)</span><span class='op'>(</span><span class='va'>padded</span>, <span class='fl'>16000L</span>, <span class='fl'>1L</span>, <span class='fl'>512L</span><span class='op'>)</span>
      <span class='va'>magnitude_spectrograms</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>abs</span><span class='op'>(</span><span class='va'>stft_out</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>squeeze</span><span class='op'>(</span><span class='op'>)</span>
    <span class='op'>}</span><span class='op'>)</span>
  
  <span class='va'>ds</span> <span class='op'>%&gt;%</span> <span class='fu'>dataset_batch</span><span class='op'>(</span><span class='va'>batch_size</span><span class='op'>)</span>
  
<span class='op'>}</span>

<span class='va'>ds_train</span> <span class='op'>&lt;-</span> <span class='fu'>data_generator</span><span class='op'>(</span><span class='va'>df_train</span>, <span class='va'>batch_size</span><span class='op'>)</span>
<span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='va'>ds_train</span> <span class='op'>%&gt;%</span> 
  <span class='fu'>make_iterator_one_shot</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>iterator_get_next</span><span class='op'>(</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span> <span class='co'># 100 x 257</span>
</code></pre>
</div>
</div>
<p>Training then proceeded as on the GAS dataset.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre><code><span class='co'># define MAF</span>
<span class='va'>base_dist</span> <span class='op'>&lt;-</span>
  <span class='fu'>tfd_multivariate_normal_diag</span><span class='op'>(</span>loc <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>num_hidden</span> <span class='op'>&lt;-</span> <span class='fl'>512</span> 
<span class='va'>use_batchnorm</span> <span class='op'>&lt;-</span> <span class='cn'>TRUE</span>
<span class='va'>use_permute</span> <span class='op'>&lt;-</span> <span class='cn'>TRUE</span>
<span class='va'>num_mafs</span> <span class='op'>&lt;-</span> <span class='fl'>10</span> 
<span class='va'>num_layers</span> <span class='op'>&lt;-</span> <span class='fl'>3</span> <span class='op'>*</span> <span class='va'>num_mafs</span>

<span class='co'># store bijectors in a list</span>
<span class='va'>bijectors</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span>mode <span class='op'>=</span> <span class='st'>"list"</span>, length <span class='op'>=</span> <span class='va'>num_layers</span><span class='op'>)</span>

<span class='co'># fill list, optionally adding batchnorm and permute bijectors</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>num_layers</span>, by <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>maf</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_masked_autoregressive_flow</span><span class='op'>(</span>
    shift_and_log_scale_fn <span class='op'>=</span> <span class='fu'>tfb_masked_autoregressive_default_template</span><span class='op'>(</span>
      hidden_layers <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>num_hidden</span>, <span class='va'>num_hidden</span><span class='op'>)</span>,
      activation <span class='op'>=</span> <span class='va'>tf</span><span class='op'>$</span><span class='va'>nn</span><span class='op'>$</span><span class='va'>tanh</span>,
      <span class='op'>)</span><span class='op'>)</span>
  <span class='va'>bijectors</span><span class='op'>[[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>maf</span>
  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>use_batchnorm</span><span class='op'>)</span>
    <span class='va'>bijectors</span><span class='op'>[[</span><span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_batch_normalization</span><span class='op'>(</span><span class='op'>)</span>
  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>use_permute</span><span class='op'>)</span>
    <span class='va'>bijectors</span><span class='op'>[[</span><span class='va'>i</span> <span class='op'>+</span> <span class='fl'>2</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='fu'>tfb_permute</span><span class='op'>(</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fl'>0</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='kw'>if</span> <span class='op'>(</span><span class='va'>use_permute</span><span class='op'>)</span> <span class='va'>bijectors</span> <span class='op'>&lt;-</span> <span class='va'>bijectors</span><span class='op'>[</span><span class='op'>-</span><span class='va'>num_layers</span><span class='op'>]</span>
<span class='va'>flow</span> <span class='op'>&lt;-</span> <span class='va'>bijectors</span> <span class='op'>%&gt;%</span>
  <span class='co'># possibly clean out empty elements (if no batchnorm or no permute)</span>
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/keep.html'>discard</a></span><span class='op'>(</span><span class='va'>is.null</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'>tfb_chain</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>target_dist</span> <span class='op'>&lt;-</span> <span class='fu'>tfd_transformed_distribution</span><span class='op'>(</span>distribution <span class='op'>=</span> <span class='va'>base_dist</span>,
                                            bijector <span class='op'>=</span> <span class='va'>flow</span><span class='op'>)</span>

<span class='va'>optimizer</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='va'>train</span><span class='op'>$</span><span class='fu'>AdamOptimizer</span><span class='op'>(</span><span class='fl'>1e-3</span><span class='op'>)</span>

<span class='co'># train MAF</span>
<span class='va'>n_epochs</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>
<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_epochs</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>agg_loglik</span> <span class='op'>&lt;-</span> <span class='fl'>0</span>
  <span class='va'>num_batches</span> <span class='op'>&lt;-</span> <span class='fl'>0</span>
  <span class='va'>iter</span> <span class='op'>&lt;-</span> <span class='fu'>make_iterator_one_shot</span><span class='op'>(</span><span class='va'>ds_train</span><span class='op'>)</span>
  <span class='fu'>until_out_of_range</span><span class='op'>(</span><span class='op'>{</span>
    <span class='va'>batch</span> <span class='op'>&lt;-</span> <span class='fu'>iterator_get_next</span><span class='op'>(</span><span class='va'>iter</span><span class='op'>)</span>
    <span class='va'>loss</span> <span class='op'>&lt;-</span>
      <span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span>
        <span class='op'>-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span><span class='op'>)</span>
    <span class='va'>optimizer</span><span class='op'>$</span><span class='fu'>minimize</span><span class='op'>(</span><span class='va'>loss</span><span class='op'>)</span>
    
    <span class='va'>loglik</span> <span class='op'>&lt;-</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>batch</span><span class='op'>)</span><span class='op'>)</span>
    <span class='va'>agg_loglik</span> <span class='op'>&lt;-</span> <span class='va'>agg_loglik</span> <span class='op'>+</span> <span class='va'>loglik</span>
    <span class='va'>num_batches</span> <span class='op'>&lt;-</span> <span class='va'>num_batches</span> <span class='op'>+</span> <span class='fl'>1</span>
    
    <span class='va'>loglik_test_current</span> <span class='op'>&lt;-</span> 
      <span class='va'>target_dist</span> <span class='op'>%&gt;%</span> <span class='fu'>tfd_log_prob</span><span class='op'>(</span><span class='va'>ds_test</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='va'>tf</span><span class='op'>$</span><span class='fu'>reduce_mean</span><span class='op'>(</span><span class='op'>)</span>

    <span class='kw'>if</span> <span class='op'>(</span><span class='va'>num_batches</span> <span class='op'>%%</span> <span class='fl'>20</span> <span class='op'>==</span> <span class='fl'>1</span><span class='op'>)</span>
      <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span>
        <span class='st'>"Epoch "</span>,
        <span class='va'>i</span>,
        <span class='st'>": "</span>,
        <span class='st'>"Batch "</span>,
        <span class='va'>num_batches</span>,
        <span class='st'>": "</span>,
        <span class='op'>(</span><span class='op'>(</span><span class='va'>agg_loglik</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>num_batches</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,
        <span class='st'>" --- test: "</span>,
        <span class='va'>loglik_test_current</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://rdrr.io/r/base/Round.html'>round</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span>,
        <span class='st'>"\n"</span>
      <span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>During training, we also monitored loglikelihoods on three different classes, <em>cat</em>, <em>bird</em> and <em>wow</em><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. Here are the loglikelihoods from the first 10 epochs. Batch refers to the current training batch (first batch in the epoch), all other values refer to complete datasets (the complete test set and the three sets selected for comparison).</p>
<pre><code>epoch   |   batch  |   test   |   &quot;cat&quot;  |   &quot;bird&quot;  |   &quot;wow&quot;  |
--------|----------|----------|----------|-----------|----------|
1       |   1443.5 |   1455.2 |   1398.8 |    1434.2 |   1546.0 |
2       |   1935.0 |   2027.0 |   1941.2 |    1952.3 |   2008.1 | 
3       |   2004.9 |   2073.1 |   2003.5 |    2000.2 |   2072.1 |
4       |   2063.5 |   2131.7 |   2056.0 |    2061.0 |   2116.4 |        
5       |   2120.5 |   2172.6 |   2096.2 |    2085.6 |   2150.1 |
6       |   2151.3 |   2206.4 |   2127.5 |    2110.2 |   2180.6 | 
7       |   2174.4 |   2224.8 |   2142.9 |    2163.2 |   2195.8 |
8       |   2203.2 |   2250.8 |   2172.0 |    2061.0 |   2221.8 |        
9       |   2224.6 |   2270.2 |   2186.6 |    2193.7 |   2241.8 |
10      |   2236.4 |   2274.3 |   2191.4 |    2199.7 |   2243.8 |        </code></pre>
<p>While this does not look too bad, a complete comparison against all twenty-nine non-target classes had zero outperformed by seven other classes, with the remaining twenty-two lower in loglikelihood. We dont have a model for anomaly detection, as yet.</p>
<h2 id="outlook">Outlook</h2>
<p>As already alluded to several times, for data with temporal and/or spatial orderings more evolved architectures may prove useful. The very successful <em>PixelCNN</em> family is based on masked convolutions, with more recent developments bringing further refinements (e.g.<em>Gated PixelCNN</em> <span class="citation" data-cites="OordKVEGK16">(Oord et al. <a href="#ref-OordKVEGK16" role="doc-biblioref">2016</a>)</span>, <em>PixelCNN++</em> <span class="citation" data-cites="SalimansKCK17">(Salimans et al. <a href="#ref-SalimansKCK17" role="doc-biblioref">2017</a>)</span>. <strong>Attention</strong>, too, may be masked and thus rendered autoregressive, as employed in the hybrid <em>PixelSNAIL</em> <span class="citation" data-cites="abs-1712-09763">(Chen et al. <a href="#ref-abs-1712-09763" role="doc-biblioref">2017</a>)</span> and the - not surprisingly given its name - transformer-based <em>ImageTransformer</em> <span class="citation" data-cites="abs-1802-05751">(Parmar et al. <a href="#ref-abs-1802-05751" role="doc-biblioref">2018</a>)</span>.</p>
<p>To conclude, - while this post was interested in the intersection of flows and autoregressivity - and last not least the use therein of TFP bijectors - an upcoming one might dive deeper into autoregressive models specifically and who knows, perhaps come back to the audio data for a fourth time.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references hanging-indent" role="doc-bibliography">
<div id="ref-abs-1712-09763">
<p>Chen, Xi, Nikhil Mishra, Mostafa Rohaninejad, and Pieter Abbeel. 2017. PixelSNAIL: An Improved Autoregressive Generative Model. <em>CoRR</em> abs/1712.09763. <a href="http://arxiv.org/abs/1712.09763">http://arxiv.org/abs/1712.09763</a>.</p>
</div>
<div id="ref-DinhSB16">
<p>Dinh, Laurent, Jascha Sohl-Dickstein, and Samy Bengio. 2016. Density Estimation Using Real Nvp. <em>CoRR</em> abs/1605.08803. <a href="http://arxiv.org/abs/1605.08803">http://arxiv.org/abs/1605.08803</a>.</p>
</div>
<div id="ref-GermainGML15">
<p>Germain, Mathieu, Karol Gregor, Iain Murray, and Hugo Larochelle. 2015. MADE: Masked Autoencoder for Distribution Estimation. <em>CoRR</em> abs/1502.03509. <a href="http://arxiv.org/abs/1502.03509">http://arxiv.org/abs/1502.03509</a>.</p>
</div>
<div id="ref-OordKVEGK16">
<p>Oord, Aaron van den, Nal Kalchbrenner, Oriol Vinyals, Lasse Espeholt, Alex Graves, and Koray Kavukcuoglu. 2016. Conditional Image Generation with Pixelcnn Decoders. <em>CoRR</em> abs/1606.05328. <a href="http://arxiv.org/abs/1606.05328">http://arxiv.org/abs/1606.05328</a>.</p>
</div>
<div id="ref-2017arXiv170507057P">
<p>Papamakarios, George, Theo Pavlakou, and Iain Murray. 2017. Masked Autoregressive Flow for Density Estimation. <em>arXiv E-Prints</em>, May, arXiv:1705.07057. <a href="http://arxiv.org/abs/1705.07057">http://arxiv.org/abs/1705.07057</a>.</p>
</div>
<div id="ref-abs-1802-05751">
<p>Parmar, Niki, Ashish Vaswani, Jakob Uszkoreit, Lukasz Kaiser, Noam Shazeer, and Alexander Ku. 2018. Image Transformer. <em>CoRR</em> abs/1802.05751. <a href="http://arxiv.org/abs/1802.05751">http://arxiv.org/abs/1802.05751</a>.</p>
</div>
<div id="ref-SalimansKCK17">
<p>Salimans, Tim, Andrej Karpathy, Xi Chen, and Diederik P. Kingma. 2017. PixelCNN++: Improving the Pixelcnn with Discretized Logistic Mixture Likelihood and Other Modifications. <em>CoRR</em> abs/1701.05517. <a href="http://arxiv.org/abs/1701.05517">http://arxiv.org/abs/1701.05517</a>.</p>
</div>
</div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><code>tfb_masked_autoregressive_flow</code>, in R<a href="#fnref1" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn2" role="doc-endnote"><p>For a comparison of <em>Masked Autoregressive Flow</em> to its siblings <em>Real NVP</em> (also available as a TFP bijector) and <em>Inverse Autogressive Flow</em> (to be obtained as an inverse of MAF in TFP), see Eric Jangs excellent <a href="https://blog.evjang.com/2018/01/nf2.html">tutorial</a>.<a href="#fnref2" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn3" role="doc-endnote"><p>not specified individually in the paper<a href="#fnref3" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn4" role="doc-endnote"><p>We quickly experimented with a higher number of FFT coefficients, but the approach did not seem that promising.<a href="#fnref4" class="footnote-back" role="doc-backlink"></a></p></li>
<li id="fn5" role="doc-endnote"><p>to avoid clutter we dont show the respective code<a href="#fnref5" class="footnote-back" role="doc-backlink"></a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<div class="article-footer">
  <p class="social_footer">
    <span class="disqus-comments">
      <i class="fas fa-comments"></i>
      &nbsp;
      <span class="disqus-comment-count" data-disqus-identifier="posts/2019-04-24-autoregressive-flows/">Comment on this article</span>
    </span>
    <span class="article-sharing">
      Share: &nbsp;
      <a href="https://twitter.com/share?text=Experimenting%20with%20autoregressive%20flows%20in%20TensorFlow%20Probability&amp;url=https%3A%2F%2Fblogs.rstudio.com%2Ftensorflow%2Fposts%2F2019-04-24-autoregressive-flows%2F">
        <i class="fab fa-twitter"></i>
      </a>
      <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblogs.rstudio.com%2Ftensorflow%2Fposts%2F2019-04-24-autoregressive-flows%2F&amp;title=Experimenting%20with%20autoregressive%20flows%20in%20TensorFlow%20Probability">
        <i class="fab fa-linkedin"></i>
      </a>
    </span>
  </p>
  <script id="dsq-count-scr" src="https://tensorflow-for-r-blog.disqus.com/count.js" async></script>
  <div id="disqus_thread" class="hidden"></div>
  <script>
var disqus_config = function () {
  this.page.url = 'https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/';
  this.page.identifier = 'posts/2019-04-24-autoregressive-flows/';
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://tensorflow-for-r-blog.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script>
  <p>
    <div class="subscribe">
<div id="subscribe-caption" style="line-height: 1.2; margin-bottom: 2px;">Enjoy this blog? Get notified of new posts by email:</div>

<script src="https://app-ab02.marketo.com/js/forms2/js/forms2.min.js"></script>
<form class="mtktoBlogEmailForm" id="mktoForm_2224"></form>
<script>

// establish metrics based on where the form is located
var in_sidebar = $('#subscribe-caption').parents('.sidebar-section').length;
if (in_sidebar) {
  var form_width = 190;
  var base_width = form_width - 23;
  var email_width = base_width + 'px';
  var label_width = (base_width - 20) + 'px';
  var button_width = email_width;
  var button_padding = '30px';
  var button_margin = '';
  var font_size = '12px';
} else {
  var form_width = 400;
  var base_width = form_width - 23;
  var email_width = base_width + 'px';
  var label_width = (base_width - 20) + 'px';
  var button_width = email_width;
  var button_padding = '30px';
  var button_margin = '12px';
  var font_size = '15px';
}

$('#subscribe-caption')
  .css('width', base_width)
  .css('font-size', font_size);


MktoForms2.loadForm("https://app-ab02.marketo.com", "709-NXN-706", 2224, function(form) {

  // get jquery reference to form
  form = $(form.getFormElem().get(0));

  $(form).css('width', form_width + 'px');
  $(form).find('.mktoOffset').remove();
  $(form).find('.mktoGutter').remove();
  $(form).find('.mktoEmailField').css('width', email_width);
  $(form).find('.mktoLabel').children().attr('style', 'font-weight: 400');
  $(form).find('.mktoLabel')
      .css('width', label_width)
      .css('font-size', font_size);
  $(form).find('.mktoButtonRow')
      .css('width', button_width)
      .css('text-align', 'center');
  $(form).find('.mktoButtonWrap').attr('style', '');
  $(form).find('.mktoButton')
      .css('margin-top', '10px')
      .css('padding-left', button_padding)
      .css('padding-right', button_padding)
      .css('font-size', font_size)
      .css('margin-top', button_margin);
});
</script>
Posts also available at <a href="https://www.r-bloggers.com">r-bloggers</a>

<script>
  document.addEventListener("DOMContentLoaded", function(){
    var menulink = document.querySelector("a[href='#category:R']");
    if (menulink) menulink.parentNode.style.display = "None";
    
    for (var e of document.querySelectorAll(".dt-tag")) {
      if (e.innerHTML == 'R') e.style.display = "None";
    }
  });
</script>
</div>
  </p>
</div>
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
  <h3 id="references">References</h3>
  <div id="references-listing"></div>
  <h3 id="reuse">Reuse</h3>
  <p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
  <h3 id="citation">Citation</h3>
  <p>For attribution, please cite this work as</p>
  <pre class="citation-appendix short">Keydana (2019, April 24). RStudio AI Blog: Experimenting with autoregressive flows in TensorFlow Probability. Retrieved from https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/</pre>
  <p>BibTeX citation</p>
  <pre class="citation-appendix long">@misc{keydana2019autoregressive,
  author = {Keydana, Sigrid},
  title = {RStudio AI Blog: Experimenting with autoregressive flows in TensorFlow Probability},
  url = {https://blogs.rstudio.com/tensorflow/posts/2019-04-24-autoregressive-flows/},
  year = {2019}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
